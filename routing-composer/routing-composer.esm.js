var oe=Object.defineProperty;var re=(p,a,i)=>a in p?oe(p,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):p[a]=i;var P=(p,a,i)=>re(p,typeof a!="symbol"?a+"":a,i);import"react";import Z from"react-dom";import{useEffect as J,useState as ne}from"react";import de from"react-dom";import{useEffect as U,useState as X,useRef as le}from"react";import"react";import{Fragment as B,jsx as u,jsxs as C}from"react/jsx-runtime";var ce="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",ee="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function G({label:p,min:a,max:i,step:t=.01,value:n,onChange:l,suffix:d}){let e=typeof n=="number"?(Math.round(n*100)/100).toFixed(2):String(n??""),h=Number(n??0),r=Number(a??0),y=Number(i??1),b=Math.max(0,Math.min(1,(h-r)/(y-r)))*100;return C("div",{className:"flex items-center gap-3",children:[u("div",{className:"w-24 text-sm opacity-80",children:p}),u("input",{type:"range",className:"w-48 rc-slider",min:a,max:i,step:t,value:Number(n??0),onChange:v=>l(Number(v.target.value)),style:{"--rc-pos":`${b}%`}}),C("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[e,d?u("span",{className:"opacity-60",children:d}):null]})]})}function Q({mod:p,onToggle:a,onRemove:i,onParam:t}){let{kind:n,enabled:l,params:d={}}=p;return C("div",{className:`${ce} w-[280px]`,children:[C("div",{className:"flex items-center justify-between",children:[u("div",{className:"font-semibold capitalize",children:n}),C("div",{className:"flex gap-2",children:[u("button",{className:ee,onClick:a,children:l?"Bypass":"Enable"}),u("button",{className:ee,onClick:i,title:"Remove module",children:"\xD7"})]})]}),u("div",{className:"mt-2 text-xs opacity-70",children:l?"active":"bypassed"}),C("div",{className:"mt-3 space-y-2",children:[n==="ks_source"&&C(B,{children:[C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),C("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,h)=>u("option",{value:String(h),children:h},h))]})]}),C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"Program"}),u("input",{type:"number",min:0,max:127,className:"bg-transparent border border-white/10 rounded-lg px-2 py-1 w-24",value:Number(d.program??0),onChange:e=>t("program",Number(e.target.value))})]}),C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.smoothingMode??"auto"),onChange:e=>t("smoothingMode",e.target.value),children:["auto","manual"].map(e=>u("option",{value:e,children:e},e))})]}),String(d.smoothingMode??"auto")==="manual"&&u(G,{label:"smooth",min:0,max:1,value:Number(d.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),u(G,{label:"velScale",min:0,max:1,value:Number(d.velScale??1),onChange:e=>t("velScale",e)}),C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"seed"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.seedNoiseType??"pink"),onChange:e=>t("seedNoiseType",e.target.value),children:["pink","white","synthPink"].map(e=>u("option",{value:e,children:e},e))})]}),String(d.smoothingMode??"auto")==="auto"&&u("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / stringDampingVariation \u8207 note \u8A08\u7B97"})]}),n==="source"&&C(B,{children:[C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),C("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(p.params.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,h)=>u("option",{value:String(h),children:h},h))]})]}),C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"wave"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(p.params.type),onChange:e=>t("type",e.target.value),children:["sine","square","sawtooth","triangle"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"attack",min:0,max:.2,value:Number(p.params.adsr?.a??.003),onChange:e=>t("adsr",{...p.params.adsr||{},a:e})}),u(G,{label:"decay",min:0,max:1,value:Number(p.params.adsr?.d??.08),onChange:e=>t("adsr",{...p.params.adsr||{},d:e})}),u(G,{label:"sustain",min:0,max:1,value:Number(p.params.adsr?.s??.4),onChange:e=>t("adsr",{...p.params.adsr||{},s:e})}),u(G,{label:"release",min:0,max:2,value:Number(p.params.adsr?.r??.2),onChange:e=>t("adsr",{...p.params.adsr||{},r:e})})]}),n==="filter"&&C(B,{children:[C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"mode"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.mode??"lowpass"),onChange:e=>t("mode",e.target.value),children:["lowpass","highpass","bandpass","notch"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"freq",min:50,max:12e3,value:Number(d.freq??1200),onChange:e=>t("freq",e)}),u(G,{label:"Q",min:.1,max:20,value:Number(d.q??.7),onChange:e=>t("q",e)})]}),n==="delay"&&C(B,{children:[u(G,{label:"time",min:.01,max:1.2,value:Number(d.time??.25),onChange:e=>t("time",e)}),u(G,{label:"feedback",min:0,max:.95,value:Number(d.feedback??.35),onChange:e=>t("feedback",e)}),u(G,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),n==="reverb"&&C(B,{children:[u(G,{label:"decay",min:.2,max:6,value:Number(d.decay??2),onChange:e=>t("decay",e)}),u(G,{label:"mix",min:0,max:1,value:Number(d.mix??.25),onChange:e=>t("mix",e)})]}),n==="convolver_ir"&&C(B,{children:[C("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"IR"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.irId??"IR_Gibson"),onChange:e=>t("irId",e.target.value),children:["IR_Gibson","IR_piezo"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),n==="gain"&&u(G,{label:"gain",min:0,max:1.5,value:Number(d.gain??.8),onChange:e=>t("gain",e)}),n==="analyzer"&&u("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var K=class{constructor(a){P(this,"handleMIDIMsg",a=>{let i=a[0],t=a[1],n=a[2],l=i&240,d=i&15;l===144&&n>0?this.gate(!0,n/127,d,t):(l===128||l===144&&n===0)&&this.gate(!1,0,d,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let i=this.actx.createGain();return i.gain.value=1,i}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let i=0;i<16;i++)try{this.mixers[i].connect(this.midiSynth.chvol[i]),console.log(`[RC] mixer[ch${i}] -> chvol[ch${i}]`)}catch(t){console.warn(`[RC] mixer[ch${i}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}updateGainNodeById(a,i){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let n=this.actx.currentTime;try{t.gain.cancelScheduledValues(n),t.gain.setTargetAtTime(Number(i)||0,n,.01)}catch{t.gain.value=Number(i)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let i=this.actx.createConstantSource();return i.offset.value=0,i.start(),this._bendCS[a]=i,i}updateBend(a,i){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),n=Number.isFinite(i)?i:0;try{let l=this.actx.currentTime;t.offset.cancelScheduledValues(l),t.offset.setTargetAtTime(n,l,.01)}catch{t.offset.value=n}}setMidiSynth(a){this.midiSynth=a;let i=a&&(a.actx||a.audioContext);if(i&&i!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=i,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(n){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,n)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a){this.liveNodes.clear();let i=l=>{let d=l.kind,e=l.params||{},h=this.actx;if(!l.enabled){let r=h.createGain();return{in:r,out:r}}switch(d){case"ks_source":{let r=h.createGain();return this.liveNodes.set(l.id+":ksOut",r),this.liveNodes.set(l.id+":ksParams",e),this.liveNodes.set("__lastKsId__",l.id),this.liveNodes.set("keyboardTarget",r),{in:r,out:r}}case"source":{let r=h.createOscillator();r.type=e.type||"sawtooth";let y=h.createGain();return y.gain.value=0,r.connect(y),r.start(),this.liveNodes.set(l.id+":osc",r),this.liveNodes.set(l.id+":env",y),this.liveNodes.set(l.id+":oscType",r.type),this.liveNodes.set(l.id+":ch",e.ch??"all"),this.liveNodes.set(l.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",r.type),this.liveNodes.set("keyboardTarget",y),{in:y,out:y}}case"gain":{let r=this.actx.createGain();return r.gain.value=Number(e.gain??1),this.liveNodes.set(l.id+":node",r),{in:r,out:r}}case"filter":{let r=h.createBiquadFilter();return r.type=e.mode||"lowpass",r.frequency.value=Number(e.freq||1200),r.Q.value=Number(e.q||.7),this.liveNodes.set(l.id+":node",r),{in:r,out:r}}case"delay":{let r=h.createDelay(2);r.delayTime.value=Number(e.time||.25);let y=h.createGain();y.gain.value=Number(e.feedback||.3);let b=h.createGain();b.gain.value=Number(e.mix||.3);let v=h.createGain(),N=h.createGain(),w=h.createGain();return w.gain.value=1-b.gain.value,v.connect(r),v.connect(w),r.connect(y).connect(r),r.connect(b),w.connect(N),b.connect(N),this.liveNodes.set(l.id+":node",{input:v,output:N,delay:r,fb:y,mix:b}),{in:v,out:N}}case"analyzer":{let r=h.createGain();return r.connect(this.analyser),this.liveNodes.set(l.id+":node",r),{in:r,out:r}}default:{let r=h.createGain();return{in:r,out:r}}}},t=null,n=null;for(let l of a){let{in:d,out:e}=i(l);t||(t=d),n&&n.connect(d),n=e}t&&this.liveNodes.set("__chainHead__",t),n&&this.liveNodes.set("__chainTail__",n);try{let d=a.find(h=>h.kind==="ks_source"||h.kind==="source")?.params?.ch??"all",e=d==="all"?Array.from({length:16},(h,r)=>r):[Number(d)];for(let h of e){let r=this.mixers[h];n&&r&&n.connect(r)}}catch(l){console.warn("[RC] mixer connect failed",l)}n&&m.kind==="gain"&&n.connect(this.mixers[ch])}buildMany(a){this.liveNodes.clear();let i=this.liveNodes,t=n=>{let l=new Map;this.liveNodes=l,this.build(n);for(let[d,e]of this.liveNodes.entries())i.set(d,e);this.liveNodes=i};a.forEach(t)}gate(a,i=.8,t=0,n=69){let l=this.actx.currentTime,d=!1;if(a&&(d=this.pluckKS(t,n??69,i)),a&&!d){let h=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),r=this.actx.currentTime,y=[];for(let[A,D]of this.liveNodes.entries())if(A.endsWith(":oscType")){let T=A.split(":")[0],M=this.liveNodes.get(T+":ch")??"all",f=this.liveNodes.get(T+":adsr")||{a:.003,d:.08,s:.4,r:.2},S=D||"sawtooth";(M==="all"||Number(M)===t)&&y.push({modId:T,type:S,adsr:f})}if(!y.length){let A=this.liveNodes.get("__oscType__")||"sawtooth";y.push({modId:null,type:A,adsr:{a:.003,d:.08,s:.4,r:.2}})}let b=this.liveNodes.get("__chainTail__"),v=this.liveNodes.get("__chainHead__"),N=this.liveNodes.get("keyboardTarget"),w=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let q=this.liveNodes.get("__oscVoices__");q[t]||(q[t]={});for(let A of y){let D=this.actx.createOscillator();try{D.type=A.type}catch{D.type="sawtooth"}D.frequency.setValueAtTime(h,r);try{let c=this.midiSynth?.chmod?.[t];c&&D.detune&&c.connect(D.detune);let g=this.getBendNode(t);D.detune&&g&&g.connect(D.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(c){console.warn("[RC] osc detune connect failed",c)}let T=this.actx.createGain();T.gain.setValueAtTime(0,r);let{a:M,d:f,s:S,r:R}=A.adsr;T.gain.linearRampToValueAtTime(i,r+(M??.003)),T.gain.linearRampToValueAtTime((S??.4)*i,r+(M??.003)+(f??.08)),D.connect(T);let s=null;if(v&&v!==N?s=v:b?s=b:w&&(s=w),!s&&w&&(s=w),s){T.connect(s);try{let c=`__tail_to_chvol_${t}__`;try{let g=this.mixers?.[t];if(b&&g)if(b.context===this.actx&&g.context===this.actx)b.connect(g);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let x=this.mixers?.[t];b.context===this.actx&&x?.context===this.actx&&b.connect(x)}catch{}}}catch(g){console.warn("[RC] mixer connect failed",g)}}catch{}}D.start(r);let o=`${n}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;q[t][o]={note:n,osc:D,env:T,r:R??.2}}}if(!a){let e=this.actx.currentTime,h=this.liveNodes.get("__oscVoices__");if(!h||!h[t])return;let r=Object.entries(h[t]).filter(([y,b])=>b.note===n);for(let[y,b]of r){let{osc:v,env:N,r:w=.2}=b;try{N.gain.cancelScheduledValues(e),N.gain.setValueAtTime(N.gain.value??0,e),N.gain.linearRampToValueAtTime(0,e+w),v.stop(e+w+.05),setTimeout(()=>{try{v.disconnect(),N.disconnect()}catch{}delete h[t][y]},(w+.1)*1e3)}catch{delete h[t][y]}}}}pluckKS(a,i,t){let n=Array.from(this.liveNodes.entries()).filter(([f])=>f.endsWith(":ksOut"));if(!n.length)return!1;let l=null,d={},e=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[f,S]of n){let R=this.liveNodes.get(f.replace(":ksOut",":ksParams"))||{},s=R.ch!=null?R.ch:"all",o=Number(R.program!=null?R.program:0);if((s==="all"||Number(s)===a)&&o===e){l=[f,S],d=R;break}}if(!l)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:e}),!1;let h=l[0],r=l[1],y=d,v=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(i-69)/12),N=this.actx.sampleRate,w;try{if(y.seedNoiseType==="synthPink"&&this.midiSynth&&typeof this.midiSynth.generateSeedPinkNoise=="function"){let f=Math.max(1,Math.round(N/Math.max(1e-6,v)));w=this.midiSynth.generateSeedPinkNoise(65535,f)}else{let f=Math.max(2048,Math.round(N/Math.max(1e-6,v)));w=((R=4096)=>{let s=new Float32Array(R),o=0,c=0,g=0,x=0,_=0,j=0,F=0;for(let W=0;W<R;W++){let V=Math.random()*2-1;o=.99886*o+V*.0555179,c=.99332*c+V*.0750759,g=.969*g+V*.153852,x=.8665*x+V*.3104856,_=.55*_+V*.5329522,j=-.7616*j-V*.016898,s[W]=(o+c+g+x+_+j+F*.5362)*.11,F=V*.115926}return s})(f)}}catch{}console.log("[RC] seed check",w?.length,w?.[0]);let q=this.actx.createBuffer(2,N,N),A=.2;try{let f=this.midiSynth?.inv127??.007874015748031496,S=Math.pow(i/64,.5)||0,R=i*f*.85+.15,s=Number(this.midiSynth?.options?.[a]?.stringDampingVariation??0);A=R+S*(1-R)*.5+(1-R)*Math.random()*s}catch{}let D=Number(y.velScale==null?1:y.velScale),T=this.midiSynth?.options?.[a]??{};if(Object.keys(T).length===0&&(T.stringDamping=.5,T.stringDampingVariation=.2),Number.isFinite(A)||(A=.2),!w||!w.length){console.warn("[RC] seed invalid, injecting pink noise");let f=Math.max(2048,Math.round(N/Math.max(1e-6,v)));w=new Float32Array(f);for(let S=0;S<f;S++)w[S]=Math.random()*2-1}try{let f=this.midiSynth?.asmWrapper?.[a],S=this.midiSynth?.options?.[a]??{};f&&typeof f.pluck=="function"&&f.pluck(q,w,N,v,A,t*D,S,.2)}catch(f){console.warn("[RC] pluck error",f)}let M=this.actx.createBufferSource();M.buffer=q;try{let f=this.midiSynth?.chmod?.[a];f&&M.detune&&f.connect(M.detune)}catch{}try{let f=this.midiSynth?.bend?.[a];typeof f=="number"&&M.detune&&(M.detune.value=f)}catch{}M.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[i]===M&&(this.midiSynth.bfSet[a][i]=null)}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][i]=M}catch{}try{let f=h.replace(":ksOut",":tail"),S=this.liveNodes.get(f)||this.liveNodes.get("__chainTail__"),R=this.midiSynth?.chvol?.[a],s=`__tail_to_chvol_${a}__`;try{let o=this.mixers?.[a];if(S&&o)if(S.context===this.actx&&o.context===this.actx)S.connect(o);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let c=this.mixers?.[a];S.context===this.actx&&c?.context===this.actx&&S.connect(c)}catch{}}}catch(o){console.warn("[RC] mixer connect failed",o)}}catch{}return M.connect(r),M.start(),!0}};import{Fragment as ie,jsx as k,jsxs as O}from"react/jsx-runtime";var E="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var te=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],L={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:0},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function $(p="m"){return`${p}_${Math.random().toString(36).slice(2,9)}`}function ae(p,a,i){let t=p.slice(),n=Math.max(0,Math.min(t.length-1,a)),l=t.splice(n,1)[0],d=Math.max(0,Math.min(t.length,i));return t.splice(d,0,l),t}function Y({synth:p}){let a=le(null);a.current||(a.current=new K);let i=a.current;U(()=>{if(p&&typeof i.setMidiSynth=="function")try{i.setMidiSynth(p),console.log("[RC] midi_synth attached to engine")}catch(s){console.warn("[RC] setMidiSynth failed",s)}},[p]),U(()=>(window.__RC_HANDLE__={midi:s=>{try{i.handleMIDIMsg&&i.handleMIDIMsg(s),console.log("[RC] MIDI -> engine",s)}catch(o){console.warn("[RC] MIDI ingress failed",o)}},engine:i},()=>{try{delete window.__RC_HANDLE__}catch{}}),[i]);let[t,n]=X([[{id:$("src"),kind:"source",enabled:!0,params:{...L.source}},{id:$("gain"),kind:"gain",enabled:!0,params:{...L.gain}},{id:$("an"),kind:"analyzer",enabled:!0,params:{}}]]),[l,d]=X({open:!1,idx:null,step:1}),e=s=>d({open:!0,idx:s,step:1}),h=()=>d({open:!1,idx:null,step:1}),r=()=>d(s=>({...s,step:2})),y=()=>{n(s=>{let o=s.filter((c,g)=>g!==l.idx);return o.length?o:[[{id:$("src"),kind:"source",enabled:!0,params:{...L.source}},{id:$("gain"),kind:"gain",enabled:!0,params:{...L.gain}},{id:$("an"),kind:"analyzer",enabled:!0,params:{}}]]}),h()};U(()=>{try{i.buildMany(t),i.resume&&i.resume()}catch(s){console.warn("[RC] buildMany failed",s)}},[JSON.stringify(t)]),U(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(s=>{for(let o of s.inputs.values())o.onmidimessage=c=>i.handleMIDIMsg(c.data)})},[]);let b=(s,o)=>n(c=>{let g=c.map(x=>[...x]);return g[s]=[...g[s],{id:$(o),kind:o,enabled:!0,params:{...L[o]}}],g}),v=(s,o)=>n(c=>c.map((g,x)=>x!==s?g:g.map(_=>_.id===o?{..._,enabled:!_.enabled}:_))),N=(s,o)=>n(c=>c.map((g,x)=>x!==s?g:g.filter(_=>_.id!==o))),w=(s,o,c,g)=>{c==="gain"&&(i.updateGainNodeById(o,g)||console.warn("[RC] gain node not found for id:",o)),n(x=>x.map((_,j)=>j!==s?_:_.map(F=>F.id===o?{...F,params:{...F.params,[c]:g}}:F)))},[q,A]=X(null),D=(s,o)=>c=>{A({chain:s,from:o}),c.dataTransfer.effectAllowed="move",c.dataTransfer.setData("text/plain",`${s}:${o}`)},T=(s,o)=>c=>{c.preventDefault(),!(!q||q.chain!==s)&&(n(g=>g.map((x,_)=>_!==s?x:ae(x,q.from,o))),A(null))},M=s=>o=>{o.preventDefault(),!(!q||q.chain!==s)&&(n(c=>c.map((g,x)=>x!==s?g:ae(g,q.from,g.length))),A(null))},f=s=>n(o=>{let c=o.map(x=>[...x]),g=c[s].map(x=>({...x,id:$(x.kind)}));return c.splice(s+1,0,g),c}),S=()=>{let s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(s),c=document.createElement("a");c.href=o,c.download="audio-chains.json",c.click(),URL.revokeObjectURL(o)},R=async s=>{let o=await s.text();try{let c=JSON.parse(o);Array.isArray(c)&&Array.isArray(c[0])&&n(c)}catch(c){console.warn("Invalid chain JSON",c)}};return O("div",{className:"p-6 text-white",children:[k("div",{className:"flex items-center justify-between mb-4",children:O("div",{className:"flex items-center gap-2 flex-wrap",children:[te.map(s=>O("button",{className:E,onClick:()=>b(0,s),children:["+ ",s]},`add-${s}`)),k("button",{className:E,onClick:()=>i.resume(),children:"Resume Audio"}),k("button",{className:E,onClick:S,children:"Export"}),O("label",{className:`${E} cursor-pointer`,children:["Import",k("input",{type:"file",accept:"application/json",className:"hidden",onChange:s=>{let o=s.target.files?.[0];o&&R(o)}})]}),k("button",{className:E,onClick:()=>{typeof i.buildMultiFrom=="function"?i.buildMultiFrom(t[0],Array.from({length:16},(s,o)=>o)):n(s=>{let o=s[0]||[];return Array.from({length:16},(g,x)=>o.map(_=>({..._,id:$(_.kind)+`_ch${x}`,params:_.kind==="ks_source"?{..._.params,ch:String(x)}:{..._.params}})))})},children:"Duplicate to 16 channels"})]})}),k("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:t.map((s,o)=>O("div",{className:"mb-6",children:[O("div",{className:"flex items-center justify-between mb-2",children:[O("div",{className:"text-sm opacity-80",children:["Chain #",o+1]}),O("div",{className:"flex gap-2",children:[k("button",{className:E,onClick:()=>f(o),children:"Duplicate chain"}),k("button",{className:E,onClick:()=>e(o),children:"Delete chain"})]})]}),O("div",{className:"flex gap-3 items-stretch",children:[s.map((c,g)=>k("div",{draggable:!0,onDragStart:D(o,g),onDrop:T(o,g),onDragOver:x=>x.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:k(Q,{mod:c,onToggle:()=>v(o,c.id),onRemove:()=>N(o,c.id),onParam:(x,_)=>w(o,c.id,x,_)})},c.id)),k("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:c=>c.preventDefault(),onDrop:M(o),children:"\u2192"})]}),k("div",{className:"mt-3 flex flex-wrap gap-2",children:te.map(c=>O("button",{className:E,onClick:()=>b(o,c),children:["+ ",c]},`${o}-${c}`))})]},o))}),l.open&&k("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:k("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:l.step===1?O(ie,{children:[k("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),k("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),O("div",{className:"flex justify-end gap-2",children:[k("button",{className:E,onClick:h,children:"Cancel"}),k("button",{className:E,onClick:r,children:"Next"})]})]}):O(ie,{children:[k("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),k("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),O("div",{className:"flex justify-end gap-2",children:[k("button",{className:E,onClick:h,children:"Cancel"}),k("button",{className:E,onClick:y,children:"Delete"})]})]})})})]})}import{jsx as I,jsxs as z}from"react/jsx-runtime";function H({synth:p,buttonTarget:a,autoTailwind:i=!1}){let[t,n]=ne(!1);J(()=>{if(!t)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(v){console.warn("[RC] resumeAll failed",v)}})()},[t]);let[l,d]=ne(()=>p?.a4_freq??440);J(()=>{typeof p?.a4_freq=="number"&&d(Number(p.a4_freq))},[p]),J(()=>{let b=l,v=setInterval(()=>{let N=Number(p?.a4_freq??440);!Number.isNaN(N)&&N!==b&&(b=N,d(N))},250);return()=>clearInterval(v)},[p,l]);let e=420,r=Math.max(0,Math.min(1,(l-e)/(460-e)))*100;J(()=>{if(!i||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let v=document.createElement("script");v.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",v.dataset.rcTailwind="1",document.head.appendChild(v)},[i]);let y=()=>I("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>n(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return z("div",{children:[I("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),a?de.createPortal(I(y,{}),a):I("div",{className:"rc-fixed-default",children:I(y,{})}),I("div",{className:"rc-overlay",style:{display:t?"flex":"none"},onClick:b=>{b.target===b.currentTarget&&n(!1)},children:z("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[z("div",{className:"rc-header",children:[z("div",{className:"flex items-center gap-4",children:[I("div",{children:"Routing Composer"}),z("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[I("span",{children:"A4"}),I("input",{type:"range",min:"420",max:"460",step:"0.1",value:l,className:"rc-slider",style:{"--rc-pos":`${(l-420)/40*100}%`,width:160},onChange:b=>{let v=Number(b.target.value);Number.isNaN(v)||(d(v),p&&(p.a4_freq=v))}}),z("span",{children:[l.toFixed(1),"Hz"]})]})]}),z("div",{className:"flex items-center gap-2",children:[I("button",{className:"rc-close",onClick:()=>p?.actx?.resume?.(),children:"Resume Audio"}),I("button",{className:"rc-close",onClick:()=>n(!1),children:"Close"})]})]}),I("div",{className:"rc-body",children:I(Y,{synth:p})})]})})]})}import{jsx as se}from"react/jsx-runtime";var Oe=H;(function(){if(typeof window>"u")return;let a={mount(i={}){let{synth:t,button:n,tailwind:l="auto"}=i,d=null;n&&(typeof n=="string"?d=document.querySelector(n):n instanceof HTMLElement&&(d=n));let e=document.createElement("div");return document.body.appendChild(e),Z.createRoot?Z.createRoot(e).render(se(H,{synth:t,buttonTarget:d,autoTailwind:l==="auto"})):Z.render(se(H,{synth:t,buttonTarget:d,autoTailwind:l==="auto"}),e),console.log("[RoutingComposer] mounted GUI"),{host:e}}};window.RoutingComposer=a})();export{Oe as default};
