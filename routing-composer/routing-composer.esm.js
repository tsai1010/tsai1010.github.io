var De=Object.defineProperty;var Ve=(u,a,r)=>a in u?De(u,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[a]=r;var Ne=(u,a,r)=>Ve(u,typeof a!="symbol"?a+"":a,r);import"react";import xe from"react-dom";import{useEffect as pe,useState as ye}from"react";import qe from"react-dom";import{useEffect as X,useState as oe,useRef as Se}from"react";import"react";import{Fragment as se,jsx as f,jsxs as O}from"react/jsx-runtime";var Fe="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",ke="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function z({label:u,min:a,max:r,step:t=.01,value:o,onChange:h,suffix:d}){let l=typeof o=="number"?(Math.round(o*100)/100).toFixed(2):String(o??""),e=Number(o??0),v=Number(a??0),c=Number(r??1),w=Math.max(0,Math.min(1,(e-v)/(c-v)))*100;return O("div",{className:"flex items-center gap-3",children:[f("div",{className:"w-24 text-sm opacity-80",children:u}),f("input",{type:"range",className:"w-48 rc-slider",min:a,max:r,step:t,value:Number(o??0),onChange:A=>h(Number(A.target.value)),onMouseUp:A=>A.currentTarget.blur(),onTouchEnd:A=>A.currentTarget.blur(),style:{"--rc-pos":`${w}%`}}),O("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[l,d?f("span",{className:"opacity-60",children:d}):null]})]})}function be({mod:u,onToggle:a,onRemove:r,onParam:t,onDragStart:o}){let{kind:h,enabled:d,params:l={}}=u;return O("div",{className:`${Fe} w-[280px]`,children:[O("div",{className:"flex items-center justify-between",children:[O("div",{className:"flex items-center gap-2",children:[f("div",{className:"cursor-grab active:cursor-grabbing text-xs opacity-60 select-none",draggable:!!o,onDragStart:o,title:"Drag to reorder",children:"\u2630"}),f("div",{className:"font-semibold capitalize",children:h})]}),O("div",{className:"flex gap-2",children:[f("button",{className:ke,onClick:a,children:d?"Bypass":"Enable"}),f("button",{className:ke,onClick:r,title:"Remove module",children:"\xD7"})]})]}),f("div",{className:"mt-2 text-xs opacity-70",children:d?"active":"bypassed"}),O("div",{className:"mt-3 space-y-2",children:[h==="ks_source"&&O(se,{children:[O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),O("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.ch??"all"),onChange:e=>{t("ch",e.target.value),e.target.blur()},children:[f("option",{value:"all",children:"all"}),Array.from({length:16},(e,v)=>f("option",{value:String(v),children:v},v))]})]}),O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"Program"}),O("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.program??"all"),onChange:e=>{t("program",e.target.value),e.target.blur()},children:[f("option",{value:"all",children:"all"}),Array.from({length:128},(e,v)=>f("option",{value:String(v),children:v},v))]})]}),O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),f("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.smoothingMode??"auto"),onChange:e=>{t("smoothingMode",e.target.value),e.target.blur()},children:["auto","manual"].map(e=>f("option",{value:e,children:e},e))})]}),String(l.smoothingMode??"auto")==="manual"&&f(z,{label:"smooth",min:0,max:1,value:Number(l.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),f(z,{label:"velScale",min:0,max:1,value:Number(l.velScale??1),onChange:e=>t("velScale",e)}),f(z,{label:"KS dur",min:.1,max:10,step:.1,value:Number(l.ksDurSec??1),onChange:e=>t("ksDurSec",e),suffix:"s"}),f(z,{label:"Release",min:0,max:1,step:.01,value:Number(l.ksRelease??.5),onChange:e=>t("ksRelease",e)}),O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"Noise"}),O("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.seedNoiseType??"pink"),onChange:e=>{t("seedNoiseType",e.target.value),e.target.blur()},children:[f("option",{value:"brown",children:"Soft"}),f("option",{value:"softBrown",children:"Extra Soft"}),f("option",{value:"red",children:"Deep Soft"}),f("option",{value:"pink",children:"Warm"}),f("option",{value:"softPink",children:"Warm Soft"}),f("option",{value:"white",children:"Bright"}),f("option",{value:"blue",children:"Airy"}),f("option",{value:"violet",children:"Breathy"}),f("option",{value:"wind",children:"Windy"}),f("option",{value:"perlin",children:"Organic"}),f("option",{value:"formant",children:"Body"}),f("option",{value:"dust",children:"Dusty"}),f("option",{value:"wood",children:"Woody"}),f("option",{value:"grey",children:"Mix"})]})]}),String(l.smoothingMode??"auto")==="auto"&&f("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / variation \u8207 note \u8A08\u7B97"})]}),h==="source"&&O(se,{children:[O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),O("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(u.params.ch??"all"),onChange:e=>{t("ch",e.target.value),e.target.blur()},children:[f("option",{value:"all",children:"all"}),Array.from({length:16},(e,v)=>f("option",{value:String(v),children:v},v))]})]}),O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"wave"}),f("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(u.params.type),onChange:e=>{t("type",e.target.value),e.target.blur()},children:["sine","square","sawtooth","triangle"].map(e=>f("option",{value:e,children:e},e))})]}),f(z,{label:"attack",min:0,max:.2,value:Number(u.params.adsr?.a??.003),onChange:e=>t("adsr",{...u.params.adsr||{},a:e})}),f(z,{label:"decay",min:0,max:1,value:Number(u.params.adsr?.d??.08),onChange:e=>t("adsr",{...u.params.adsr||{},d:e})}),f(z,{label:"sustain",min:0,max:1,value:Number(u.params.adsr?.s??.4),onChange:e=>t("adsr",{...u.params.adsr||{},s:e})}),f(z,{label:"release",min:0,max:2,value:Number(u.params.adsr?.r??.2),onChange:e=>t("adsr",{...u.params.adsr||{},r:e})})]}),h==="filter"&&O(se,{children:[O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"mode"}),f("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.mode??"lowpass"),onChange:e=>{t("mode",e.target.value),e.target.blur()},children:["lowpass","highpass","bandpass","notch"].map(e=>f("option",{value:e,children:e},e))})]}),f(z,{label:"freq",min:50,max:12e3,value:Number(l.freq??1200),onChange:e=>t("freq",e)}),f(z,{label:"Q",min:.1,max:20,value:Number(l.q??.7),onChange:e=>t("q",e)})]}),h==="delay"&&O(se,{children:[f(z,{label:"time",min:.01,max:1.2,value:Number(l.time??.25),onChange:e=>t("time",e)}),f(z,{label:"feedback",min:0,max:.95,value:Number(l.feedback??.35),onChange:e=>t("feedback",e)}),f(z,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),h==="reverb"&&O(se,{children:[f(z,{label:"decay",min:.2,max:6,value:Number(l.decay??2),onChange:e=>t("decay",e)}),f(z,{label:"mix",min:0,max:1,value:Number(l.mix??.25),onChange:e=>t("mix",e)})]}),h==="convolver_ir"&&O(se,{children:[O("div",{className:"flex items-center gap-2",children:[f("div",{className:"w-24 text-sm opacity-80",children:"IR"}),f("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.irId??"IR_Gibson"),onChange:e=>{t("irId",e.target.value),e.target.blur()},children:["IR_Gibson","IR_piezo"].map(e=>f("option",{value:e,children:e},e))})]}),f(z,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),h==="gain"&&f(z,{label:"gain",min:0,max:1.5,value:Number(l.gain??.8),onChange:e=>t("gain",e)}),h==="analyzer"&&f("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var me=class{constructor(a){Ne(this,"handleMIDIMsg",a=>{let r=a[0],t=a[1],o=a[2],h=r&240,d=r&15;h===144&&o>0?this.gate(!0,o/127,d,t):(h===128||h===144&&o===0)&&this.gate(!1,0,d,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let r=this.actx.createGain();return r.gain.value=1,r}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let r=0;r<16;r++)try{this.mixers[r].connect(this.midiSynth.chvol[r]),console.log(`[RC] mixer[ch${r}] -> chvol[ch${r}]`)}catch(t){console.warn(`[RC] mixer[ch${r}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}updateGainNodeById(a,r){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let o=this.actx.currentTime;try{t.gain.cancelScheduledValues(o),t.gain.setTargetAtTime(Number(r)||0,o,.01)}catch{t.gain.value=Number(r)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let r=this.actx.createConstantSource();return r.offset.value=0,r.start(),this._bendCS[a]=r,r}updateBend(a,r){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),o=Number.isFinite(r)?r:0;try{let h=this.actx.currentTime;t.offset.cancelScheduledValues(h),t.offset.setTargetAtTime(o,h,.01)}catch{t.offset.value=o}}setMidiSynth(a){this.midiSynth=a;let r=a&&(a.actx||a.audioContext);if(r&&r!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=r,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(o){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,o)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a,r=0){this.liveNodes.clear();let t=d=>{let l=d.kind,e=d.params||{},v=this.actx;if(!d.enabled){let c=v.createGain();return{in:c,out:c}}switch(l){case"ks_source":{let c=v.createGain();return this.liveNodes.set(d.id+":ksOut",c),this.liveNodes.set(d.id+":ksParams",e),this.liveNodes.set("__lastKsId__",d.id),this.liveNodes.set("keyboardTarget",c),{in:c,out:c}}case"source":{let c=v.createOscillator();c.type=e.type||"sawtooth";let w=v.createGain();return w.gain.value=0,c.connect(w),c.start(),this.liveNodes.set(d.id+":osc",c),this.liveNodes.set(d.id+":env",w),this.liveNodes.set(d.id+":oscType",c.type),this.liveNodes.set(d.id+":ch",e.ch??"all"),this.liveNodes.set(d.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",c.type),this.liveNodes.set("keyboardTarget",w),{in:w,out:w}}case"gain":{let c=this.actx.createGain();return c.gain.value=Number(e.gain??1),this.liveNodes.set(d.id+":node",c),{in:c,out:c}}case"filter":{let c=v.createBiquadFilter();return c.type=e.mode||"lowpass",c.frequency.value=Number(e.freq||1200),c.Q.value=Number(e.q||.7),this.liveNodes.set(d.id+":node",c),{in:c,out:c}}case"delay":{let c=v.createDelay(2);c.delayTime.value=Number(e.time||.25);let w=v.createGain();w.gain.value=Number(e.feedback||.3);let A=v.createGain();A.gain.value=Number(e.mix||.3);let G=v.createGain(),D=v.createGain(),b=v.createGain();return b.gain.value=1-A.gain.value,G.connect(c),G.connect(b),c.connect(w).connect(c),c.connect(A),b.connect(D),A.connect(D),this.liveNodes.set(d.id+":node",{input:G,output:D,delay:c,fb:w,mix:A}),{in:G,out:D}}case"analyzer":{let c=v.createGain();return c.connect(this.analyser),this.liveNodes.set(d.id+":node",c),{in:c,out:c}}default:{let c=v.createGain();return{in:c,out:c}}}},o=null,h=null;for(let d of a){let{in:l,out:e}=t(d);o||(o=l),h&&h.connect(l),h=e}o&&this.liveNodes.set("__chainHead__",o),h&&this.liveNodes.set("__chainTail__",h);try{if(!h)return;let d=r|0,l=this.actx.createGain();l.gain.value=1,this.liveNodes.set(`chainGain:${d}`,l),h.connect(l);let v=a.find(w=>w.kind==="ks_source"||w.kind==="source")?.params?.ch??"all",c=v==="all"?Array.from({length:16},(w,A)=>A):[Number(v)];for(let w of c){let A=this.mixers[w];A&&l.connect(A)}}catch(d){console.warn("[RC] mixer connect failed",d)}}buildMany(a){let r=this.liveNodes,t=r.get("__oscVoices__"),o=r.get("__ksVoices__"),h=new Map;a.forEach((d,l)=>{let e=new Map;this.liveNodes=e,this.build(d,l);for(let[v,c]of e.entries())h.set(v,c)}),t&&h.set("__oscVoices__",t),o&&h.set("__ksVoices__",o),this.liveNodes=h}setChainMute(a,r){try{let t=`chainGain:${a|0}`,o=this.liveNodes&&this.liveNodes.get(t);if(!o||!o.gain)return console.warn("[RC] setChainMute: chainGain not found",t),!1;let h=this.actx.currentTime;return o.gain.cancelScheduledValues(h),o.gain.setValueAtTime(r?0:1,h),console.log("[RC] setChainMute",{chainIdx:a,key:t,muted:r,gain:o.gain.value}),!0}catch(t){return console.warn("[RC] setChainMute failed",a,t),!1}}gate(a,r=.8,t=0,o=69){let h=this.actx.currentTime,d=(o??69)|0,l=!1;if(a){let e=this.pluckKS(t,o??69,r)===!0,v=this.gateOsc(t,o,r)===!0;l=e||v}if(a&&!l){let v=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(d-69)/12),c=[];for(let[k,N]of this.liveNodes.entries())if(k.endsWith(":oscType")){let V=k.split(":")[0],I=this.liveNodes.get(V+":ch")??"all",$=this.liveNodes.get(V+":adsr")||{a:.003,d:.08,s:.4,r:.2},E=N||"sawtooth";(I==="all"||Number(I)===t)&&c.push({modId:V,type:E,adsr:$})}if(!c.length)return;let w=this.liveNodes.get("__chainTail__"),A=this.liveNodes.get("__chainHead__"),G=this.liveNodes.get("keyboardTarget"),D=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let b=this.liveNodes.get("__oscVoices__");b[t]||(b[t]={});for(let k of c){let N=this.actx.createOscillator();try{N.type=k.type}catch{N.type="sawtooth"}N.frequency.setValueAtTime(v,h);try{let J=this.midiSynth?.chmod?.[t];J&&N.detune&&J.connect(N.detune);let ee=this.getBendNode(t);N.detune&&ee&&ee.connect(N.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(J){console.warn("[RC] osc detune connect failed",J)}let V=this.actx.createGain();V.gain.setValueAtTime(0,h);let{a:I,d:$,s:E,r:ae}=k.adsr;V.gain.linearRampToValueAtTime(r,h+(I??.003)),V.gain.linearRampToValueAtTime((E??.4)*r,h+(I??.003)+($??.08)),N.connect(V);let q=null;A&&A!==G?q=A:w?q=w:D&&(q=D),!q&&D&&(q=D),q&&V.connect(q),N.start(h);let Z=`${d}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;b[t][Z]={note:d,osc:N,env:V,r:ae??.2}}}if(!a){let e=this.actx.currentTime,v=this.liveNodes.get("__ksVoices__"),c=(this.midiSynth?.pedal?.[t]??0)>=64;if(v&&v[t]){let G=Object.entries(v[t]).filter(([D,b])=>b.note===d);for(let[D,b]of G){let{bfs:k,env:N}=b;if(c){b.sustained=!0;continue}try{let V=Number(b.params?.ksRelease??.5),I=.02,E=I+(1.5-I)*Math.pow(V,2);N.gain.cancelScheduledValues(e),N.gain.setValueAtTime(N.gain.value??1,e),N.gain.linearRampToValueAtTime(0,e+E),k.stop(e+E+.05),setTimeout(()=>{try{k.disconnect(),N.disconnect()}catch{}delete v[t][D]},(E+.05)*1e3)}catch{delete v[t][D]}}}let w=this.liveNodes.get("__oscVoices__");if(!w||!w[t])return;let A=Object.entries(w[t]).filter(([G,D])=>D.note===d);for(let[G,D]of A){let{osc:b,env:k,r:N=.2}=D;try{k.gain.cancelScheduledValues(e),k.gain.setValueAtTime(k.gain.value??0,e),k.gain.linearRampToValueAtTime(0,e+N),b.stop(e+N+.05),setTimeout(()=>{try{b.disconnect(),k.disconnect()}catch{}delete w[t][G]},(N+.1)*1e3)}catch{delete w[t][G]}}}}pluckKS(a,r,t){let o=Array.from(this.liveNodes.entries()).filter(([y])=>y.endsWith(":ksOut"));if(!o.length)return!1;let h=null,d={},l=[],e=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[y,M]of o){let B=this.liveNodes.get(y.replace(":ksOut",":ksParams"))||{},H=B.ch!=null?String(B.ch):"all",ne=H==="all"||Number(H)===a,P=B.program;(P==null||P==="all")&&(P="all");let ie=P==="all"?null:Number(P);ne&&(ie===null||ie===e)&&(h||(h=[y,M],d=B),l.push(M))}if(!h)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:e}),!1;let v=h[0],c=h[1],w=d,G=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(r-69)/12),D=this.actx.sampleRate,b=null;try{let y=String(w.seedNoiseType??"pink"),M=Math.max(2048,Math.round(D/Math.max(1e-6,G))),B=i=>{let x=new Float32Array(i);for(let m=0;m<i;m++)x[m]=Math.random()*2-1;return x},H=i=>{let x=new Float32Array(i),m=0,S=0,C=0,T=0,R=0,j=0,te=0;for(let re=0;re<i;re++){let L=Math.random()*2-1;m=.99886*m+L*.0555179,S=.99332*S+L*.0750759,C=.969*C+L*.153852,T=.8665*T+L*.3104856,R=.55*R+L*.5329522,j=-.7616*j-L*.016898,x[re]=(m+S+C+T+R+j+te*.5362)*.11,te=L*.115926}return x},ne=i=>{let x=new Float32Array(i),m=0;for(let S=0;S<i;S++)m+=Math.random()*2-1,m=Math.max(-8,Math.min(8,m)),x[S]=m/8;return x},P=i=>{let x=B(i),m=H(i),S=new Float32Array(i);for(let C=0;C<i;C++)S[C]=.6*x[C]+.4*m[C];return S},ie=i=>{let x=new Float32Array(i),m=0,S=0;for(let C=0;C<i;C++)m+=(Math.random()*2-1)*.02,S+=m,x[C]=S*5e-4;return x},de=i=>{let x=new Float32Array(i),m=0;for(let T=0;T<i;T++){let R=Math.random()*2-1;x[T]=R-m,m=R}let S=new Float32Array(i),C=0;for(let T=0;T<i;T++)C=C*.992+x[T]*.008,S[T]=C;return S},fe=i=>{let x=new Float32Array(i),m=0;for(let T=0;T<i;T++){let R=Math.random()*2-1;x[T]=R-m,m=R}let S=new Float32Array(i),C=0;for(let T=0;T<i;T++)C=C*.995+x[T]*.005,S[T]=C;return S},ge=i=>{let x=ne(i),m=new Float32Array(i),S=0;for(let C=0;C<i;C++)S=S*.995+x[C]*.005,m[C]=S*.9;return m},ue=i=>{let x=H(i),m=new Float32Array(i),S=0;for(let C=0;C<i;C++)S=S*.993+x[C]*.007,m[C]=S*.9;return m},n=i=>{let x=new Float32Array(i),m=0,S=0;for(let C=0;C<i;C++){let T=Math.random()*2-1;m=m*.985+T*.015,S=S*.995+(Math.random()*2-1)*.005;let R=.6+.4*S;x[C]=m*R}return x},s=i=>{let x=new Float32Array(i),m=Math.max(8,Math.floor(i/64)),S=[],C=Math.floor(i/m)+2;for(let R=0;R<C;R++)S[R]=Math.random()*2-1;let T=R=>R*R*R*(R*(R*6-15)+10);for(let R=0;R<i;R++){let j=R/m,te=Math.floor(j),re=j-te,L=S[te],Te=S[te+1],we=T(re);x[R]=(L*(1-we)+Te*we)*.9}return x},g=i=>{let x=new Float32Array(i),m=B(i),S=300,C=800,T=2500;for(let R=0;R<i;R++){let j=R/D,te=1+.6*Math.sin(2*Math.PI*S*j)+.4*Math.sin(2*Math.PI*C*j+1.3)+.25*Math.sin(2*Math.PI*T*j+.7);x[R]=m[R]*(te*.25)}return x},p=i=>{let x=new Float32Array(i),m=0,S=.004;for(let C=0;C<i;C++)Math.random()<S&&(m+=(Math.random()*2-1)*.9),m*=.96,x[C]=m;return x},_=i=>{let x=ue(i),m=new Float32Array(i),S=220,C=550;for(let T=0;T<i;T++){let R=T/D,j=.5*Math.sin(2*Math.PI*S*R)+.35*Math.sin(2*Math.PI*C*R+1.1);m[T]=x[T]*(1+.4*j)}return m};switch(y){case"white":b=B(M);break;case"pink":b=H(M);break;case"brown":b=ne(M);break;case"softBrown":b=ge(M);break;case"softPink":b=ue(M);break;case"red":b=ie(M);break;case"blue":b=de(M);break;case"violet":b=fe(M);break;case"gray":b=P(M);break;case"wind":b=n(M);break;case"perlin":b=s(M);break;case"formant":b=g(M);break;case"dust":b=p(M);break;case"wood":b=_(M);break;default:b=H(M);break}}catch(y){console.warn("[RC] seed generation failed, fallback pink",y);let M=2048;b=new Float32Array(M);for(let B=0;B<M;B++)b[B]=Math.random()*2-1}if(console.log("[RC] seed check",b?.length,b?.[0]),!b||!b.length){console.warn("[RC] seed invalid, injecting pink noise");let y=Math.max(2048,Math.round(D/Math.max(1e-6,G)));b=new Float32Array(y);for(let M=0;M<y;M++)b[M]=Math.random()*2-1}let k=Number(w.ksDurSec);Number.isFinite(k)||(k=1),k=Math.min(Math.max(k,.1),10);let N=Math.round(D*k),V=this.actx.createBuffer(2,N,D),I=String(w.smoothingMode??"auto"),$=this.midiSynth?.options?.[a]??{},E;if(I==="manual"){let y=Number(w.smoothingFactor);Number.isFinite(y)||(y=.2),y<.01&&(y=.01),y>.99&&(y=.99),E=y}else try{let y=this.midiSynth?.inv127??.007874015748031496,M=Math.pow(r/64,.5)||0,B=r*y*.85+.15;typeof $.stringDamping=="number"?B=$.stringDamping:this.midiSynth?.options?.[a]&&(this.midiSynth.options[a].stringDamping=B);let H=Number($.stringDampingVariation??0);E=B+M*(1-B)*.5+(1-B)*Math.random()*H}catch{E=.2}Number.isFinite(E)||(E=.2);let ae=Number(w.velScale==null?1:w.velScale);if(Object.keys($).length===0&&($.stringDamping=.5,$.stringDampingVariation=.2),Number.isFinite(E)||(E=.2),!b||!b.length){console.warn("[RC] seed invalid, injecting pink noise");let y=Math.max(2048,Math.round(D/Math.max(1e-6,G)));b=new Float32Array(y);for(let M=0;M<y;M++)b[M]=Math.random()*2-1}try{let y=this.midiSynth?.asmWrapper?.[a];y&&typeof y.pluck=="function"&&y.pluck(V,b,D,G,E,t*ae,$,.2)}catch(y){console.warn("[RC] pluck error",y)}let q=this.actx.createBufferSource();q.buffer=V;try{let y=this.midiSynth?.chmod?.[a];y&&q.detune&&y.connect(q.detune)}catch{}try{let y=this.midiSynth?.bend?.[a];typeof y=="number"&&q.detune&&(q.detune.value=y)}catch{}let Z=this.actx.createGain();Z.gain.setValueAtTime(1,this.actx.currentTime),this.liveNodes.has("__ksVoices__")||this.liveNodes.set("__ksVoices__",{});let J=this.liveNodes.get("__ksVoices__");J[a]||(J[a]={});let ee=`${r}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;J[a][ee]={note:r,bfs:q,env:Z,params:w,sustained:!1},q.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[r]===q&&(this.midiSynth.bfSet[a][r]=null)}catch{}try{let y=this.liveNodes.get("__ksVoices__");y&&y[a]&&y[a][ee]&&delete y[a][ee]}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][r]=q}catch{}try{let y=v.replace(":ksOut",":tail"),M=this.liveNodes.get(y)||this.liveNodes.get("__chainTail__")}catch{}q.connect(Z);for(let y of l)try{Z.connect(y)}catch(M){console.warn("[RC] env.connect ksOut failed",M)}return q.start(),!0}gateOsc(a,r,t){let o=Array.from(this.liveNodes.entries()).filter(([c])=>c.endsWith(":osc"));if(!o.length)return!1;let h=!1,d=(r??69)|0,l=this.actx.currentTime,v=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(d-69)/12);for(let[c,w]of o){let A=c.replace(":osc",""),G=this.liveNodes.get(A+":ch")??"all";if(!(G==="all"||Number(G)===a))continue;let b=this.liveNodes.get(A+":env"),k=this.liveNodes.get(A+":adsr")||{a:.003,d:.08,s:.4,r:.2};if(!b)continue;try{w.frequency.setValueAtTime(v,l)}catch{}let{a:N,d:V,s:I,r:$}=k;b.gain.cancelScheduledValues(l),b.gain.setValueAtTime(0,l),b.gain.linearRampToValueAtTime(t,l+(N??.003)),b.gain.linearRampToValueAtTime((I??.4)*t,l+(N??.003)+(V??.08)),b.gain.linearRampToValueAtTime(0,l+(N??.003)+(V??.08)+($??.2)),h=!0}return h}releaseSustainKSForChannel(a){let r=this.actx.currentTime,t=this.liveNodes.get("__ksVoices__");if(!(!t||!t[a]))for(let[o,h]of Object.entries(t[a])){if(!h.sustained)continue;let{bfs:d,env:l,params:e}=h,v=Number(e?.ksRelease??.5),c=.02,A=c+(1.5-c)*Math.pow(v,2);l.gain.cancelScheduledValues(r),l.gain.setValueAtTime(l.gain.value??1,r),l.gain.linearRampToValueAtTime(0,r+A),d.stop(r+A+.05),h.sustained=!1,setTimeout(()=>{try{d.disconnect(),l.disconnect()}catch{}delete t[a][o]},(A+.05)*1e3)}}};function Oe(u){return u&&typeof u=="object"&&typeof u.kind=="string"}function he(u){return Array.isArray(u)?u.filter(Oe).map(a=>({id:a.id||`${a.kind}_${Math.random().toString(36).slice(2,9)}`,kind:a.kind,enabled:a.enabled!==!1,params:typeof a.params=="object"&&a.params?{...a.params}:{}})):null}function Ce(u){if(!u)return null;if(Array.isArray(u)&&Array.isArray(u[0])){let h=u.map(he).filter(Boolean);return{version:1,chains:h,chainMeta:h.map(()=>({})),mutes:h.map(()=>!1)}}let a=u.chains;if(!Array.isArray(a))return null;let r=a.map(he).filter(Boolean),t=Array.isArray(u.chainMeta)?u.chainMeta.slice(0,r.length):[];for(;t.length<r.length;)t.push({});let o=Array.isArray(u.mutes)?u.mutes.slice(0,r.length):[];for(;o.length<r.length;)o.push(!1);return{version:Number(u.version)||1,chains:r,chainMeta:t,mutes:o}}function _e(u){return u?Array.isArray(u)?{chain:he(u),meta:{},mute:!1}:Array.isArray(u.chain)?{chain:he(u.chain),meta:typeof u.meta=="object"&&u.meta?u.meta:{},mute:!!u.mute}:null:null}import{Fragment as Ae,jsx as F,jsxs as W}from"react/jsx-runtime";var K="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var Ge=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],ce={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:"all"},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function Q(u="m"){return`${u}_${Math.random().toString(36).slice(2,9)}`}function Me(u,a,r){let t=u.slice(),o=Math.max(0,Math.min(t.length-1,a)),h=t.splice(o,1)[0],d=Math.max(0,Math.min(t.length,r));return t.splice(d,0,h),t}function ve({synth:u,initialState:a,onChange:r}){let t=Se(null);t.current||(t.current=new me);let o=t.current;X(()=>{if(u&&typeof o.setMidiSynth=="function")try{o.setMidiSynth(u),console.log("[RC] midi_synth attached to engine")}catch(n){console.warn("[RC] setMidiSynth failed",n)}},[u]);let h=()=>[[{id:Q("ks"),kind:"ks_source",enabled:!0,params:{...ce.ks_source}},{id:Q("gain"),kind:"gain",enabled:!0,params:{...ce.gain}},{id:Q("an"),kind:"analyzer",enabled:!0,params:{}}]],[d,l]=oe(()=>{let n=a?.chains;return Array.isArray(n)&&n.length>0?n:h()}),[e,v]=oe(()=>{let n=a?.chainMeta;return Array.isArray(n)?n:[]}),[c,w]=oe(()=>{let n=a?.mutes;return Array.isArray(n)?n:[]}),A=Se(c);X(()=>{A.current=c},[c]),X(()=>{w(n=>{let s=n.slice(0,d.length);for(;s.length<d.length;)s.push(!1);return s})},[d.length]),X(()=>{v(n=>{let s=(Array.isArray(n)?n:[]).slice(0,d.length);for(;s.length<d.length;)s.push({});return s})},[d.length]);let G=async n=>{try{let s=await fetch(n);if(!s.ok)throw new Error(`HTTP ${s.status}`);let g=await s.json(),p=Ce(g);if(!p)throw new Error("Invalid routing JSON");l(p.chains),v(p.chainMeta),w(p.mutes),console.log("[RC] routing loaded from URL:",n)}catch(s){console.warn("[RC] loadFromURL failed:",s)}};async function D(n,s){let g=n|0;if(!(g<0)&&!k(g))try{let p=await fetch(s);if(!p.ok)throw new Error(`HTTP ${p.status}`);let _=await p.json(),i=_e(_);if(!i||!i.chain)throw new Error("Invalid chain JSON");l(x=>{let m=Array.isArray(x)?x.slice():[];for(;m.length<g+1;)m.push([]);return m[g]=i.chain,m}),v(x=>{let m=Array.isArray(x)?x.slice():[];for(;m.length<g+1;)m.push({});return m[g]=i.meta||{},m}),w(x=>{let m=Array.isArray(x)?x.slice():[];for(;m.length<g+1;)m.push(!1);return m[g]=!!i.mute,m}),console.log("[RC] chain loaded from URL:",g,s)}catch(p){console.warn("[RC] loadChainFromURL failed:",p)}}let b=n=>{w(s=>{let g=[...s];return g[n]=!g[n],g})},k=n=>e?.[n]?.locked===!0;X(()=>(window.__RC_HANDLE__={midi:n=>{try{o.handleMIDIMsg&&o.handleMIDIMsg(n),console.log("[RC] MIDI -> engine",n)}catch(s){console.warn("[RC] MIDI ingress failed",s)}},engine:o,loadFromURL:G,loadChainFromURL:D,getState:()=>({chains:d,chainMeta:e,mutes:c}),setChainMeta:(n,s)=>{let g=n|0;!s||typeof s!="object"||v(p=>(Array.isArray(p)?p:[]).map((_,i)=>i===g?{..._||{},...s}:_))},setChainMute:(n,s)=>{let g=n|0;w(p=>(Array.isArray(p)?p:[]).map((_,i)=>i===g?!!s:_))}},()=>{try{delete window.__RC_HANDLE__}catch{}}),[o,d,e,c]),X(()=>{r&&r({chains:d,mutes:c,chainMeta:e})},[d,c,e,r]);let[N,V]=oe({open:!1,idx:null,step:1}),I=n=>{k(n)||V({open:!0,idx:n,step:1})},$=()=>V({open:!1,idx:null,step:1}),E=()=>V(n=>({...n,step:2})),ae=()=>{l(n=>{let s=n.filter((g,p)=>p!==N.idx);return s.length?s:[[{id:Q("src"),kind:"source",enabled:!0,params:{...ce.source}},{id:Q("gain"),kind:"gain",enabled:!0,params:{...ce.gain}},{id:Q("an"),kind:"analyzer",enabled:!0,params:{}}]]}),$()};X(()=>{try{o.buildMany(d),o.resume&&o.resume(),A.current.forEach((n,s)=>{typeof o.setChainMute=="function"&&o.setChainMute(s,n)})}catch(n){console.warn("[RC] buildMany failed",n)}},[o,JSON.stringify(d)]),X(()=>{c.forEach((n,s)=>{typeof o.setChainMute=="function"&&o.setChainMute(s,n)})},[o,c]),X(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(n=>{for(let s of n.inputs.values())s.onmidimessage=g=>o.handleMIDIMsg(g.data)})},[]);let q=(n,s)=>{k(n)||l(g=>{let p=g.map(_=>[..._]);return p[n]=[...p[n],{id:Q(s),kind:s,enabled:!0,params:{...ce[s]}}],p})},Z=(n,s)=>{k(n)||l(g=>g.map((p,_)=>_!==n?p:p.map(i=>i.id===s?{...i,enabled:!i.enabled}:i)))},J=(n,s)=>{k(n)||l(g=>g.map((p,_)=>_!==n?p:p.filter(i=>i.id!==s)))},ee=(n,s,g,p)=>{k(n)||(g==="gain"&&(o.updateGainNodeById(s,p)||console.warn("[RC] gain node not found for id:",s)),l(_=>_.map((i,x)=>x!==n?i:i.map(m=>m.id===s?{...m,params:{...m.params,[g]:p}}:m))))},[y,M]=oe(null),B=(n,s)=>g=>{k(n)||(M({chain:n,from:s}),g.dataTransfer.effectAllowed="move",g.dataTransfer.setData("text/plain",`${n}:${s}`))},H=(n,s)=>g=>{k(n)||(g.preventDefault(),!(!y||y.chain!==n)&&(l(p=>p.map((_,i)=>i!==n?_:Me(_,y.from,s))),M(null)))},ne=n=>s=>{k(n)||(s.preventDefault(),!(!y||y.chain!==n)&&(l(g=>g.map((p,_)=>_!==n?p:Me(p,y.from,p.length))),M(null)))},P=n=>l(s=>{let g=s.map(_=>[..._]),p=g[n].map(_=>({..._,id:Q(_.kind)}));return g.splice(n+1,0,p),g}),ie=n=>{let s=d[n];if(!s)return;let g=s,p=new Blob([JSON.stringify(g,null,2)],{type:"application/json"}),_=URL.createObjectURL(p),i=document.createElement("a");i.href=_,i.download=`audio-chain-${n+1}.json`,i.click(),URL.revokeObjectURL(_)},de=async(n,s)=>{if(k(chainIdx))return;let g=await s.text();try{let p=JSON.parse(g);if(!Array.isArray(p))return;let _=p.map(i=>({id:Q(i.kind||"mod"),kind:i.kind||"gain",enabled:i.enabled!==!1,params:i.params||{}}));l(i=>i.map((x,m)=>m===n?_:x))}catch(p){console.warn("[RC] importChain failed",p)}},fe=()=>l(n=>[...n,[]]),ge=()=>{let n=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),s=URL.createObjectURL(n),g=document.createElement("a");g.href=s,g.download="audio-chains.json",g.click(),URL.revokeObjectURL(s)},ue=async n=>{let s=await n.text();try{let g=JSON.parse(s);Array.isArray(g)&&Array.isArray(g[0])&&l(g)}catch(g){console.warn("Invalid chain JSON",g)}};return W("div",{className:"p-6 text-white",children:[F("div",{className:"flex items-center justify-between mb-4",children:W("div",{className:"flex items-center gap-2 flex-wrap",children:[F("button",{className:K,onClick:ge,children:"Export"}),W("label",{className:`${K} cursor-pointer`,children:["Import",F("input",{type:"file",accept:"application/json",className:"hidden",onChange:n=>{let s=n.target.files?.[0];s&&ue(s)}})]}),F("button",{className:K,onClick:()=>{typeof o.buildMultiFrom=="function"?o.buildMultiFrom(d[0],Array.from({length:16},(n,s)=>s)):l(n=>{let s=n[0]||[];return Array.from({length:16},(p,_)=>s.map(i=>({...i,id:Q(i.kind)+`_ch${_}`,params:i.kind==="ks_source"?{...i.params,ch:String(_)}:{...i.params}})))})},children:"Duplicate to 16 channels"})]})}),W("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:[d.map((n,s)=>{let g=k(s);return W("div",{className:`mb-6 rounded-lg p-2
              ${g?"bg-neutral-900/60 border border-yellow-500/40":""}`,children:[W("div",{className:"flex items-center justify-between mb-2",children:[F("div",{className:"text-sm opacity-80",children:e[s]?.name??`Chain #${s+1}`}),g&&F("span",{className:`text-xs px-2 py-0.5 rounded\r
                            border border-yellow-400\r
                            text-yellow-400\r
                            bg-transparent\r
                            opacity-100`,title:"This chain is locked (GUI editing disabled)",children:"\u{1F512} Locked"}),W("div",{className:"flex gap-2 items-center",children:[F("button",{className:K,onClick:()=>b(s),title:c[s]?"Unmute chain":"Mute chain",children:c[s]?"\u{1F507}":"\u{1F50A}"}),F("button",{className:K,onClick:()=>ie(s),children:"Export"}),W("label",{className:`${K} cursor-pointer`,children:["Import",F("input",{type:"file",accept:"application/json",className:"hidden",onChange:p=>{let _=p.target.files?.[0];_&&de(s,_),p.target.value=""}})]}),F("button",{className:K,onClick:()=>P(s),children:"Duplicate"}),F("button",{className:K,onClick:()=>I(s),children:"Delete"})]})]}),W("div",{className:"flex gap-3 items-stretch",children:[n.map((p,_)=>F("div",{onDrop:H(s,_),onDragOver:i=>i.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:F(be,{mod:p,onToggle:()=>Z(s,p.id),onRemove:()=>J(s,p.id),onParam:(i,x)=>ee(s,p.id,i,x),onDragStart:B(s,_)})},p.id)),F("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:p=>p.preventDefault(),onDrop:ne(s),children:"\u2192"})]}),F("div",{className:"mt-3 flex flex-wrap gap-2",children:Ge.map(p=>W("button",{className:K,onClick:()=>q(s,p),children:["+ ",p]},`${s}-${p}`))})]},s)}),F("div",{className:"mt-2 flex justify-center",children:F("button",{className:K,onClick:fe,children:"+ Add chain"})})]}),N.open&&F("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:F("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:N.step===1?W(Ae,{children:[F("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),F("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),W("div",{className:"flex justify-end gap-2",children:[F("button",{className:K,onClick:$,children:"Cancel"}),F("button",{className:K,onClick:E,children:"Next"})]})]}):W(Ae,{children:[F("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),F("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),W("div",{className:"flex justify-end gap-2",children:[F("button",{className:K,onClick:$,children:"Cancel"}),F("button",{className:K,onClick:ae,children:"Delete"})]})]})})})]})}import{jsx as U,jsxs as Y}from"react/jsx-runtime";function le({synth:u,buttonTarget:a,autoTailwind:r=!1,showButton:t=!0,initialState:o,onChange:h}){let[d,l]=ye(!1);pe(()=>{if(!d)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(N){console.warn("[RC] resumeAll failed",N)}})()},[d]);let[e,v]=ye(.3),[c,w]=ye(()=>u?.a4_freq??440);pe(()=>{typeof u?.a4_freq=="number"&&w(Number(u.a4_freq))},[u]),pe(()=>{let k=c,N=setInterval(()=>{let V=Number(u?.a4_freq??440);!Number.isNaN(V)&&V!==k&&(k=V,w(V))},250);return()=>clearInterval(N)},[u,c]);let A=420,D=Math.max(0,Math.min(1,(c-A)/(460-A)))*100;pe(()=>{if(!r||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let N=document.createElement("script");N.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",N.dataset.rcTailwind="1",document.head.appendChild(N)},[r]);let b=()=>U("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>l(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return Y("div",{children:[U("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        /* \u9810\u8A2D\u6DFA\u8272\u6A21\u5F0F \u2192 \u6DF1\u5929\u7A7A\u85CD */
        :root {
          --rc-toggle-text: #38bdf8; /* sky-400 */
        }

        /* \u6DF1\u8272\u6A21\u5F0F \u2192 \u6DFA\u5929\u7A7A\u85CD */
        @media (prefers-color-scheme: dark) {
          :root {
            --rc-toggle-text: #7dd3fc; /* sky-300 */
          }
        }
        /* \u5957\u5230\u6253\u958B GUI \u7684\u6309\u9215 */
        .rc-toggle-btn {
          color: var(--rc-toggle-text) !important;
        }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),t&&(a?qe.createPortal(U(b,{}),a):U("div",{className:"rc-fixed-default",children:U(b,{})})),U("div",{className:"rc-overlay",style:{display:d?"flex":"none"},onClick:k=>{k.target===k.currentTarget&&l(!1)},children:Y("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[Y("div",{className:"rc-header",children:[Y("div",{className:"flex items-center gap-4",children:[U("div",{children:"Routing Composer"}),Y("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[U("span",{children:"A4"}),U("input",{type:"range",min:"420",max:"460",step:"0.1",value:c,className:"rc-slider",style:{"--rc-pos":`${(c-420)/40*100}%`,width:160},onChange:k=>{let N=Number(k.target.value);Number.isNaN(N)||(w(N),u&&(u.a4_freq=N))}}),Y("span",{children:[c.toFixed(1),"Hz"]})]}),Y("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[U("span",{children:"Vol"}),U("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,className:"rc-slider",style:{"--rc-pos":`${e*100}%`,width:160},onChange:k=>{let N=Number(k.target.value);Number.isNaN(N)||(v(N),midi_synth&&midi_synth.setMasterVol(N))}}),Y("span",{children:[(e*100).toFixed(0),"%"]})]})]}),Y("div",{className:"flex items-center gap-2",children:[U("button",{className:"rc-close",onClick:()=>u?.actx?.resume?.(),children:"Resume Audio"}),U("button",{className:"rc-close",onClick:()=>l(!1),children:"Close"})]})]}),U("div",{className:"rc-body",children:U(ve,{synth:u,initialState:o,onChange:h})})]})})]})}import{jsx as Re}from"react/jsx-runtime";var ct=le;(function(){if(typeof window>"u")return;let a={mount(r={}){let{synth:t,button:o,tailwind:h="auto"}=r,d=null;o&&(typeof o=="string"?d=document.querySelector(o):o instanceof HTMLElement&&(d=o));let l=document.createElement("div");return document.body.appendChild(l),xe.createRoot?xe.createRoot(l).render(Re(le,{synth:t,buttonTarget:d,autoTailwind:h==="auto",showButton:r.showButton!==!1,initialState:r.initialState,onChange:r.onChange})):xe.render(Re(le,{synth:t,buttonTarget:d,autoTailwind:h==="auto",showButton:r.showButton!==!1,initialState:r.initialState,onChange:r.onChange}),l),console.log("[RoutingComposer] mounted GUI"),{host:l}}};window.RoutingComposer=a})();export{ct as default};
