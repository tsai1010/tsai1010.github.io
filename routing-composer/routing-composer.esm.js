var ge=Object.defineProperty;var be=(b,a,n)=>a in b?ge(b,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):b[a]=n;var de=(b,a,n)=>be(b,typeof a!="symbol"?a+"":a,n);import"react";import ce from"react-dom";import{useEffect as P,useState as re}from"react";import ye from"react-dom";import{useEffect as Z,useState as se,useRef as xe}from"react";import"react";import{Fragment as J,jsx as h,jsxs as S}from"react/jsx-runtime";var ve="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",ue="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function A({label:b,min:a,max:n,step:t=.01,value:i,onChange:c,suffix:l}){let e=typeof i=="number"?(Math.round(i*100)/100).toFixed(2):String(i??""),d=Number(i??0),r=Number(a??0),N=Number(n??1),v=Math.max(0,Math.min(1,(d-r)/(N-r)))*100;return S("div",{className:"flex items-center gap-3",children:[h("div",{className:"w-24 text-sm opacity-80",children:b}),h("input",{type:"range",className:"w-48 rc-slider",min:a,max:n,step:t,value:Number(i??0),onChange:k=>c(Number(k.target.value)),style:{"--rc-pos":`${v}%`}}),S("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[e,l?h("span",{className:"opacity-60",children:l}):null]})]})}function ie({mod:b,onToggle:a,onRemove:n,onParam:t}){let{kind:i,enabled:c,params:l={}}=b;return S("div",{className:`${ve} w-[280px]`,children:[S("div",{className:"flex items-center justify-between",children:[h("div",{className:"font-semibold capitalize",children:i}),S("div",{className:"flex gap-2",children:[h("button",{className:ue,onClick:a,children:c?"Bypass":"Enable"}),h("button",{className:ue,onClick:n,title:"Remove module",children:"\xD7"})]})]}),h("div",{className:"mt-2 text-xs opacity-70",children:c?"active":"bypassed"}),S("div",{className:"mt-3 space-y-2",children:[i==="ks_source"&&S(J,{children:[S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),S("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.ch??"all"),onChange:e=>t("ch",e.target.value),children:[h("option",{value:"all",children:"all"}),Array.from({length:16},(e,d)=>h("option",{value:String(d),children:d},d))]})]}),S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"Program"}),S("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.program??"all"),onChange:e=>t("program",e.target.value),children:[h("option",{value:"all",children:"all"}),Array.from({length:128},(e,d)=>h("option",{value:String(d),children:d},d))]})]}),S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),h("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.smoothingMode??"auto"),onChange:e=>t("smoothingMode",e.target.value),children:["auto","manual"].map(e=>h("option",{value:e,children:e},e))})]}),String(l.smoothingMode??"auto")==="manual"&&h(A,{label:"smooth",min:0,max:1,value:Number(l.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),h(A,{label:"velScale",min:0,max:1,value:Number(l.velScale??1),onChange:e=>t("velScale",e)}),h(A,{label:"KS dur",min:.1,max:10,step:.1,value:Number(l.ksDurSec??1),onChange:e=>t("ksDurSec",e),suffix:"s"}),h(A,{label:"Release",min:0,max:1,step:.01,value:Number(l.ksRelease??.5),onChange:e=>t("ksRelease",e)}),S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"Noise"}),S("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.seedNoiseType??"pink"),onChange:e=>t("seedNoiseType",e.target.value),children:[h("option",{value:"brown",children:"Soft"}),"   ",h("option",{value:"pink",children:"Warm"}),"    ",h("option",{value:"white",children:"Bright"})," ",h("option",{value:"grey",children:"Mix"}),"     "]})]}),String(l.smoothingMode??"auto")==="auto"&&h("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / variation \u8207 note \u8A08\u7B97"})]}),i==="source"&&S(J,{children:[S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),S("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(b.params.ch??"all"),onChange:e=>t("ch",e.target.value),children:[h("option",{value:"all",children:"all"}),Array.from({length:16},(e,d)=>h("option",{value:String(d),children:d},d))]})]}),S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"wave"}),h("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(b.params.type),onChange:e=>t("type",e.target.value),children:["sine","square","sawtooth","triangle"].map(e=>h("option",{value:e,children:e},e))})]}),h(A,{label:"attack",min:0,max:.2,value:Number(b.params.adsr?.a??.003),onChange:e=>t("adsr",{...b.params.adsr||{},a:e})}),h(A,{label:"decay",min:0,max:1,value:Number(b.params.adsr?.d??.08),onChange:e=>t("adsr",{...b.params.adsr||{},d:e})}),h(A,{label:"sustain",min:0,max:1,value:Number(b.params.adsr?.s??.4),onChange:e=>t("adsr",{...b.params.adsr||{},s:e})}),h(A,{label:"release",min:0,max:2,value:Number(b.params.adsr?.r??.2),onChange:e=>t("adsr",{...b.params.adsr||{},r:e})})]}),i==="filter"&&S(J,{children:[S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"mode"}),h("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.mode??"lowpass"),onChange:e=>t("mode",e.target.value),children:["lowpass","highpass","bandpass","notch"].map(e=>h("option",{value:e,children:e},e))})]}),h(A,{label:"freq",min:50,max:12e3,value:Number(l.freq??1200),onChange:e=>t("freq",e)}),h(A,{label:"Q",min:.1,max:20,value:Number(l.q??.7),onChange:e=>t("q",e)})]}),i==="delay"&&S(J,{children:[h(A,{label:"time",min:.01,max:1.2,value:Number(l.time??.25),onChange:e=>t("time",e)}),h(A,{label:"feedback",min:0,max:.95,value:Number(l.feedback??.35),onChange:e=>t("feedback",e)}),h(A,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),i==="reverb"&&S(J,{children:[h(A,{label:"decay",min:.2,max:6,value:Number(l.decay??2),onChange:e=>t("decay",e)}),h(A,{label:"mix",min:0,max:1,value:Number(l.mix??.25),onChange:e=>t("mix",e)})]}),i==="convolver_ir"&&S(J,{children:[S("div",{className:"flex items-center gap-2",children:[h("div",{className:"w-24 text-sm opacity-80",children:"IR"}),h("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.irId??"IR_Gibson"),onChange:e=>t("irId",e.target.value),children:["IR_Gibson","IR_piezo"].map(e=>h("option",{value:e,children:e},e))})]}),h(A,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),i==="gain"&&h(A,{label:"gain",min:0,max:1.5,value:Number(l.gain??.8),onChange:e=>t("gain",e)}),i==="analyzer"&&h("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var Y=class{constructor(a){de(this,"handleMIDIMsg",a=>{let n=a[0],t=a[1],i=a[2],c=n&240,l=n&15;c===144&&i>0?this.gate(!0,i/127,l,t):(c===128||c===144&&i===0)&&this.gate(!1,0,l,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let n=this.actx.createGain();return n.gain.value=1,n}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let n=0;n<16;n++)try{this.mixers[n].connect(this.midiSynth.chvol[n]),console.log(`[RC] mixer[ch${n}] -> chvol[ch${n}]`)}catch(t){console.warn(`[RC] mixer[ch${n}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}updateGainNodeById(a,n){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let i=this.actx.currentTime;try{t.gain.cancelScheduledValues(i),t.gain.setTargetAtTime(Number(n)||0,i,.01)}catch{t.gain.value=Number(n)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let n=this.actx.createConstantSource();return n.offset.value=0,n.start(),this._bendCS[a]=n,n}updateBend(a,n){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),i=Number.isFinite(n)?n:0;try{let c=this.actx.currentTime;t.offset.cancelScheduledValues(c),t.offset.setTargetAtTime(i,c,.01)}catch{t.offset.value=i}}setMidiSynth(a){this.midiSynth=a;let n=a&&(a.actx||a.audioContext);if(n&&n!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=n,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(i){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,i)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a){this.liveNodes.clear();let n=c=>{let l=c.kind,e=c.params||{},d=this.actx;if(!c.enabled){let r=d.createGain();return{in:r,out:r}}switch(l){case"ks_source":{let r=d.createGain();return this.liveNodes.set(c.id+":ksOut",r),this.liveNodes.set(c.id+":ksParams",e),this.liveNodes.set("__lastKsId__",c.id),this.liveNodes.set("keyboardTarget",r),{in:r,out:r}}case"source":{let r=d.createOscillator();r.type=e.type||"sawtooth";let N=d.createGain();return N.gain.value=0,r.connect(N),r.start(),this.liveNodes.set(c.id+":osc",r),this.liveNodes.set(c.id+":env",N),this.liveNodes.set(c.id+":oscType",r.type),this.liveNodes.set(c.id+":ch",e.ch??"all"),this.liveNodes.set(c.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",r.type),this.liveNodes.set("keyboardTarget",N),{in:N,out:N}}case"gain":{let r=this.actx.createGain();return r.gain.value=Number(e.gain??1),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}case"filter":{let r=d.createBiquadFilter();return r.type=e.mode||"lowpass",r.frequency.value=Number(e.freq||1200),r.Q.value=Number(e.q||.7),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}case"delay":{let r=d.createDelay(2);r.delayTime.value=Number(e.time||.25);let N=d.createGain();N.gain.value=Number(e.feedback||.3);let v=d.createGain();v.gain.value=Number(e.mix||.3);let k=d.createGain(),y=d.createGain(),g=d.createGain();return g.gain.value=1-v.gain.value,k.connect(r),k.connect(g),r.connect(N).connect(r),r.connect(v),g.connect(y),v.connect(y),this.liveNodes.set(c.id+":node",{input:k,output:y,delay:r,fb:N,mix:v}),{in:k,out:y}}case"analyzer":{let r=d.createGain();return r.connect(this.analyser),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}default:{let r=d.createGain();return{in:r,out:r}}}},t=null,i=null;for(let c of a){let{in:l,out:e}=n(c);t||(t=l),i&&i.connect(l),i=e}t&&this.liveNodes.set("__chainHead__",t),i&&this.liveNodes.set("__chainTail__",i);try{let l=a.find(d=>d.kind==="ks_source"||d.kind==="source")?.params?.ch??"all",e=l==="all"?Array.from({length:16},(d,r)=>r):[Number(l)];for(let d of e){let r=this.mixers[d];i&&r&&i.connect(r)}}catch(c){console.warn("[RC] mixer connect failed",c)}}buildMany(a){let t=this.liveNodes.get("__oscVoices__"),i=new Map;for(let c of a){let l=new Map;this.liveNodes=l,this.build(c);for(let[e,d]of l.entries())i.set(e,d)}t&&i.set("__oscVoices__",t),this.liveNodes=i}gate(a,n=.8,t=0,i=69){let c=this.actx.currentTime,l=(i??69)|0,e=!1;if(a){let d=this.pluckKS(t,i??69,n)===!0,r=this.gateOsc(t,i,n)===!0;e=d||r}if(a&&!e){let r=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(l-69)/12),N=[];for(let[_,w]of this.liveNodes.entries())if(_.endsWith(":oscType")){let C=_.split(":")[0],F=this.liveNodes.get(C+":ch")??"all",D=this.liveNodes.get(C+":adsr")||{a:.003,d:.08,s:.4,r:.2},R=w||"sawtooth";(F==="all"||Number(F)===t)&&N.push({modId:C,type:R,adsr:D})}if(!N.length){let _=this.liveNodes.get("__oscType__")||"sawtooth";N.push({modId:null,type:_,adsr:{a:.003,d:.08,s:.4,r:.2}})}let v=this.liveNodes.get("__chainTail__"),k=this.liveNodes.get("__chainHead__"),y=this.liveNodes.get("keyboardTarget"),g=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let p=this.liveNodes.get("__oscVoices__");p[t]||(p[t]={});for(let _ of N){let w=this.actx.createOscillator();try{w.type=_.type}catch{w.type="sawtooth"}w.frequency.setValueAtTime(r,c);try{let u=this.midiSynth?.chmod?.[t];u&&w.detune&&u.connect(w.detune);let x=this.getBendNode(t);w.detune&&x&&x.connect(w.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(u){console.warn("[RC] osc detune connect failed",u)}let C=this.actx.createGain();C.gain.setValueAtTime(0,c);let{a:F,d:D,s:R,r:U}=_.adsr;C.gain.linearRampToValueAtTime(n,c+(F??.003)),C.gain.linearRampToValueAtTime((R??.4)*n,c+(F??.003)+(D??.08)),w.connect(C);let o=null;if(k&&k!==y?o=k:v?o=v:g&&(o=g),!o&&g&&(o=g),o){C.connect(o);try{let u=this.mixers?.[t];if(v&&u)if(v.context===this.actx&&u.context===this.actx)v.connect(u);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let x=this.mixers?.[t];v.context===this.actx&&x?.context===this.actx&&v.connect(x)}catch{}}}catch(u){console.warn("[RC] mixer connect failed",u)}}w.start(c);let m=`${l}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;p[t][m]={note:l,osc:w,env:C,r:U??.2}}}if(!a){let d=this.actx.currentTime,r=this.liveNodes.get("__ksVoices__"),N=(this.midiSynth?.pedal?.[t]??0)>=64;if(r&&r[t]){let y=Object.entries(r[t]).filter(([g,p])=>p.note===l);for(let[g,p]of y){let{bfs:_,env:w}=p;if(N){p.sustained=!0;continue}try{let C=Number(p.params?.ksRelease??.5),F=.02,R=F+(1.5-F)*Math.pow(C,2);w.gain.cancelScheduledValues(d),w.gain.setValueAtTime(w.gain.value??1,d),w.gain.linearRampToValueAtTime(0,d+R),_.stop(d+R+.05),setTimeout(()=>{try{_.disconnect(),w.disconnect()}catch{}delete r[t][g]},(R+.05)*1e3)}catch{delete r[t][g]}}}let v=this.liveNodes.get("__oscVoices__");if(!v||!v[t])return;let k=Object.entries(v[t]).filter(([y,g])=>g.note===l);for(let[y,g]of k){let{osc:p,env:_,r:w=.2}=g;try{_.gain.cancelScheduledValues(d),_.gain.setValueAtTime(_.gain.value??0,d),_.gain.linearRampToValueAtTime(0,d+w),p.stop(d+w+.05),setTimeout(()=>{try{p.disconnect(),_.disconnect()}catch{}delete v[t][y]},(w+.1)*1e3)}catch{delete v[t][y]}}}}pluckKS(a,n,t){let i=Array.from(this.liveNodes.entries()).filter(([s])=>s.endsWith(":ksOut"));if(!i.length)return!1;let c=null,l={},e=[],d=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[s,f]of i){let V=this.liveNodes.get(s.replace(":ksOut",":ksParams"))||{},T=V.ch!=null?String(V.ch):"all",L=T==="all"||Number(T)===a,H=V.program;(H==null||H==="all")&&(H="all");let O=H==="all"?null:Number(H);L&&(O===null||O===d)&&(c||(c=[s,f],l=V),e.push(f))}if(!c)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:d}),!1;let r=c[0],N=c[1],v=l,y=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),g=this.actx.sampleRate,p=null;try{let s=String(v.seedNoiseType??"pink"),f=Math.max(2048,Math.round(g/Math.max(1e-6,y))),V=O=>{let B=new Float32Array(O);for(let G=0;G<O;G++)B[G]=Math.random()*2-1;return B},T=O=>{let B=new Float32Array(O),G=0,E=0,z=0,ee=0,te=0,ae=0,le=0;for(let ne=0;ne<O;ne++){let W=Math.random()*2-1;G=.99886*G+W*.0555179,E=.99332*E+W*.0750759,z=.969*z+W*.153852,ee=.8665*ee+W*.3104856,te=.55*te+W*.5329522,ae=-.7616*ae-W*.016898,B[ne]=(G+E+z+ee+te+ae+le*.5362)*.11,le=W*.115926}return B};s==="white"?p=V(f):s==="brown"?p=(O=>{let B=new Float32Array(O),G=0;for(let E=0;E<O;E++)G+=Math.random()*2-1,G>8&&(G=8),G<-8&&(G=-8),B[E]=G/8;return B})(f):s==="grey"||s==="gray"?p=(O=>{let B=V(O),G=T(O),E=new Float32Array(O);for(let z=0;z<O;z++)E[z]=.6*B[z]+.4*G[z];return E})(f):p=T(f)}catch(s){console.warn("[RC] seed build failed",s),p=null}if(console.log("[RC] seed check",p?.length,p?.[0]),!p||!p.length){console.warn("[RC] seed invalid, injecting pink noise");let s=Math.max(2048,Math.round(g/Math.max(1e-6,y)));p=new Float32Array(s);for(let f=0;f<s;f++)p[f]=Math.random()*2-1}let _=Number(v.ksDurSec);Number.isFinite(_)||(_=1),_=Math.min(Math.max(_,.1),10);let w=Math.round(g*_),C=this.actx.createBuffer(2,w,g),F=String(v.smoothingMode??"auto"),D=this.midiSynth?.options?.[a]??{},R;if(F==="manual"){let s=Number(v.smoothingFactor);Number.isFinite(s)||(s=.2),s<.01&&(s=.01),s>.99&&(s=.99),R=s}else try{let s=this.midiSynth?.inv127??.007874015748031496,f=Math.pow(n/64,.5)||0,V=n*s*.85+.15;typeof D.stringDamping=="number"?V=D.stringDamping:this.midiSynth?.options?.[a]&&(this.midiSynth.options[a].stringDamping=V);let T=Number(D.stringDampingVariation??0);R=V+f*(1-V)*.5+(1-V)*Math.random()*T}catch{R=.2}Number.isFinite(R)||(R=.2);let U=Number(v.velScale==null?1:v.velScale);if(Object.keys(D).length===0&&(D.stringDamping=.5,D.stringDampingVariation=.2),Number.isFinite(R)||(R=.2),!p||!p.length){console.warn("[RC] seed invalid, injecting pink noise");let s=Math.max(2048,Math.round(g/Math.max(1e-6,y)));p=new Float32Array(s);for(let f=0;f<s;f++)p[f]=Math.random()*2-1}try{let s=this.midiSynth?.asmWrapper?.[a];s&&typeof s.pluck=="function"&&s.pluck(C,p,g,y,R,t*U,D,.2)}catch(s){console.warn("[RC] pluck error",s)}let o=this.actx.createBufferSource();o.buffer=C;try{let s=this.midiSynth?.chmod?.[a];s&&o.detune&&s.connect(o.detune)}catch{}try{let s=this.midiSynth?.bend?.[a];typeof s=="number"&&o.detune&&(o.detune.value=s)}catch{}let m=this.actx.createGain();m.gain.setValueAtTime(1,this.actx.currentTime),this.liveNodes.has("__ksVoices__")||this.liveNodes.set("__ksVoices__",{});let u=this.liveNodes.get("__ksVoices__");u[a]||(u[a]={});let x=`${n}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;u[a][x]={note:n,bfs:o,env:m,params:v,sustained:!1},o.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[n]===o&&(this.midiSynth.bfSet[a][n]=null)}catch{}try{let s=this.liveNodes.get("__ksVoices__");s&&s[a]&&s[a][x]&&delete s[a][x]}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][n]=o}catch{}try{let s=r.replace(":ksOut",":tail"),f=this.liveNodes.get(s)||this.liveNodes.get("__chainTail__"),V=this.midiSynth?.chvol?.[a];try{let T=this.mixers?.[a];if(f&&T)if(f.context===this.actx&&T.context===this.actx)f.connect(T);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let L=this.mixers?.[a];f.context===this.actx&&L?.context===this.actx&&f.connect(L)}catch{}}}catch(T){console.warn("[RC] mixer connect failed",T)}}catch{}o.connect(m);for(let s of e)try{m.connect(s)}catch(f){console.warn("[RC] env.connect ksOut failed",f)}return o.start(),!0}gateOsc(a,n,t){let i=Array.from(this.liveNodes.entries()).filter(([N])=>N.endsWith(":osc"));if(!i.length)return!1;let c=!1,l=(n??69)|0,e=this.actx.currentTime,r=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(l-69)/12);for(let[N,v]of i){let k=N.replace(":osc",""),y=this.liveNodes.get(k+":ch")??"all";if(!(y==="all"||Number(y)===a))continue;let p=this.liveNodes.get(k+":env"),_=this.liveNodes.get(k+":adsr")||{a:.003,d:.08,s:.4,r:.2};if(!p)continue;try{v.frequency.setValueAtTime(r,e)}catch{}let{a:w,d:C,s:F,r:D}=_;p.gain.cancelScheduledValues(e),p.gain.setValueAtTime(0,e),p.gain.linearRampToValueAtTime(t,e+(w??.003)),p.gain.linearRampToValueAtTime((F??.4)*t,e+(w??.003)+(C??.08)),p.gain.linearRampToValueAtTime(0,e+(w??.003)+(C??.08)+(D??.2)),c=!0}return c}releaseSustainKSForChannel(a){let n=this.actx.currentTime,t=this.liveNodes.get("__ksVoices__");if(!(!t||!t[a]))for(let[i,c]of Object.entries(t[a])){if(!c.sustained)continue;let{bfs:l,env:e,params:d}=c,r=Number(d?.ksRelease??.5),N=.02,k=N+(1.5-N)*Math.pow(r,2);e.gain.cancelScheduledValues(n),e.gain.setValueAtTime(e.gain.value??1,n),e.gain.linearRampToValueAtTime(0,n+k),l.stop(n+k+.05),c.sustained=!1,setTimeout(()=>{try{l.disconnect(),e.disconnect()}catch{}delete t[a][i]},(k+.05)*1e3)}}};import{Fragment as pe,jsx as M,jsxs as I}from"react/jsx-runtime";var $="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var me=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],Q={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:"all"},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function j(b="m"){return`${b}_${Math.random().toString(36).slice(2,9)}`}function he(b,a,n){let t=b.slice(),i=Math.max(0,Math.min(t.length-1,a)),c=t.splice(i,1)[0],l=Math.max(0,Math.min(t.length,n));return t.splice(l,0,c),t}function oe({synth:b}){let a=xe(null);a.current||(a.current=new Y);let n=a.current;Z(()=>{if(b&&typeof n.setMidiSynth=="function")try{n.setMidiSynth(b),console.log("[RC] midi_synth attached to engine")}catch(o){console.warn("[RC] setMidiSynth failed",o)}},[b]),Z(()=>(window.__RC_HANDLE__={midi:o=>{try{n.handleMIDIMsg&&n.handleMIDIMsg(o),console.log("[RC] MIDI -> engine",o)}catch(m){console.warn("[RC] MIDI ingress failed",m)}},engine:n},()=>{try{delete window.__RC_HANDLE__}catch{}}),[n]);let[t,i]=se([[{id:j("ks"),kind:"ks_source",enabled:!0,params:{...Q.ks_source}},{id:j("gain"),kind:"gain",enabled:!0,params:{...Q.gain}},{id:j("an"),kind:"analyzer",enabled:!0,params:{}}]]),[c,l]=se({open:!1,idx:null,step:1}),e=o=>l({open:!0,idx:o,step:1}),d=()=>l({open:!1,idx:null,step:1}),r=()=>l(o=>({...o,step:2})),N=()=>{i(o=>{let m=o.filter((u,x)=>x!==c.idx);return m.length?m:[[{id:j("src"),kind:"source",enabled:!0,params:{...Q.source}},{id:j("gain"),kind:"gain",enabled:!0,params:{...Q.gain}},{id:j("an"),kind:"analyzer",enabled:!0,params:{}}]]}),d()};Z(()=>{try{n.buildMany(t),n.resume&&n.resume()}catch(o){console.warn("[RC] buildMany failed",o)}},[JSON.stringify(t)]),Z(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(o=>{for(let m of o.inputs.values())m.onmidimessage=u=>n.handleMIDIMsg(u.data)})},[]);let v=(o,m)=>i(u=>{let x=u.map(s=>[...s]);return x[o]=[...x[o],{id:j(m),kind:m,enabled:!0,params:{...Q[m]}}],x}),k=(o,m)=>i(u=>u.map((x,s)=>s!==o?x:x.map(f=>f.id===m?{...f,enabled:!f.enabled}:f))),y=(o,m)=>i(u=>u.map((x,s)=>s!==o?x:x.filter(f=>f.id!==m))),g=(o,m,u,x)=>{u==="gain"&&(n.updateGainNodeById(m,x)||console.warn("[RC] gain node not found for id:",m)),i(s=>s.map((f,V)=>V!==o?f:f.map(T=>T.id===m?{...T,params:{...T.params,[u]:x}}:T)))},[p,_]=se(null),w=(o,m)=>u=>{_({chain:o,from:m}),u.dataTransfer.effectAllowed="move",u.dataTransfer.setData("text/plain",`${o}:${m}`)},C=(o,m)=>u=>{u.preventDefault(),!(!p||p.chain!==o)&&(i(x=>x.map((s,f)=>f!==o?s:he(s,p.from,m))),_(null))},F=o=>m=>{m.preventDefault(),!(!p||p.chain!==o)&&(i(u=>u.map((x,s)=>s!==o?x:he(x,p.from,x.length))),_(null))},D=o=>i(m=>{let u=m.map(s=>[...s]),x=u[o].map(s=>({...s,id:j(s.kind)}));return u.splice(o+1,0,x),u}),R=()=>{let o=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),m=URL.createObjectURL(o),u=document.createElement("a");u.href=m,u.download="audio-chains.json",u.click(),URL.revokeObjectURL(m)},U=async o=>{let m=await o.text();try{let u=JSON.parse(m);Array.isArray(u)&&Array.isArray(u[0])&&i(u)}catch(u){console.warn("Invalid chain JSON",u)}};return I("div",{className:"p-6 text-white",children:[M("div",{className:"flex items-center justify-between mb-4",children:I("div",{className:"flex items-center gap-2 flex-wrap",children:[me.map(o=>I("button",{className:$,onClick:()=>v(0,o),children:["+ ",o]},`add-${o}`)),M("button",{className:$,onClick:()=>n.resume(),children:"Resume Audio"}),M("button",{className:$,onClick:R,children:"Export"}),I("label",{className:`${$} cursor-pointer`,children:["Import",M("input",{type:"file",accept:"application/json",className:"hidden",onChange:o=>{let m=o.target.files?.[0];m&&U(m)}})]}),M("button",{className:$,onClick:()=>{typeof n.buildMultiFrom=="function"?n.buildMultiFrom(t[0],Array.from({length:16},(o,m)=>m)):i(o=>{let m=o[0]||[];return Array.from({length:16},(x,s)=>m.map(f=>({...f,id:j(f.kind)+`_ch${s}`,params:f.kind==="ks_source"?{...f.params,ch:String(s)}:{...f.params}})))})},children:"Duplicate to 16 channels"})]})}),M("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:t.map((o,m)=>I("div",{className:"mb-6",children:[I("div",{className:"flex items-center justify-between mb-2",children:[I("div",{className:"text-sm opacity-80",children:["Chain #",m+1]}),I("div",{className:"flex gap-2",children:[M("button",{className:$,onClick:()=>D(m),children:"Duplicate chain"}),M("button",{className:$,onClick:()=>e(m),children:"Delete chain"})]})]}),I("div",{className:"flex gap-3 items-stretch",children:[o.map((u,x)=>M("div",{draggable:!0,onDragStart:w(m,x),onDrop:C(m,x),onDragOver:s=>s.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:M(ie,{mod:u,onToggle:()=>k(m,u.id),onRemove:()=>y(m,u.id),onParam:(s,f)=>g(m,u.id,s,f)})},u.id)),M("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:u=>u.preventDefault(),onDrop:F(m),children:"\u2192"})]}),M("div",{className:"mt-3 flex flex-wrap gap-2",children:me.map(u=>I("button",{className:$,onClick:()=>v(m,u),children:["+ ",u]},`${m}-${u}`))})]},m))}),c.open&&M("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:M("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:c.step===1?I(pe,{children:[M("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),M("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),I("div",{className:"flex justify-end gap-2",children:[M("button",{className:$,onClick:d,children:"Cancel"}),M("button",{className:$,onClick:r,children:"Next"})]})]}):I(pe,{children:[M("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),M("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),I("div",{className:"flex justify-end gap-2",children:[M("button",{className:$,onClick:d,children:"Cancel"}),M("button",{className:$,onClick:N,children:"Delete"})]})]})})})]})}import{jsx as q,jsxs as K}from"react/jsx-runtime";function X({synth:b,buttonTarget:a,autoTailwind:n=!1}){let[t,i]=re(!1);P(()=>{if(!t)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(g){console.warn("[RC] resumeAll failed",g)}})()},[t]);let[c,l]=re(.3),[e,d]=re(()=>b?.a4_freq??440);P(()=>{typeof b?.a4_freq=="number"&&d(Number(b.a4_freq))},[b]),P(()=>{let y=e,g=setInterval(()=>{let p=Number(b?.a4_freq??440);!Number.isNaN(p)&&p!==y&&(y=p,d(p))},250);return()=>clearInterval(g)},[b,e]);let r=420,v=Math.max(0,Math.min(1,(e-r)/(460-r)))*100;P(()=>{if(!n||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let g=document.createElement("script");g.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",g.dataset.rcTailwind="1",document.head.appendChild(g)},[n]);let k=()=>q("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>i(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return K("div",{children:[q("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),a?ye.createPortal(q(k,{}),a):q("div",{className:"rc-fixed-default",children:q(k,{})}),q("div",{className:"rc-overlay",style:{display:t?"flex":"none"},onClick:y=>{y.target===y.currentTarget&&i(!1)},children:K("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[K("div",{className:"rc-header",children:[K("div",{className:"flex items-center gap-4",children:[q("div",{children:"Routing Composer"}),K("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[q("span",{children:"A4"}),q("input",{type:"range",min:"420",max:"460",step:"0.1",value:e,className:"rc-slider",style:{"--rc-pos":`${(e-420)/40*100}%`,width:160},onChange:y=>{let g=Number(y.target.value);Number.isNaN(g)||(d(g),b&&(b.a4_freq=g))}}),K("span",{children:[e.toFixed(1),"Hz"]})]}),K("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[q("span",{children:"Vol"}),q("input",{type:"range",min:"0",max:"1",step:"0.01",value:c,className:"rc-slider",style:{"--rc-pos":`${c*100}%`,width:160},onChange:y=>{let g=Number(y.target.value);Number.isNaN(g)||(l(g),midi_synth&&midi_synth.setMasterVol(g))}}),K("span",{children:[(c*100).toFixed(0),"%"]})]})]}),K("div",{className:"flex items-center gap-2",children:[q("button",{className:"rc-close",onClick:()=>b?.actx?.resume?.(),children:"Resume Audio"}),q("button",{className:"rc-close",onClick:()=>i(!1),children:"Close"})]})]}),q("div",{className:"rc-body",children:q(oe,{synth:b})})]})})]})}import{jsx as fe}from"react/jsx-runtime";var He=X;(function(){if(typeof window>"u")return;let a={mount(n={}){let{synth:t,button:i,tailwind:c="auto"}=n,l=null;i&&(typeof i=="string"?l=document.querySelector(i):i instanceof HTMLElement&&(l=i));let e=document.createElement("div");return document.body.appendChild(e),ce.createRoot?ce.createRoot(e).render(fe(X,{synth:t,buttonTarget:l,autoTailwind:c==="auto"})):ce.render(fe(X,{synth:t,buttonTarget:l,autoTailwind:c==="auto"}),e),console.log("[RoutingComposer] mounted GUI"),{host:e}}};window.RoutingComposer=a})();export{He as default};
