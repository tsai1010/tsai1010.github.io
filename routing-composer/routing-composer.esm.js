var oe=Object.defineProperty;var re=(p,a,i)=>a in p?oe(p,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):p[a]=i;var Z=(p,a,i)=>re(p,typeof a!="symbol"?a+"":a,i);import"react";import Y from"react-dom";import{useEffect as ie,useState as ne}from"react";import de from"react-dom";import{useEffect as H,useState as Q,useRef as le}from"react";import"react";import{Fragment as B,jsx as u,jsxs as S}from"react/jsx-runtime";var ce="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",P="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function G({label:p,min:a,max:i,step:t=.01,value:n,onChange:d,suffix:l}){let e=typeof n=="number"?(Math.round(n*100)/100).toFixed(2):String(n??""),h=Number(n??0),r=Number(a??0),v=Number(i??1),x=Math.max(0,Math.min(1,(h-r)/(v-r)))*100;return S("div",{className:"flex items-center gap-3",children:[u("div",{className:"w-24 text-sm opacity-80",children:p}),u("input",{type:"range",className:"w-48 rc-slider",min:a,max:i,step:t,value:Number(n??0),onChange:y=>d(Number(y.target.value)),style:{"--rc-pos":`${x}%`}}),S("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[e,l?u("span",{className:"opacity-60",children:l}):null]})]})}function W({mod:p,onToggle:a,onRemove:i,onParam:t}){let{kind:n,enabled:d,params:l={}}=p;return S("div",{className:`${ce} w-[280px]`,children:[S("div",{className:"flex items-center justify-between",children:[u("div",{className:"font-semibold capitalize",children:n}),S("div",{className:"flex gap-2",children:[u("button",{className:P,onClick:a,children:d?"Bypass":"Enable"}),u("button",{className:P,onClick:i,title:"Remove module",children:"\xD7"})]})]}),u("div",{className:"mt-2 text-xs opacity-70",children:d?"active":"bypassed"}),S("div",{className:"mt-3 space-y-2",children:[n==="ks_source"&&S(B,{children:[S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),S("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(l.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,h)=>u("option",{value:String(h),children:h},h))]})]}),S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"Program"}),u("input",{type:"number",min:0,max:127,className:"bg-transparent border border-white/10 rounded-lg px-2 py-1 w-24",value:Number(l.program??0),onChange:e=>t("program",Number(e.target.value))})]}),S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(l.smoothingMode??"auto"),onChange:e=>t("smoothingMode",e.target.value),children:["auto","manual"].map(e=>u("option",{value:e,children:e},e))})]}),String(l.smoothingMode??"auto")==="manual"&&u(G,{label:"smooth",min:0,max:1,value:Number(l.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),u(G,{label:"velScale",min:0,max:1,value:Number(l.velScale??1),onChange:e=>t("velScale",e)}),S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"seed"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(l.seedNoiseType??"pink"),onChange:e=>t("seedNoiseType",e.target.value),children:["pink","white","synthPink"].map(e=>u("option",{value:e,children:e},e))})]}),String(l.smoothingMode??"auto")==="auto"&&u("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / stringDampingVariation \u8207 note \u8A08\u7B97"})]}),n==="source"&&S(B,{children:[S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),S("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(p.params.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,h)=>u("option",{value:String(h),children:h},h))]})]}),S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"wave"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(p.params.type),onChange:e=>t("type",e.target.value),children:["sine","square","sawtooth","triangle"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"attack",min:0,max:.2,value:Number(p.params.adsr?.a??.003),onChange:e=>t("adsr",{...p.params.adsr||{},a:e})}),u(G,{label:"decay",min:0,max:1,value:Number(p.params.adsr?.d??.08),onChange:e=>t("adsr",{...p.params.adsr||{},d:e})}),u(G,{label:"sustain",min:0,max:1,value:Number(p.params.adsr?.s??.4),onChange:e=>t("adsr",{...p.params.adsr||{},s:e})}),u(G,{label:"release",min:0,max:2,value:Number(p.params.adsr?.r??.2),onChange:e=>t("adsr",{...p.params.adsr||{},r:e})})]}),n==="filter"&&S(B,{children:[S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"mode"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(l.mode??"lowpass"),onChange:e=>t("mode",e.target.value),children:["lowpass","highpass","bandpass","notch"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"freq",min:50,max:12e3,value:Number(l.freq??1200),onChange:e=>t("freq",e)}),u(G,{label:"Q",min:.1,max:20,value:Number(l.q??.7),onChange:e=>t("q",e)})]}),n==="delay"&&S(B,{children:[u(G,{label:"time",min:.01,max:1.2,value:Number(l.time??.25),onChange:e=>t("time",e)}),u(G,{label:"feedback",min:0,max:.95,value:Number(l.feedback??.35),onChange:e=>t("feedback",e)}),u(G,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),n==="reverb"&&S(B,{children:[u(G,{label:"decay",min:.2,max:6,value:Number(l.decay??2),onChange:e=>t("decay",e)}),u(G,{label:"mix",min:0,max:1,value:Number(l.mix??.25),onChange:e=>t("mix",e)})]}),n==="convolver_ir"&&S(B,{children:[S("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"IR"}),u("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(l.irId??"IR_Gibson"),onChange:e=>t("irId",e.target.value),children:["IR_Gibson","IR_piezo"].map(e=>u("option",{value:e,children:e},e))})]}),u(G,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),n==="gain"&&u(G,{label:"gain",min:0,max:1.5,value:Number(l.gain??.8),onChange:e=>t("gain",e)}),n==="analyzer"&&u("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var U=class{constructor(a){Z(this,"handleMIDIMsg",a=>{let i=a[0],t=a[1],n=a[2],d=i&240,l=i&15;d===144&&n>0?this.gate(!0,n/127,l,t):(d===128||d===144&&n===0)&&this.gate(!1,0,l,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let i=this.actx.createGain();return i.gain.value=1,i}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let i=0;i<16;i++)try{this.mixers[i].connect(this.midiSynth.chvol[i]),console.log(`[RC] mixer[ch${i}] -> chvol[ch${i}]`)}catch(t){console.warn(`[RC] mixer[ch${i}] connect failed`,t)}},1e3)}updateGainNodeById(a,i){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let n=this.actx.currentTime;try{t.gain.cancelScheduledValues(n),t.gain.setTargetAtTime(Number(i)||0,n,.01)}catch{t.gain.value=Number(i)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let i=this.actx.createConstantSource();return i.offset.value=0,i.start(),this._bendCS[a]=i,i}updateBend(a,i){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),n=Number.isFinite(i)?i:0;try{let d=this.actx.currentTime;t.offset.cancelScheduledValues(d),t.offset.setTargetAtTime(n,d,.01)}catch{t.offset.value=n}}setMidiSynth(a){this.midiSynth=a;let i=a&&(a.actx||a.audioContext);if(i&&i!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=i,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(n){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,n)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a){this.liveNodes.clear();let i=d=>{let l=d.kind,e=d.params||{},h=this.actx;if(!d.enabled){let r=h.createGain();return{in:r,out:r}}switch(l){case"ks_source":{let r=h.createGain();return this.liveNodes.set(d.id+":ksOut",r),this.liveNodes.set(d.id+":ksParams",e),this.liveNodes.set("__lastKsId__",d.id),this.liveNodes.set("keyboardTarget",r),{in:r,out:r}}case"source":{let r=h.createOscillator();r.type=e.type||"sawtooth";let v=h.createGain();return v.gain.value=0,r.connect(v),r.start(),this.liveNodes.set(d.id+":osc",r),this.liveNodes.set(d.id+":env",v),this.liveNodes.set(d.id+":oscType",r.type),this.liveNodes.set(d.id+":ch",e.ch??"all"),this.liveNodes.set(d.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",r.type),this.liveNodes.set("keyboardTarget",v),{in:v,out:v}}case"gain":{let r=this.actx.createGain();return r.gain.value=Number(e.gain??1),this.liveNodes.set(d.id+":node",r),{in:r,out:r}}case"filter":{let r=h.createBiquadFilter();return r.type=e.mode||"lowpass",r.frequency.value=Number(e.freq||1200),r.Q.value=Number(e.q||.7),this.liveNodes.set(d.id+":node",r),{in:r,out:r}}case"delay":{let r=h.createDelay(2);r.delayTime.value=Number(e.time||.25);let v=h.createGain();v.gain.value=Number(e.feedback||.3);let x=h.createGain();x.gain.value=Number(e.mix||.3);let y=h.createGain(),C=h.createGain(),N=h.createGain();return N.gain.value=1-x.gain.value,y.connect(r),y.connect(N),r.connect(v).connect(r),r.connect(x),N.connect(C),x.connect(C),this.liveNodes.set(d.id+":node",{input:y,output:C,delay:r,fb:v,mix:x}),{in:y,out:C}}case"analyzer":{let r=h.createGain();return r.connect(this.analyser),this.liveNodes.set(d.id+":node",r),{in:r,out:r}}default:{let r=h.createGain();return{in:r,out:r}}}},t=null,n=null;for(let d of a){let{in:l,out:e}=i(d);t||(t=l),n&&n.connect(l),n=e}t&&this.liveNodes.set("__chainHead__",t),n&&this.liveNodes.set("__chainTail__",n);try{let l=a.find(h=>h.kind==="ks_source"||h.kind==="source")?.params?.ch??"all",e=l==="all"?Array.from({length:16},(h,r)=>r):[Number(l)];for(let h of e){let r=this.mixers[h];n&&r&&n.connect(r)}}catch(d){console.warn("[RC] mixer connect failed",d)}n&&m.kind==="gain"&&n.connect(this.mixers[ch])}buildMany(a){this.liveNodes.clear();let i=this.liveNodes,t=n=>{let d=new Map;this.liveNodes=d,this.build(n);for(let[l,e]of this.liveNodes.entries())i.set(l,e);this.liveNodes=i};a.forEach(t)}gate(a,i=.8,t=0,n=69){let d=this.actx.currentTime,l=!1;if(a&&(l=this.pluckKS(t,n??69,i)),a&&!l){let h=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),r=this.actx.currentTime,v=[];for(let[T,D]of this.liveNodes.entries())if(T.endsWith(":oscType")){let A=T.split(":")[0],M=this.liveNodes.get(A+":ch")??"all",b=this.liveNodes.get(A+":adsr")||{a:.003,d:.08,s:.4,r:.2},_=D||"sawtooth";(M==="all"||Number(M)===t)&&v.push({modId:A,type:_,adsr:b})}if(!v.length){let T=this.liveNodes.get("__oscType__")||"sawtooth";v.push({modId:null,type:T,adsr:{a:.003,d:.08,s:.4,r:.2}})}let x=this.liveNodes.get("__chainTail__"),y=this.liveNodes.get("__chainHead__"),C=this.liveNodes.get("keyboardTarget"),N=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let q=this.liveNodes.get("__oscVoices__");q[t]||(q[t]={});for(let T of v){let D=this.actx.createOscillator();try{D.type=T.type}catch{D.type="sawtooth"}D.frequency.setValueAtTime(h,r);try{let c=this.midiSynth?.chmod?.[t];c&&D.detune&&c.connect(D.detune);let g=this.getBendNode(t);D.detune&&g&&g.connect(D.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(c){console.warn("[RC] osc detune connect failed",c)}let A=this.actx.createGain();A.gain.setValueAtTime(0,r);let{a:M,d:b,s:_,r:R}=T.adsr;A.gain.linearRampToValueAtTime(i,r+(M??.003)),A.gain.linearRampToValueAtTime((_??.4)*i,r+(M??.003)+(b??.08)),D.connect(A);let s=null;if(y&&y!==C?s=y:x?s=x:N&&(s=N),!s&&N&&(s=N),s){A.connect(s);try{let c=`__tail_to_chvol_${t}__`;try{let g=this.mixers?.[t];if(x&&g)if(x.context===this.actx&&g.context===this.actx)x.connect(g);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let f=this.mixers?.[t];x.context===this.actx&&f?.context===this.actx&&x.connect(f)}catch{}}}catch(g){console.warn("[RC] mixer connect failed",g)}}catch{}}D.start(r);let o=`${n}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;q[t][o]={note:n,osc:D,env:A,r:R??.2}}}if(!a){let e=this.actx.currentTime,h=this.liveNodes.get("__oscVoices__");if(!h||!h[t])return;let r=Object.entries(h[t]).filter(([v,x])=>x.note===n);for(let[v,x]of r){let{osc:y,env:C,r:N=.2}=x;try{C.gain.cancelScheduledValues(e),C.gain.setValueAtTime(C.gain.value??0,e),C.gain.linearRampToValueAtTime(0,e+N),y.stop(e+N+.05),setTimeout(()=>{try{y.disconnect(),C.disconnect()}catch{}delete h[t][v]},(N+.1)*1e3)}catch{delete h[t][v]}}}}pluckKS(a,i,t){let n=Array.from(this.liveNodes.entries()).filter(([b])=>b.endsWith(":ksOut"));if(!n.length)return!1;let d=null,l={},e=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[b,_]of n){let R=this.liveNodes.get(b.replace(":ksOut",":ksParams"))||{},s=R.ch!=null?R.ch:"all",o=Number(R.program!=null?R.program:0);if((s==="all"||Number(s)===a)&&o===e){d=[b,_],l=R;break}}if(!d)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:e}),!1;let h=d[0],r=d[1],v=l,y=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(i-69)/12),C=this.actx.sampleRate,N;try{if(v.seedNoiseType==="synthPink"&&this.midiSynth&&typeof this.midiSynth.generateSeedPinkNoise=="function"){let b=Math.max(1,Math.round(C/Math.max(1e-6,y)));N=this.midiSynth.generateSeedPinkNoise(65535,b)}else{let b=Math.max(2048,Math.round(C/Math.max(1e-6,y)));N=((R=4096)=>{let s=new Float32Array(R),o=0,c=0,g=0,f=0,w=0,j=0,E=0;for(let J=0;J<R;J++){let F=Math.random()*2-1;o=.99886*o+F*.0555179,c=.99332*c+F*.0750759,g=.969*g+F*.153852,f=.8665*f+F*.3104856,w=.55*w+F*.5329522,j=-.7616*j-F*.016898,s[J]=(o+c+g+f+w+j+E*.5362)*.11,E=F*.115926}return s})(b)}}catch{}console.log("[RC] seed check",N?.length,N?.[0]);let q=this.actx.createBuffer(2,C,C),T=.2;try{let b=this.midiSynth?.inv127??.007874015748031496,_=Math.pow(i/64,.5)||0,R=i*b*.85+.15,s=Number(this.midiSynth?.options?.[a]?.stringDampingVariation??0);T=R+_*(1-R)*.5+(1-R)*Math.random()*s}catch{}let D=Number(v.velScale==null?1:v.velScale),A=this.midiSynth?.options?.[a]??{};if(Object.keys(A).length===0&&(A.stringDamping=.5,A.stringDampingVariation=.2),Number.isFinite(T)||(T=.2),!N||!N.length){console.warn("[RC] seed invalid, injecting pink noise");let b=Math.max(2048,Math.round(C/Math.max(1e-6,y)));N=new Float32Array(b);for(let _=0;_<b;_++)N[_]=Math.random()*2-1}try{let b=this.midiSynth?.asmWrapper?.[a],_=this.midiSynth?.options?.[a]??{};b&&typeof b.pluck=="function"&&b.pluck(q,N,C,y,T,t*D,_,.2)}catch(b){console.warn("[RC] pluck error",b)}let M=this.actx.createBufferSource();M.buffer=q;try{let b=this.midiSynth?.chmod?.[a];b&&M.detune&&b.connect(M.detune)}catch{}try{let b=this.midiSynth?.bend?.[a];typeof b=="number"&&M.detune&&(M.detune.value=b)}catch{}M.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[i]===M&&(this.midiSynth.bfSet[a][i]=null)}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][i]=M}catch{}try{let b=h.replace(":ksOut",":tail"),_=this.liveNodes.get(b)||this.liveNodes.get("__chainTail__"),R=this.midiSynth?.chvol?.[a],s=`__tail_to_chvol_${a}__`;try{let o=this.mixers?.[a];if(_&&o)if(_.context===this.actx&&o.context===this.actx)_.connect(o);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let c=this.mixers?.[a];_.context===this.actx&&c?.context===this.actx&&_.connect(c)}catch{}}}catch(o){console.warn("[RC] mixer connect failed",o)}}catch{}return M.connect(r),M.start(),!0}};import{Fragment as ae,jsx as k,jsxs as O}from"react/jsx-runtime";var I="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var ee=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],L={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:0},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function V(p="m"){return`${p}_${Math.random().toString(36).slice(2,9)}`}function te(p,a,i){let t=p.slice(),n=Math.max(0,Math.min(t.length-1,a)),d=t.splice(n,1)[0],l=Math.max(0,Math.min(t.length,i));return t.splice(l,0,d),t}function X({synth:p}){let a=le(null);a.current||(a.current=new U);let i=a.current;H(()=>{if(p&&typeof i.setMidiSynth=="function")try{i.setMidiSynth(p),console.log("[RC] midi_synth attached to engine")}catch(s){console.warn("[RC] setMidiSynth failed",s)}},[p]),H(()=>(window.__RC_HANDLE__={midi:s=>{try{i.handleMIDIMsg&&i.handleMIDIMsg(s),console.log("[RC] MIDI -> engine",s)}catch(o){console.warn("[RC] MIDI ingress failed",o)}},engine:i},()=>{try{delete window.__RC_HANDLE__}catch{}}),[i]);let[t,n]=Q([[{id:V("src"),kind:"source",enabled:!0,params:{...L.source}},{id:V("gain"),kind:"gain",enabled:!0,params:{...L.gain}},{id:V("an"),kind:"analyzer",enabled:!0,params:{}}]]),[d,l]=Q({open:!1,idx:null,step:1}),e=s=>l({open:!0,idx:s,step:1}),h=()=>l({open:!1,idx:null,step:1}),r=()=>l(s=>({...s,step:2})),v=()=>{n(s=>{let o=s.filter((c,g)=>g!==d.idx);return o.length?o:[[{id:V("src"),kind:"source",enabled:!0,params:{...L.source}},{id:V("gain"),kind:"gain",enabled:!0,params:{...L.gain}},{id:V("an"),kind:"analyzer",enabled:!0,params:{}}]]}),h()};H(()=>{try{i.buildMany(t),i.resume&&i.resume()}catch(s){console.warn("[RC] buildMany failed",s)}},[JSON.stringify(t)]),H(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(s=>{for(let o of s.inputs.values())o.onmidimessage=c=>i.handleMIDIMsg(c.data)})},[]);let x=(s,o)=>n(c=>{let g=c.map(f=>[...f]);return g[s]=[...g[s],{id:V(o),kind:o,enabled:!0,params:{...L[o]}}],g}),y=(s,o)=>n(c=>c.map((g,f)=>f!==s?g:g.map(w=>w.id===o?{...w,enabled:!w.enabled}:w))),C=(s,o)=>n(c=>c.map((g,f)=>f!==s?g:g.filter(w=>w.id!==o))),N=(s,o,c,g)=>{c==="gain"&&(i.updateGainNodeById(o,g)||console.warn("[RC] gain node not found for id:",o)),n(f=>f.map((w,j)=>j!==s?w:w.map(E=>E.id===o?{...E,params:{...E.params,[c]:g}}:E)))},[q,T]=Q(null),D=(s,o)=>c=>{T({chain:s,from:o}),c.dataTransfer.effectAllowed="move",c.dataTransfer.setData("text/plain",`${s}:${o}`)},A=(s,o)=>c=>{c.preventDefault(),!(!q||q.chain!==s)&&(n(g=>g.map((f,w)=>w!==s?f:te(f,q.from,o))),T(null))},M=s=>o=>{o.preventDefault(),!(!q||q.chain!==s)&&(n(c=>c.map((g,f)=>f!==s?g:te(g,q.from,g.length))),T(null))},b=s=>n(o=>{let c=o.map(f=>[...f]),g=c[s].map(f=>({...f,id:V(f.kind)}));return c.splice(s+1,0,g),c}),_=()=>{let s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(s),c=document.createElement("a");c.href=o,c.download="audio-chains.json",c.click(),URL.revokeObjectURL(o)},R=async s=>{let o=await s.text();try{let c=JSON.parse(o);Array.isArray(c)&&Array.isArray(c[0])&&n(c)}catch(c){console.warn("Invalid chain JSON",c)}};return O("div",{className:"p-6 text-white",children:[k("div",{className:"flex items-center justify-between mb-4",children:O("div",{className:"flex items-center gap-2 flex-wrap",children:[ee.map(s=>O("button",{className:I,onClick:()=>x(0,s),children:["+ ",s]},`add-${s}`)),k("button",{className:I,onClick:()=>i.resume(),children:"Resume Audio"}),k("button",{className:I,onClick:_,children:"Export"}),O("label",{className:`${I} cursor-pointer`,children:["Import",k("input",{type:"file",accept:"application/json",className:"hidden",onChange:s=>{let o=s.target.files?.[0];o&&R(o)}})]}),k("button",{className:I,onClick:()=>{typeof i.buildMultiFrom=="function"?i.buildMultiFrom(t[0],Array.from({length:16},(s,o)=>o)):n(s=>{let o=s[0]||[];return Array.from({length:16},(g,f)=>o.map(w=>({...w,id:V(w.kind)+`_ch${f}`,params:w.kind==="ks_source"?{...w.params,ch:String(f)}:{...w.params}})))})},children:"Duplicate to 16 channels"})]})}),k("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:t.map((s,o)=>O("div",{className:"mb-6",children:[O("div",{className:"flex items-center justify-between mb-2",children:[O("div",{className:"text-sm opacity-80",children:["Chain #",o+1]}),O("div",{className:"flex gap-2",children:[k("button",{className:I,onClick:()=>b(o),children:"Duplicate chain"}),k("button",{className:I,onClick:()=>e(o),children:"Delete chain"})]})]}),O("div",{className:"flex gap-3 items-stretch",children:[s.map((c,g)=>k("div",{draggable:!0,onDragStart:D(o,g),onDrop:A(o,g),onDragOver:f=>f.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:k(W,{mod:c,onToggle:()=>y(o,c.id),onRemove:()=>C(o,c.id),onParam:(f,w)=>N(o,c.id,f,w)})},c.id)),k("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:c=>c.preventDefault(),onDrop:M(o),children:"\u2192"})]}),k("div",{className:"mt-3 flex flex-wrap gap-2",children:ee.map(c=>O("button",{className:I,onClick:()=>x(o,c),children:["+ ",c]},`${o}-${c}`))})]},o))}),d.open&&k("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:k("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:d.step===1?O(ae,{children:[k("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),k("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),O("div",{className:"flex justify-end gap-2",children:[k("button",{className:I,onClick:h,children:"Cancel"}),k("button",{className:I,onClick:r,children:"Next"})]})]}):O(ae,{children:[k("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),k("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),O("div",{className:"flex justify-end gap-2",children:[k("button",{className:I,onClick:h,children:"Cancel"}),k("button",{className:I,onClick:v,children:"Delete"})]})]})})})]})}import{jsx as $,jsxs as z}from"react/jsx-runtime";function K({synth:p,buttonTarget:a,autoTailwind:i=!1}){let[t,n]=ne(!1),[d,l]=ne(()=>p?.a4_freq??440);ie(()=>{typeof p?.a4_freq=="number"&&l(p.a4_freq)},[p]);let e=420,r=Math.max(0,Math.min(1,(d-e)/(460-e)))*100;ie(()=>{if(!i||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let y=document.createElement("script");y.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",y.dataset.rcTailwind="1",document.head.appendChild(y)},[i]);let v=()=>$("button",{className:"rc-toggle-btn",title:"Open Routing Composer",onClick:()=>n(!0),children:"Routing Composer"});return z("div",{children:[$("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); backdrop-filter:blur(8px); box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),a?de.createPortal($(v,{}),a):$("div",{className:"rc-fixed-default",children:$(v,{})}),$("div",{className:"rc-overlay",style:{display:t?"flex":"none"},onClick:x=>{x.target===x.currentTarget&&n(!1)},children:z("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[z("div",{className:"rc-header",children:[z("div",{className:"flex items-center gap-4",children:[$("div",{children:"Routing Composer"}),z("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[$("span",{children:"A4"}),$("input",{type:"range",min:"420",max:"460",step:"0.1",defaultValue:p?.a4_freq??440,className:"rc-slider",style:{"--rc-pos":`${r}%`,width:160},onChange:x=>{let y=Number(x.target.value);p&&typeof y=="number"&&(p.a4_freq=y)}}),z("span",{children:[p?.a4_freq?.toFixed?.(1)??440,"Hz"]})]})]}),z("div",{className:"flex items-center gap-2",children:[$("button",{className:"rc-close",style:{background:"rgba(255,255,255,0.1)"},onClick:()=>p?.actx?.resume?.(),children:"Resume Audio"}),$("button",{className:"rc-close",onClick:()=>n(!1),children:"Close"})]})]}),$("div",{className:"rc-body",children:$(X,{synth:p})})]})})]})}import{jsx as se}from"react/jsx-runtime";var Oe=K;(function(){if(typeof window>"u")return;let a={mount(i={}){let{synth:t,button:n,tailwind:d="auto"}=i,l=null;n&&(typeof n=="string"?l=document.querySelector(n):n instanceof HTMLElement&&(l=n));let e=document.createElement("div");return document.body.appendChild(e),Y.createRoot?Y.createRoot(e).render(se(K,{synth:t,buttonTarget:l,autoTailwind:d==="auto"})):Y.render(se(K,{synth:t,buttonTarget:l,autoTailwind:d==="auto"}),e),console.log("[RoutingComposer] mounted GUI"),{host:e}}};window.RoutingComposer=a})();export{Oe as default};
