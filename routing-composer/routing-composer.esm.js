var se=Object.defineProperty;var oe=(h,a,n)=>a in h?se(h,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):h[a]=n;var Z=(h,a,n)=>oe(h,typeof a!="symbol"?a+"":a,n);import"react";import Y from"react-dom";import{useEffect as U,useState as ne}from"react";import le from"react-dom";import{useEffect as K,useState as Q,useRef as ce}from"react";import"react";import{Fragment as z,jsx as m,jsxs as k}from"react/jsx-runtime";var re="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",P="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function O({label:h,min:a,max:n,step:t=.01,value:i,onChange:c,suffix:d}){let e=typeof i=="number"?(Math.round(i*100)/100).toFixed(2):String(i??""),u=Number(i??0),o=Number(a??0),x=Number(n??1),f=Math.max(0,Math.min(1,(u-o)/(x-o)))*100;return k("div",{className:"flex items-center gap-3",children:[m("div",{className:"w-24 text-sm opacity-80",children:h}),m("input",{type:"range",className:"w-48 rc-slider",min:a,max:n,step:t,value:Number(i??0),onChange:g=>c(Number(g.target.value)),style:{"--rc-pos":`${f}%`}}),k("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[e,d?m("span",{className:"opacity-60",children:d}):null]})]})}function W({mod:h,onToggle:a,onRemove:n,onParam:t}){let{kind:i,enabled:c,params:d={}}=h;return k("div",{className:`${re} w-[280px]`,children:[k("div",{className:"flex items-center justify-between",children:[m("div",{className:"font-semibold capitalize",children:i}),k("div",{className:"flex gap-2",children:[m("button",{className:P,onClick:a,children:c?"Bypass":"Enable"}),m("button",{className:P,onClick:n,title:"Remove module",children:"\xD7"})]})]}),m("div",{className:"mt-2 text-xs opacity-70",children:c?"active":"bypassed"}),k("div",{className:"mt-3 space-y-2",children:[i==="ks_source"&&k(z,{children:[k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),k("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.ch??"all"),onChange:e=>t("ch",e.target.value),children:[m("option",{value:"all",children:"all"}),Array.from({length:16},(e,u)=>m("option",{value:String(u),children:u},u))]})]}),k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"Program"}),m("input",{type:"number",min:0,max:127,className:"bg-transparent border border-white/10 rounded-lg px-2 py-1 w-24",value:Number(d.program??0),onChange:e=>t("program",Number(e.target.value))})]}),k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),m("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.smoothingMode??"auto"),onChange:e=>t("smoothingMode",e.target.value),children:["auto","manual"].map(e=>m("option",{value:e,children:e},e))})]}),String(d.smoothingMode??"auto")==="manual"&&m(O,{label:"smooth",min:0,max:1,value:Number(d.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),m(O,{label:"velScale",min:0,max:1,value:Number(d.velScale??1),onChange:e=>t("velScale",e)}),k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"seed"}),m("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.seedNoiseType??"pink"),onChange:e=>t("seedNoiseType",e.target.value),children:["pink","white","synthPink"].map(e=>m("option",{value:e,children:e},e))})]}),String(d.smoothingMode??"auto")==="auto"&&m("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / stringDampingVariation \u8207 note \u8A08\u7B97"})]}),i==="source"&&k(z,{children:[k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),k("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(h.params.ch??"all"),onChange:e=>t("ch",e.target.value),children:[m("option",{value:"all",children:"all"}),Array.from({length:16},(e,u)=>m("option",{value:String(u),children:u},u))]})]}),k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"wave"}),m("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(h.params.type),onChange:e=>t("type",e.target.value),children:["sine","square","sawtooth","triangle"].map(e=>m("option",{value:e,children:e},e))})]}),m(O,{label:"attack",min:0,max:.2,value:Number(h.params.adsr?.a??.003),onChange:e=>t("adsr",{...h.params.adsr||{},a:e})}),m(O,{label:"decay",min:0,max:1,value:Number(h.params.adsr?.d??.08),onChange:e=>t("adsr",{...h.params.adsr||{},d:e})}),m(O,{label:"sustain",min:0,max:1,value:Number(h.params.adsr?.s??.4),onChange:e=>t("adsr",{...h.params.adsr||{},s:e})}),m(O,{label:"release",min:0,max:2,value:Number(h.params.adsr?.r??.2),onChange:e=>t("adsr",{...h.params.adsr||{},r:e})})]}),i==="filter"&&k(z,{children:[k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"mode"}),m("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.mode??"lowpass"),onChange:e=>t("mode",e.target.value),children:["lowpass","highpass","bandpass","notch"].map(e=>m("option",{value:e,children:e},e))})]}),m(O,{label:"freq",min:50,max:12e3,value:Number(d.freq??1200),onChange:e=>t("freq",e)}),m(O,{label:"Q",min:.1,max:20,value:Number(d.q??.7),onChange:e=>t("q",e)})]}),i==="delay"&&k(z,{children:[m(O,{label:"time",min:.01,max:1.2,value:Number(d.time??.25),onChange:e=>t("time",e)}),m(O,{label:"feedback",min:0,max:.95,value:Number(d.feedback??.35),onChange:e=>t("feedback",e)}),m(O,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),i==="reverb"&&k(z,{children:[m(O,{label:"decay",min:.2,max:6,value:Number(d.decay??2),onChange:e=>t("decay",e)}),m(O,{label:"mix",min:0,max:1,value:Number(d.mix??.25),onChange:e=>t("mix",e)})]}),i==="convolver_ir"&&k(z,{children:[k("div",{className:"flex items-center gap-2",children:[m("div",{className:"w-24 text-sm opacity-80",children:"IR"}),m("select",{className:"bg-transparent border border-white/10 rounded-lg px-2 py-1",value:String(d.irId??"IR_Gibson"),onChange:e=>t("irId",e.target.value),children:["IR_Gibson","IR_piezo"].map(e=>m("option",{value:e,children:e},e))})]}),m(O,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),i==="gain"&&m(O,{label:"gain",min:0,max:1.5,value:Number(d.gain??.8),onChange:e=>t("gain",e)}),i==="analyzer"&&m("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var H=class{constructor(a){Z(this,"handleMIDIMsg",a=>{let n=a[0],t=a[1],i=a[2],c=n&240,d=n&15;c===144&&i>0?this.gate(!0,i/127,d,t):(c===128||c===144&&i===0)&&this.gate(!1,0,d,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let n=this.actx.createGain();return n.gain.value=1,n}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let n=0;n<16;n++)try{this.mixers[n].connect(this.midiSynth.chvol[n]),console.log(`[RC] mixer[ch${n}] -> chvol[ch${n}]`)}catch(t){console.warn(`[RC] mixer[ch${n}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}updateGainNodeById(a,n){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let i=this.actx.currentTime;try{t.gain.cancelScheduledValues(i),t.gain.setTargetAtTime(Number(n)||0,i,.01)}catch{t.gain.value=Number(n)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let n=this.actx.createConstantSource();return n.offset.value=0,n.start(),this._bendCS[a]=n,n}updateBend(a,n){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),i=Number.isFinite(n)?n:0;try{let c=this.actx.currentTime;t.offset.cancelScheduledValues(c),t.offset.setTargetAtTime(i,c,.01)}catch{t.offset.value=i}}setMidiSynth(a){this.midiSynth=a;let n=a&&(a.actx||a.audioContext);if(n&&n!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=n,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(i){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,i)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a){this.liveNodes.clear();let n=c=>{let d=c.kind,e=c.params||{},u=this.actx;if(!c.enabled){let o=u.createGain();return{in:o,out:o}}switch(d){case"ks_source":{let o=u.createGain();return this.liveNodes.set(c.id+":ksOut",o),this.liveNodes.set(c.id+":ksParams",e),this.liveNodes.set("__lastKsId__",c.id),this.liveNodes.set("keyboardTarget",o),{in:o,out:o}}case"source":{let o=u.createOscillator();o.type=e.type||"sawtooth";let x=u.createGain();return x.gain.value=0,o.connect(x),o.start(),this.liveNodes.set(c.id+":osc",o),this.liveNodes.set(c.id+":env",x),this.liveNodes.set(c.id+":oscType",o.type),this.liveNodes.set(c.id+":ch",e.ch??"all"),this.liveNodes.set(c.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",o.type),this.liveNodes.set("keyboardTarget",x),{in:x,out:x}}case"gain":{let o=this.actx.createGain();return o.gain.value=Number(e.gain??1),this.liveNodes.set(c.id+":node",o),{in:o,out:o}}case"filter":{let o=u.createBiquadFilter();return o.type=e.mode||"lowpass",o.frequency.value=Number(e.freq||1200),o.Q.value=Number(e.q||.7),this.liveNodes.set(c.id+":node",o),{in:o,out:o}}case"delay":{let o=u.createDelay(2);o.delayTime.value=Number(e.time||.25);let x=u.createGain();x.gain.value=Number(e.feedback||.3);let f=u.createGain();f.gain.value=Number(e.mix||.3);let g=u.createGain(),N=u.createGain(),y=u.createGain();return y.gain.value=1-f.gain.value,g.connect(o),g.connect(y),o.connect(x).connect(o),o.connect(f),y.connect(N),f.connect(N),this.liveNodes.set(c.id+":node",{input:g,output:N,delay:o,fb:x,mix:f}),{in:g,out:N}}case"analyzer":{let o=u.createGain();return o.connect(this.analyser),this.liveNodes.set(c.id+":node",o),{in:o,out:o}}default:{let o=u.createGain();return{in:o,out:o}}}},t=null,i=null;for(let c of a){let{in:d,out:e}=n(c);t||(t=d),i&&i.connect(d),i=e}t&&this.liveNodes.set("__chainHead__",t),i&&this.liveNodes.set("__chainTail__",i);try{let d=a.find(u=>u.kind==="ks_source"||u.kind==="source")?.params?.ch??"all",e=d==="all"?Array.from({length:16},(u,o)=>o):[Number(d)];for(let u of e){let o=this.mixers[u];i&&o&&i.connect(o)}}catch(c){console.warn("[RC] mixer connect failed",c)}}buildMany(a){let t=this.liveNodes.get("__oscVoices__"),i=new Map;for(let c of a){let d=new Map;this.liveNodes=d,this.build(c);for(let[e,u]of d.entries())i.set(e,u)}t&&i.set("__oscVoices__",t),this.liveNodes=i}gate(a,n=.8,t=0,i=69){let c=this.actx.currentTime,d=(i??69)|0,e=!1;if(a){let u=this.pluckKS(t,d,n)===!0,o=!1;u||(o=this.gateOsc(t,i,n)===!0),e=u||o}if(a&&!e){let o=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(d-69)/12),x=[];for(let[A,T]of this.liveNodes.entries())if(A.endsWith(":oscType")){let D=A.split(":")[0],C=this.liveNodes.get(D+":ch")??"all",b=this.liveNodes.get(D+":adsr")||{a:.003,d:.08,s:.4,r:.2},_=T||"sawtooth";(C==="all"||Number(C)===t)&&x.push({modId:D,type:_,adsr:b})}if(!x.length){let A=this.liveNodes.get("__oscType__")||"sawtooth";x.push({modId:null,type:A,adsr:{a:.003,d:.08,s:.4,r:.2}})}let f=this.liveNodes.get("__chainTail__"),g=this.liveNodes.get("__chainHead__"),N=this.liveNodes.get("keyboardTarget"),y=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let R=this.liveNodes.get("__oscVoices__");R[t]||(R[t]={});for(let A of x){let T=this.actx.createOscillator();try{T.type=A.type}catch{T.type="sawtooth"}T.frequency.setValueAtTime(o,c);try{let l=this.midiSynth?.chmod?.[t];l&&T.detune&&l.connect(T.detune);let p=this.getBendNode(t);T.detune&&p&&p.connect(T.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(l){console.warn("[RC] osc detune connect failed",l)}let D=this.actx.createGain();D.gain.setValueAtTime(0,c);let{a:C,d:b,s:_,r:M}=A.adsr;D.gain.linearRampToValueAtTime(n,c+(C??.003)),D.gain.linearRampToValueAtTime((_??.4)*n,c+(C??.003)+(b??.08)),T.connect(D);let s=null;if(g&&g!==N?s=g:f?s=f:y&&(s=y),!s&&y&&(s=y),s){D.connect(s);try{let l=this.mixers?.[t];if(f&&l)if(f.context===this.actx&&l.context===this.actx)f.connect(l);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let p=this.mixers?.[t];f.context===this.actx&&p?.context===this.actx&&f.connect(p)}catch{}}}catch(l){console.warn("[RC] mixer connect failed",l)}}T.start(c);let r=`${d}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;R[t][r]={note:d,osc:T,env:D,r:M??.2}}}if(!a){let u=this.actx.currentTime,o=this.liveNodes.get("__oscVoices__");if(!o||!o[t])return;let x=Object.entries(o[t]).filter(([f,g])=>g.note===d);for(let[f,g]of x){let{osc:N,env:y,r:R=.2}=g;try{y.gain.cancelScheduledValues(u),y.gain.setValueAtTime(y.gain.value??0,u),y.gain.linearRampToValueAtTime(0,u+R),N.stop(u+R+.05),setTimeout(()=>{try{N.disconnect(),y.disconnect()}catch{}delete o[t][f]},(R+.1)*1e3)}catch{delete o[t][f]}}}}pluckKS(a,n,t){let i=Array.from(this.liveNodes.entries()).filter(([b])=>b.endsWith(":ksOut"));if(!i.length)return!1;let c=null,d={},e=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[b,_]of i){let M=this.liveNodes.get(b.replace(":ksOut",":ksParams"))||{},s=M.ch!=null?M.ch:"all",r=Number(M.program!=null?M.program:0);if((s==="all"||Number(s)===a)&&r===e){c=[b,_],d=M;break}}if(!c)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:e}),!1;let u=c[0],o=c[1],x=d,g=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),N=this.actx.sampleRate,y;try{if(x.seedNoiseType==="synthPink"&&this.midiSynth&&typeof this.midiSynth.generateSeedPinkNoise=="function"){let b=Math.max(1,Math.round(N/Math.max(1e-6,g)));y=this.midiSynth.generateSeedPinkNoise(65535,b)}else{let b=Math.max(2048,Math.round(N/Math.max(1e-6,g)));y=((M=4096)=>{let s=new Float32Array(M),r=0,l=0,p=0,v=0,w=0,B=0,E=0;for(let J=0;J<M;J++){let $=Math.random()*2-1;r=.99886*r+$*.0555179,l=.99332*l+$*.0750759,p=.969*p+$*.153852,v=.8665*v+$*.3104856,w=.55*w+$*.5329522,B=-.7616*B-$*.016898,s[J]=(r+l+p+v+w+B+E*.5362)*.11,E=$*.115926}return s})(b)}}catch{}console.log("[RC] seed check",y?.length,y?.[0]);let R=this.actx.createBuffer(2,N,N),A=.2;try{let b=this.midiSynth?.inv127??.007874015748031496,_=Math.pow(n/64,.5)||0,M=n*b*.85+.15,s=Number(this.midiSynth?.options?.[a]?.stringDampingVariation??0);A=M+_*(1-M)*.5+(1-M)*Math.random()*s}catch{}let T=Number(x.velScale==null?1:x.velScale),D=this.midiSynth?.options?.[a]??{};if(Object.keys(D).length===0&&(D.stringDamping=.5,D.stringDampingVariation=.2),Number.isFinite(A)||(A=.2),!y||!y.length){console.warn("[RC] seed invalid, injecting pink noise");let b=Math.max(2048,Math.round(N/Math.max(1e-6,g)));y=new Float32Array(b);for(let _=0;_<b;_++)y[_]=Math.random()*2-1}try{let b=this.midiSynth?.asmWrapper?.[a],_=this.midiSynth?.options?.[a]??{};b&&typeof b.pluck=="function"&&b.pluck(R,y,N,g,A,t*T,_,.2)}catch(b){console.warn("[RC] pluck error",b)}let C=this.actx.createBufferSource();C.buffer=R;try{let b=this.midiSynth?.chmod?.[a];b&&C.detune&&b.connect(C.detune)}catch{}try{let b=this.midiSynth?.bend?.[a];typeof b=="number"&&C.detune&&(C.detune.value=b)}catch{}C.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[n]===C&&(this.midiSynth.bfSet[a][n]=null)}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][n]=C}catch{}try{let b=u.replace(":ksOut",":tail"),_=this.liveNodes.get(b)||this.liveNodes.get("__chainTail__"),M=this.midiSynth?.chvol?.[a],s=`__tail_to_chvol_${a}__`;try{let r=this.mixers?.[a];if(_&&r)if(_.context===this.actx&&r.context===this.actx)_.connect(r);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let l=this.mixers?.[a];_.context===this.actx&&l?.context===this.actx&&_.connect(l)}catch{}}}catch(r){console.warn("[RC] mixer connect failed",r)}}catch{}return C.connect(o),C.start(),!0}gateOsc(a,n,t){let i=Array.from(this.liveNodes.entries()).filter(([c])=>c.endsWith(":osc"));if(!i.length)return!1;for(let[c,d]of i){let e=this.liveNodes.get(c.replace(":osc",":env"));if(!e)continue;let u=this.actx.currentTime,o=this.midiSynth?.a4_freq*Math.pow(2,(n-69)/12);try{d.frequency.setValueAtTime(o,u)}catch{}e.gain.cancelScheduledValues(u),e.gain.setValueAtTime(0,u),e.gain.linearRampToValueAtTime(t,u+.01),e.gain.linearRampToValueAtTime(0,u+.4)}return!0}};import{Fragment as ae,jsx as S,jsxs as q}from"react/jsx-runtime";var V="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var ee=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],j={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:0},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function I(h="m"){return`${h}_${Math.random().toString(36).slice(2,9)}`}function te(h,a,n){let t=h.slice(),i=Math.max(0,Math.min(t.length-1,a)),c=t.splice(i,1)[0],d=Math.max(0,Math.min(t.length,n));return t.splice(d,0,c),t}function X({synth:h}){let a=ce(null);a.current||(a.current=new H);let n=a.current;K(()=>{if(h&&typeof n.setMidiSynth=="function")try{n.setMidiSynth(h),console.log("[RC] midi_synth attached to engine")}catch(s){console.warn("[RC] setMidiSynth failed",s)}},[h]),K(()=>(window.__RC_HANDLE__={midi:s=>{try{n.handleMIDIMsg&&n.handleMIDIMsg(s),console.log("[RC] MIDI -> engine",s)}catch(r){console.warn("[RC] MIDI ingress failed",r)}},engine:n},()=>{try{delete window.__RC_HANDLE__}catch{}}),[n]);let[t,i]=Q([[{id:I("ks"),kind:"ks_source",enabled:!0,params:{...j.ks_source}},{id:I("gain"),kind:"gain",enabled:!0,params:{...j.gain}},{id:I("an"),kind:"analyzer",enabled:!0,params:{}}]]),[c,d]=Q({open:!1,idx:null,step:1}),e=s=>d({open:!0,idx:s,step:1}),u=()=>d({open:!1,idx:null,step:1}),o=()=>d(s=>({...s,step:2})),x=()=>{i(s=>{let r=s.filter((l,p)=>p!==c.idx);return r.length?r:[[{id:I("src"),kind:"source",enabled:!0,params:{...j.source}},{id:I("gain"),kind:"gain",enabled:!0,params:{...j.gain}},{id:I("an"),kind:"analyzer",enabled:!0,params:{}}]]}),u()};K(()=>{try{n.buildMany(t),n.resume&&n.resume()}catch(s){console.warn("[RC] buildMany failed",s)}},[JSON.stringify(t)]),K(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(s=>{for(let r of s.inputs.values())r.onmidimessage=l=>n.handleMIDIMsg(l.data)})},[]);let f=(s,r)=>i(l=>{let p=l.map(v=>[...v]);return p[s]=[...p[s],{id:I(r),kind:r,enabled:!0,params:{...j[r]}}],p}),g=(s,r)=>i(l=>l.map((p,v)=>v!==s?p:p.map(w=>w.id===r?{...w,enabled:!w.enabled}:w))),N=(s,r)=>i(l=>l.map((p,v)=>v!==s?p:p.filter(w=>w.id!==r))),y=(s,r,l,p)=>{l==="gain"&&(n.updateGainNodeById(r,p)||console.warn("[RC] gain node not found for id:",r)),i(v=>v.map((w,B)=>B!==s?w:w.map(E=>E.id===r?{...E,params:{...E.params,[l]:p}}:E)))},[R,A]=Q(null),T=(s,r)=>l=>{A({chain:s,from:r}),l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/plain",`${s}:${r}`)},D=(s,r)=>l=>{l.preventDefault(),!(!R||R.chain!==s)&&(i(p=>p.map((v,w)=>w!==s?v:te(v,R.from,r))),A(null))},C=s=>r=>{r.preventDefault(),!(!R||R.chain!==s)&&(i(l=>l.map((p,v)=>v!==s?p:te(p,R.from,p.length))),A(null))},b=s=>i(r=>{let l=r.map(v=>[...v]),p=l[s].map(v=>({...v,id:I(v.kind)}));return l.splice(s+1,0,p),l}),_=()=>{let s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),l=document.createElement("a");l.href=r,l.download="audio-chains.json",l.click(),URL.revokeObjectURL(r)},M=async s=>{let r=await s.text();try{let l=JSON.parse(r);Array.isArray(l)&&Array.isArray(l[0])&&i(l)}catch(l){console.warn("Invalid chain JSON",l)}};return q("div",{className:"p-6 text-white",children:[S("div",{className:"flex items-center justify-between mb-4",children:q("div",{className:"flex items-center gap-2 flex-wrap",children:[ee.map(s=>q("button",{className:V,onClick:()=>f(0,s),children:["+ ",s]},`add-${s}`)),S("button",{className:V,onClick:()=>n.resume(),children:"Resume Audio"}),S("button",{className:V,onClick:_,children:"Export"}),q("label",{className:`${V} cursor-pointer`,children:["Import",S("input",{type:"file",accept:"application/json",className:"hidden",onChange:s=>{let r=s.target.files?.[0];r&&M(r)}})]}),S("button",{className:V,onClick:()=>{typeof n.buildMultiFrom=="function"?n.buildMultiFrom(t[0],Array.from({length:16},(s,r)=>r)):i(s=>{let r=s[0]||[];return Array.from({length:16},(p,v)=>r.map(w=>({...w,id:I(w.kind)+`_ch${v}`,params:w.kind==="ks_source"?{...w.params,ch:String(v)}:{...w.params}})))})},children:"Duplicate to 16 channels"})]})}),S("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:t.map((s,r)=>q("div",{className:"mb-6",children:[q("div",{className:"flex items-center justify-between mb-2",children:[q("div",{className:"text-sm opacity-80",children:["Chain #",r+1]}),q("div",{className:"flex gap-2",children:[S("button",{className:V,onClick:()=>b(r),children:"Duplicate chain"}),S("button",{className:V,onClick:()=>e(r),children:"Delete chain"})]})]}),q("div",{className:"flex gap-3 items-stretch",children:[s.map((l,p)=>S("div",{draggable:!0,onDragStart:T(r,p),onDrop:D(r,p),onDragOver:v=>v.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:S(W,{mod:l,onToggle:()=>g(r,l.id),onRemove:()=>N(r,l.id),onParam:(v,w)=>y(r,l.id,v,w)})},l.id)),S("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:l=>l.preventDefault(),onDrop:C(r),children:"\u2192"})]}),S("div",{className:"mt-3 flex flex-wrap gap-2",children:ee.map(l=>q("button",{className:V,onClick:()=>f(r,l),children:["+ ",l]},`${r}-${l}`))})]},r))}),c.open&&S("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:S("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:c.step===1?q(ae,{children:[S("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),S("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),q("div",{className:"flex justify-end gap-2",children:[S("button",{className:V,onClick:u,children:"Cancel"}),S("button",{className:V,onClick:o,children:"Next"})]})]}):q(ae,{children:[S("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),S("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),q("div",{className:"flex justify-end gap-2",children:[S("button",{className:V,onClick:u,children:"Cancel"}),S("button",{className:V,onClick:x,children:"Delete"})]})]})})})]})}import{jsx as G,jsxs as F}from"react/jsx-runtime";function L({synth:h,buttonTarget:a,autoTailwind:n=!1}){let[t,i]=ne(!1);U(()=>{if(!t)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(g){console.warn("[RC] resumeAll failed",g)}})()},[t]);let[c,d]=ne(()=>h?.a4_freq??440);U(()=>{typeof h?.a4_freq=="number"&&d(Number(h.a4_freq))},[h]),U(()=>{let f=c,g=setInterval(()=>{let N=Number(h?.a4_freq??440);!Number.isNaN(N)&&N!==f&&(f=N,d(N))},250);return()=>clearInterval(g)},[h,c]);let e=420,o=Math.max(0,Math.min(1,(c-e)/(460-e)))*100;U(()=>{if(!n||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let g=document.createElement("script");g.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",g.dataset.rcTailwind="1",document.head.appendChild(g)},[n]);let x=()=>G("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>i(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return F("div",{children:[G("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),a?le.createPortal(G(x,{}),a):G("div",{className:"rc-fixed-default",children:G(x,{})}),G("div",{className:"rc-overlay",style:{display:t?"flex":"none"},onClick:f=>{f.target===f.currentTarget&&i(!1)},children:F("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[F("div",{className:"rc-header",children:[F("div",{className:"flex items-center gap-4",children:[G("div",{children:"Routing Composer"}),F("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[G("span",{children:"A4"}),G("input",{type:"range",min:"420",max:"460",step:"0.1",value:c,className:"rc-slider",style:{"--rc-pos":`${(c-420)/40*100}%`,width:160},onChange:f=>{let g=Number(f.target.value);Number.isNaN(g)||(d(g),h&&(h.a4_freq=g))}}),F("span",{children:[c.toFixed(1),"Hz"]})]})]}),F("div",{className:"flex items-center gap-2",children:[G("button",{className:"rc-close",onClick:()=>h?.actx?.resume?.(),children:"Resume Audio"}),G("button",{className:"rc-close",onClick:()=>i(!1),children:"Close"})]})]}),G("div",{className:"rc-body",children:G(X,{synth:h})})]})})]})}import{jsx as ie}from"react/jsx-runtime";var qe=L;(function(){if(typeof window>"u")return;let a={mount(n={}){let{synth:t,button:i,tailwind:c="auto"}=n,d=null;i&&(typeof i=="string"?d=document.querySelector(i):i instanceof HTMLElement&&(d=i));let e=document.createElement("div");return document.body.appendChild(e),Y.createRoot?Y.createRoot(e).render(ie(L,{synth:t,buttonTarget:d,autoTailwind:c==="auto"})):Y.render(ie(L,{synth:t,buttonTarget:d,autoTailwind:c==="auto"}),e),console.log("[RoutingComposer] mounted GUI"),{host:e}}};window.RoutingComposer=a})();export{qe as default};
