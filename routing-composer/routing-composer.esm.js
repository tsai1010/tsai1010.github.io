var Te=Object.defineProperty;var De=(f,a,n)=>a in f?Te(f,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):f[a]=n;var xe=(f,a,n)=>De(f,typeof a!="symbol"?a+"":a,n);import"react";import ve from"react-dom";import{useEffect as ce,useState as be}from"react";import Ge from"react-dom";import{useEffect as L,useState as ne,useRef as Ce}from"react";import"react";import{Fragment as ee,jsx as g,jsxs as F}from"react/jsx-runtime";var Ve="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",Ne="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function B({label:f,min:a,max:n,step:t=.01,value:c,onChange:u,suffix:s}){let d=typeof c=="number"?(Math.round(c*100)/100).toFixed(2):String(c??""),e=Number(c??0),m=Number(a??0),i=Number(n??1),x=Math.max(0,Math.min(1,(e-m)/(i-m)))*100;return F("div",{className:"flex items-center gap-3",children:[g("div",{className:"w-24 text-sm opacity-80",children:f}),g("input",{type:"range",className:"w-48 rc-slider",min:a,max:n,step:t,value:Number(c??0),onChange:w=>u(Number(w.target.value)),onMouseUp:w=>w.currentTarget.blur(),onTouchEnd:w=>w.currentTarget.blur(),style:{"--rc-pos":`${x}%`}}),F("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[d,s?g("span",{className:"opacity-60",children:s}):null]})]})}function fe({mod:f,onToggle:a,onRemove:n,onParam:t,onDragStart:c}){let{kind:u,enabled:s,params:d={}}=f;return F("div",{className:`${Ve} w-[280px]`,children:[F("div",{className:"flex items-center justify-between",children:[F("div",{className:"flex items-center gap-2",children:[g("div",{className:"cursor-grab active:cursor-grabbing text-xs opacity-60 select-none",draggable:!!c,onDragStart:c,title:"Drag to reorder",children:"\u2630"}),g("div",{className:"font-semibold capitalize",children:u})]}),F("div",{className:"flex gap-2",children:[g("button",{className:Ne,onClick:a,children:s?"Bypass":"Enable"}),g("button",{className:Ne,onClick:n,title:"Remove module",children:"\xD7"})]})]}),g("div",{className:"mt-2 text-xs opacity-70",children:s?"active":"bypassed"}),F("div",{className:"mt-3 space-y-2",children:[u==="ks_source"&&F(ee,{children:[F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),F("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.ch??"all"),onChange:e=>{t("ch",e.target.value),e.target.blur()},children:[g("option",{value:"all",children:"all"}),Array.from({length:16},(e,m)=>g("option",{value:String(m),children:m},m))]})]}),F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"Program"}),F("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.program??"all"),onChange:e=>{t("program",e.target.value),e.target.blur()},children:[g("option",{value:"all",children:"all"}),Array.from({length:128},(e,m)=>g("option",{value:String(m),children:m},m))]})]}),F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),g("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.smoothingMode??"auto"),onChange:e=>{t("smoothingMode",e.target.value),e.target.blur()},children:["auto","manual"].map(e=>g("option",{value:e,children:e},e))})]}),String(d.smoothingMode??"auto")==="manual"&&g(B,{label:"smooth",min:0,max:1,value:Number(d.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),g(B,{label:"velScale",min:0,max:1,value:Number(d.velScale??1),onChange:e=>t("velScale",e)}),g(B,{label:"KS dur",min:.1,max:10,step:.1,value:Number(d.ksDurSec??1),onChange:e=>t("ksDurSec",e),suffix:"s"}),g(B,{label:"Release",min:0,max:1,step:.01,value:Number(d.ksRelease??.5),onChange:e=>t("ksRelease",e)}),F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"Noise"}),F("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.seedNoiseType??"pink"),onChange:e=>{t("seedNoiseType",e.target.value),e.target.blur()},children:[g("option",{value:"brown",children:"Soft"}),g("option",{value:"softBrown",children:"Extra Soft"}),g("option",{value:"red",children:"Deep Soft"}),g("option",{value:"pink",children:"Warm"}),g("option",{value:"softPink",children:"Warm Soft"}),g("option",{value:"white",children:"Bright"}),g("option",{value:"blue",children:"Airy"}),g("option",{value:"violet",children:"Breathy"}),g("option",{value:"wind",children:"Windy"}),g("option",{value:"perlin",children:"Organic"}),g("option",{value:"formant",children:"Body"}),g("option",{value:"dust",children:"Dusty"}),g("option",{value:"wood",children:"Woody"}),g("option",{value:"grey",children:"Mix"})]})]}),String(d.smoothingMode??"auto")==="auto"&&g("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / variation \u8207 note \u8A08\u7B97"})]}),u==="source"&&F(ee,{children:[F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),F("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(f.params.ch??"all"),onChange:e=>{t("ch",e.target.value),e.target.blur()},children:[g("option",{value:"all",children:"all"}),Array.from({length:16},(e,m)=>g("option",{value:String(m),children:m},m))]})]}),F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"wave"}),g("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(f.params.type),onChange:e=>{t("type",e.target.value),e.target.blur()},children:["sine","square","sawtooth","triangle"].map(e=>g("option",{value:e,children:e},e))})]}),g(B,{label:"level",min:0,max:1,step:.01,value:Number(f.params.level??.15),onChange:e=>t("level",e)}),g(B,{label:"attack",min:0,max:.2,value:Number(f.params.adsr?.a??.003),onChange:e=>t("adsr",{...f.params.adsr||{},a:e})}),g(B,{label:"decay",min:0,max:1,value:Number(f.params.adsr?.d??.08),onChange:e=>t("adsr",{...f.params.adsr||{},d:e})}),g(B,{label:"sustain",min:0,max:1,value:Number(f.params.adsr?.s??.4),onChange:e=>t("adsr",{...f.params.adsr||{},s:e})}),g(B,{label:"release",min:0,max:2,value:Number(f.params.adsr?.r??.2),onChange:e=>t("adsr",{...f.params.adsr||{},r:e})})]}),u==="filter"&&F(ee,{children:[F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"mode"}),g("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.mode??"lowpass"),onChange:e=>{t("mode",e.target.value),e.target.blur()},children:["lowpass","highpass","bandpass","notch"].map(e=>g("option",{value:e,children:e},e))})]}),g(B,{label:"freq",min:50,max:12e3,value:Number(d.freq??1200),onChange:e=>t("freq",e)}),g(B,{label:"Q",min:.1,max:20,value:Number(d.q??.7),onChange:e=>t("q",e)})]}),u==="delay"&&F(ee,{children:[g(B,{label:"time",min:.01,max:1.2,value:Number(d.time??.25),onChange:e=>t("time",e)}),g(B,{label:"feedback",min:0,max:.95,value:Number(d.feedback??.35),onChange:e=>t("feedback",e)}),g(B,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),u==="reverb"&&F(ee,{children:[g(B,{label:"decay",min:.2,max:6,value:Number(d.decay??2),onChange:e=>t("decay",e)}),g(B,{label:"mix",min:0,max:1,value:Number(d.mix??.25),onChange:e=>t("mix",e)})]}),u==="convolver_ir"&&F(ee,{children:[F("div",{className:"flex items-center gap-2",children:[g("div",{className:"w-24 text-sm opacity-80",children:"IR"}),g("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(d.irId??"IR_Gibson"),onChange:e=>{t("irId",e.target.value),e.target.blur()},children:["IR_Gibson","IR_piezo"].map(e=>g("option",{value:e,children:e},e))})]}),g(B,{label:"mix",min:0,max:1,value:Number(d.mix??.3),onChange:e=>t("mix",e)})]}),u==="gain"&&g(B,{label:"gain",min:0,max:1.5,value:Number(d.gain??.8),onChange:e=>t("gain",e)}),u==="analyzer"&&g("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var oe=class{constructor(a){xe(this,"handleMIDIMsg",a=>{let n=a[0],t=a[1],c=a[2],u=n&240,s=n&15;u===144&&c>0?this.gate(!0,c/127,s,t):(u===128||u===144&&c===0)&&this.gate(!1,0,s,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this.irBuffers=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let n=this.actx.createGain();return n.gain.value=1,n}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let n=0;n<16;n++)try{this.mixers[n].connect(this.midiSynth.chvol[n]),console.log(`[RC] mixer[ch${n}] -> chvol[ch${n}]`)}catch(t){console.warn(`[RC] mixer[ch${n}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}setIRBuffer(a,n){console.log("[RC][IR] register IR buffer:",a,n),this.irBuffers.set(String(a),n)}updateGainNodeById(a,n){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let c=this.actx.currentTime;try{t.gain.cancelScheduledValues(c),t.gain.setTargetAtTime(Number(n)||0,c,.01)}catch{t.gain.value=Number(n)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let n=this.actx.createConstantSource();return n.offset.value=0,n.start(),this._bendCS[a]=n,n}updateBend(a,n){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),c=Number.isFinite(n)?n:0;try{let u=this.actx.currentTime;t.offset.cancelScheduledValues(u),t.offset.setTargetAtTime(c,u,.01)}catch{t.offset.value=c}}setMidiSynth(a){this.midiSynth=a;let n=a&&(a.actx||a.audioContext);if(n&&n!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=n,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(c){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,c)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a,n=0){this.liveNodes.clear();let t=s=>{let d=s.kind,e=s.params||{},m=this.actx;if(!s.enabled){let i=m.createGain();return{in:i,out:i}}switch(d){case"ks_source":{let i=m.createGain();return this.liveNodes.set(s.id+":ksOut",i),this.liveNodes.set(s.id+":ksParams",e),this.liveNodes.set(s.id+":chainIdx",n|0),this.liveNodes.set("__lastKsId__",s.id),this.liveNodes.set("keyboardTarget",i),{in:i,out:i}}case"source":{let i=m.createOscillator();i.type=e.type||"sawtooth";let x=m.createGain();return x.gain.value=0,i.connect(x),i.start(),this.liveNodes.set(s.id+":osc",i),this.liveNodes.set(s.id+":env",x),this.liveNodes.set(s.id+":oscType",i.type),this.liveNodes.set(s.id+":ch",e.ch??"all"),this.liveNodes.set(s.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set(s.id+":level",Number.isFinite(e.level)?e.level:.15),this.liveNodes.set("__oscType__",i.type),this.liveNodes.set("keyboardTarget",x),{in:x,out:x}}case"gain":{let i=this.actx.createGain();return i.gain.value=Number(e.gain??1),this.liveNodes.set(s.id+":node",i),{in:i,out:i}}case"filter":{let i=m.createBiquadFilter();return i.type=e.mode||"lowpass",i.frequency.value=Number(e.freq||1200),i.Q.value=Number(e.q||.7),this.liveNodes.set(s.id+":node",i),{in:i,out:i}}case"delay":{let i=m.createDelay(2);i.delayTime.value=Number(e.time||.25);let x=m.createGain();x.gain.value=Number(e.feedback||.3);let w=m.createGain();w.gain.value=Number(e.mix||.3);let R=m.createGain(),T=m.createGain(),k=m.createGain();return k.gain.value=1-w.gain.value,R.connect(i),R.connect(k),i.connect(x).connect(i),i.connect(w),k.connect(T),w.connect(T),this.liveNodes.set(s.id+":node",{input:R,output:T,delay:i,fb:x,mix:w}),{in:R,out:T}}case"convolver_ir":{let i=m.createConvolver(),x=m.createGain(),w=m.createGain(),R=m.createGain(),T=m.createGain(),k=Math.max(0,Math.min(1,Number(e.mix??.3)));x.gain.value=k,w.gain.value=1-k;let _=String(e.irId??"IR_Gibson");console.log("[RC][IR] build convolver_ir",{chain:n,modId:s.id,irId:_,mix:k}),!this.irBuffers||this.irBuffers.size===0?console.warn("[RC][IR] irBuffers is empty"):console.log("[RC][IR] available IR buffers:",Array.from(this.irBuffers.keys()));let C=this.irBuffers&&this.irBuffers.get(_);return C?(console.log("[RC][IR] IR buffer found:",_,{length:C.length,sampleRate:C.sampleRate,duration:C.duration}),i.buffer=C):console.warn("[RC][IR] IR buffer NOT found for",_),T.connect(w),w.connect(R),T.connect(i),i.connect(x),x.connect(R),this.liveNodes.set(s.id+":conv",i),this.liveNodes.set(s.id+":wet",x),this.liveNodes.set(s.id+":dry",w),{in:T,out:R}}case"analyzer":{let i=m.createGain();return i.connect(this.analyser),this.liveNodes.set(s.id+":node",i),{in:i,out:i}}default:{let i=m.createGain();return{in:i,out:i}}}},c=null,u=null;for(let s of a){let{in:d,out:e}=t(s);c||(c=d),u&&u.connect(d),u=e}c&&this.liveNodes.set("__chainHead__",c),u&&this.liveNodes.set("__chainTail__",u);try{if(!u)return;let s=n|0,d=this.actx.createGain();d.gain.value=1,this.liveNodes.set(`chainGain:${s}`,d),u.connect(d);let m=a.find(x=>x.kind==="ks_source"||x.kind==="source")?.params?.ch??"all",i=m==="all"?Array.from({length:16},(x,w)=>w):[Number(m)];for(let x of i){let w=this.mixers[x];w&&d.connect(w)}}catch(s){console.warn("[RC] mixer connect failed",s)}}buildMany(a){let n=this.liveNodes,t=n.get("__oscVoices__"),c=n.get("__ksVoices__"),u=new Map;a.forEach((s,d)=>{let e=new Map;this.liveNodes=e,this.build(s,d);for(let[m,i]of e.entries())u.set(m,i)}),t&&u.set("__oscVoices__",t),c&&u.set("__ksVoices__",c),this.liveNodes=u}setChainMute(a,n){try{let t=`chainGain:${a|0}`,c=this.liveNodes&&this.liveNodes.get(t);if(!c||!c.gain)return console.warn("[RC] setChainMute: chainGain not found",t),!1;let u=this.actx.currentTime;return c.gain.cancelScheduledValues(u),c.gain.setValueAtTime(n?0:1,u),console.log("[RC] setChainMute",{chainIdx:a,key:t,muted:n,gain:c.gain.value}),!0}catch(t){return console.warn("[RC] setChainMute failed",a,t),!1}}gate(a,n=.8,t=0,c=69){let u=this.actx.currentTime,s=(c??69)|0,d=!1;if(a){let e=this.pluckKS(t,c??69,n)===!0,m=this.gateOsc(t,c,n)===!0;d=e||m}if(a&&!d){let m=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(s-69)/12),i=[];for(let[_,C]of this.liveNodes.entries())if(_.endsWith(":oscType")){let V=_.split(":")[0],$=this.liveNodes.get(V+":ch")??"all",I=this.liveNodes.get(V+":adsr")||{a:.003,d:.08,s:.4,r:.2},E=C||"sawtooth";($==="all"||Number($)===t)&&i.push({modId:V,type:E,adsr:I})}if(!i.length)return;let x=this.liveNodes.get("__chainTail__"),w=this.liveNodes.get("__chainHead__"),R=this.liveNodes.get("keyboardTarget"),T=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let k=this.liveNodes.get("__oscVoices__");k[t]||(k[t]={});for(let _ of i){let C=this.actx.createOscillator();try{C.type=_.type}catch{C.type="sawtooth"}C.frequency.setValueAtTime(m,u);try{let j=this.midiSynth?.chmod?.[t];j&&C.detune&&j.connect(C.detune);let S=this.getBendNode(t);C.detune&&S&&S.connect(C.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(j){console.warn("[RC] osc detune connect failed",j)}let V=this.actx.createGain();V.gain.setValueAtTime(0,u);let{a:$,d:I,s:E,r:J}=_.adsr;V.gain.linearRampToValueAtTime(n,u+($??.003)),V.gain.linearRampToValueAtTime((E??.4)*n,u+($??.003)+(I??.08)),C.connect(V);let G=null;w&&w!==R?G=w:x?G=x:T&&(G=T),!G&&T&&(G=T),G&&V.connect(G),C.start(u);let U=`${s}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;k[t][U]={note:s,osc:C,env:V,r:J??.2}}}if(!a){let e=this.actx.currentTime,m=this.liveNodes.get("__ksVoices__"),i=(this.midiSynth?.pedal?.[t]??0)>=64;if(m&&m[t]){let x=Object.entries(m[t]).filter(([w,R])=>R.note===s);for(let[w,R]of x){let{bfs:T,env:k}=R;if(i){R.sustained=!0;continue}try{let _=Number(R.params?.ksRelease??.5),C=.02,$=C+(1.5-C)*Math.pow(_,2);k.gain.cancelScheduledValues(e),k.gain.setValueAtTime(k.gain.value??1,e),k.gain.linearRampToValueAtTime(0,e+$),T.stop(e+$+.05),setTimeout(()=>{try{T.disconnect(),k.disconnect()}catch{}delete m[t][w]},($+.05)*1e3)}catch{delete m[t][w]}}}this.releaseSourceEnv(t,s),this.releaseOsc(t,s);return}}pluckKS(a,n,t){let c=Array.from(this.liveNodes.entries()).filter(([R])=>R.endsWith(":ksOut"));if(!c.length)return!1;let u=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0),s=[];for(let[R,T]of c){let k=R.replace(":ksOut",""),_=this.liveNodes.get(k+":ksParams")||{},C=_.ch!=null?String(_.ch):"all",V=C==="all"||Number(C)===a,$=_.program;($==null||$==="all")&&($="all");let I=$==="all"?null:Number($);if(!(V&&(I===null||I===u)))continue;let J=(this.liveNodes.get(k+":chainIdx")??-1)|0;if(J>=0){let U=this.liveNodes.get(`chainGain:${J}`)?.gain?.value;if(typeof U=="number"&&U<=1e-4)continue}s.push({modId:k,outNode:T,params:_})}if(!s.length)return!1;let d=this.actx.currentTime,m=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),i=this.actx.sampleRate;this.liveNodes.has("__ksVoices__")||this.liveNodes.set("__ksVoices__",{});let x=this.liveNodes.get("__ksVoices__");x[a]||(x[a]={});let w=!1;for(let R of s){let T=R.params||{},k=null;try{let S=String(T.seedNoiseType??"pink"),D=Math.max(2048,Math.round(i/Math.max(1e-6,m))),q=o=>{let h=new Float32Array(o);for(let v=0;v<o;v++)h[v]=Math.random()*2-1;return h},Y=o=>{let h=new Float32Array(o),v=0,y=0,b=0,A=0,M=0,H=0,Z=0;for(let te=0;te<o;te++){let Q=Math.random()*2-1;v=.99886*v+Q*.0555179,y=.99332*y+Q*.0750759,b=.969*b+Q*.153852,A=.8665*A+Q*.3104856,M=.55*M+Q*.5329522,H=-.7616*H-Q*.016898,h[te]=(v+y+b+A+M+H+Z*.5362)*.11,Z=Q*.115926}return h},ie=o=>{let h=new Float32Array(o),v=0;for(let y=0;y<o;y++)v+=Math.random()*2-1,v=Math.max(-8,Math.min(8,v)),h[y]=v/8;return h},le=o=>{let h=q(o),v=Y(o),y=new Float32Array(o);for(let b=0;b<o;b++)y[b]=.6*h[b]+.4*v[b];return y},de=o=>{let h=new Float32Array(o),v=0,y=0;for(let b=0;b<o;b++)v+=(Math.random()*2-1)*.02,y+=v,h[b]=y*5e-4;return h},ue=o=>{let h=new Float32Array(o),v=0;for(let A=0;A<o;A++){let M=Math.random()*2-1;h[A]=M-v,v=M}let y=new Float32Array(o),b=0;for(let A=0;A<o;A++)b=b*.992+h[A]*.008,y[A]=b;return y},me=o=>{let h=new Float32Array(o),v=0;for(let A=0;A<o;A++){let M=Math.random()*2-1;h[A]=M-v,v=M}let y=new Float32Array(o),b=0;for(let A=0;A<o;A++)b=b*.995+h[A]*.005,y[A]=b;return y},he=o=>{let h=ie(o),v=new Float32Array(o),y=0;for(let b=0;b<o;b++)y=y*.995+h[b]*.005,v[b]=y*.9;return v},re=o=>{let h=Y(o),v=new Float32Array(o),y=0;for(let b=0;b<o;b++)y=y*.993+h[b]*.007,v[b]=y*.9;return v},pe=o=>{let h=new Float32Array(o),v=0,y=0;for(let b=0;b<o;b++){let A=Math.random()*2-1;v=v*.985+A*.015,y=y*.995+(Math.random()*2-1)*.005;let M=.6+.4*y;h[b]=v*M}return h},r=o=>{let h=new Float32Array(o),v=Math.max(8,Math.floor(o/64)),y=[],b=Math.floor(o/v)+2;for(let M=0;M<b;M++)y[M]=Math.random()*2-1;let A=M=>M*M*M*(M*(M*6-15)+10);for(let M=0;M<o;M++){let H=M/v,Z=Math.floor(H),te=H-Z,Q=y[Z],Re=y[Z+1],ye=A(te);h[M]=(Q*(1-ye)+Re*ye)*.9}return h},l=o=>{let h=new Float32Array(o),v=q(o),y=300,b=800,A=2500;for(let M=0;M<o;M++){let H=M/i,Z=1+.6*Math.sin(2*Math.PI*y*H)+.4*Math.sin(2*Math.PI*b*H+1.3)+.25*Math.sin(2*Math.PI*A*H+.7);h[M]=v[M]*(Z*.25)}return h},N=o=>{let h=new Float32Array(o),v=0,y=.004;for(let b=0;b<o;b++)Math.random()<y&&(v+=(Math.random()*2-1)*.9),v*=.96,h[b]=v;return h},p=o=>{let h=re(o),v=new Float32Array(o),y=220,b=550;for(let A=0;A<o;A++){let M=A/i,H=.5*Math.sin(2*Math.PI*y*M)+.35*Math.sin(2*Math.PI*b*M+1.1);v[A]=h[A]*(1+.4*H)}return v};switch(S){case"white":k=q(D);break;case"pink":k=Y(D);break;case"brown":k=ie(D);break;case"softBrown":k=he(D);break;case"softPink":k=re(D);break;case"red":k=de(D);break;case"blue":k=ue(D);break;case"violet":k=me(D);break;case"gray":k=le(D);break;case"wind":k=pe(D);break;case"perlin":k=r(D);break;case"formant":k=l(D);break;case"dust":k=N(D);break;case"wood":k=p(D);break;default:k=Y(D);break}}catch(S){console.warn("[RC] seed generation failed, fallback pink",S);let D=2048;k=new Float32Array(D);for(let q=0;q<D;q++)k[q]=Math.random()*2-1}let _=Number(T.ksDurSec);Number.isFinite(_)||(_=1),_=Math.min(Math.max(_,.1),10);let C=Math.round(i*_),V=this.actx.createBuffer(2,C,i),$=String(T.smoothingMode??"auto"),I=this.midiSynth?.options?.[a]??{},E;if($==="manual"){let S=Number(T.smoothingFactor);Number.isFinite(S)||(S=.2),S<.01&&(S=.01),S>.99&&(S=.99),E=S}else try{let S=this.midiSynth?.inv127??.007874015748031496,D=Math.pow(n/64,.5)||0,q=n*S*.85+.15;typeof I.stringDamping=="number"?q=I.stringDamping:this.midiSynth?.options?.[a]&&(this.midiSynth.options[a].stringDamping=q);let Y=Number(I.stringDampingVariation??0);E=q+D*(1-q)*.5+(1-q)*Math.random()*Y}catch{E=.2}Number.isFinite(E)||(E=.2);let J=Number(T.velScale==null?1:T.velScale);try{let S=this.midiSynth?.asmWrapper?.[a];S&&typeof S.pluck=="function"&&S.pluck(V,k,i,m,E,t*J,I,.2)}catch(S){console.warn("[RC] pluck error",S);continue}let G=this.actx.createBufferSource();G.buffer=V;try{let S=this.midiSynth?.chmod?.[a];S&&G.detune&&S.connect(G.detune)}catch{}try{let S=this.midiSynth?.bend?.[a];typeof S=="number"&&G.detune&&(G.detune.value=S)}catch{}let U=this.actx.createGain();U.gain.setValueAtTime(1,d);let j=`${R.modId}_${n}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;x[a][j]={note:n,bfs:G,env:U,params:T,sustained:!1},G.addEventListener("ended",()=>{try{let S=this.liveNodes.get("__ksVoices__");S&&S[a]&&S[a][j]&&delete S[a][j]}catch{}}),G.connect(U);try{U.connect(R.outNode)}catch(S){console.warn("[RC] env.connect ksOut failed",S),delete x[a][j];continue}G.start(d),w=!0}return w}gateOsc(a,n,t){let c=Array.from(this.liveNodes.entries()).filter(([i])=>i.endsWith(":osc"));if(!c.length)return!1;let u=!1,s=(n??69)|0,d=this.actx.currentTime,m=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(s-69)/12);for(let[i,x]of c){let w=i.replace(":osc",""),R=this.liveNodes.get(w+":ch")??"all";if(!(R==="all"||Number(R)===a))continue;let k=this.liveNodes.get(w+":env"),_=this.liveNodes.get(w+":adsr")||{a:.003,d:.08,s:.4,r:.2};if(!k)continue;try{x.frequency.setValueAtTime(m,d)}catch{}let{a:C,d:V,s:$,r:I}=_,E=Number(this.liveNodes.get(w+":level")),J=Number.isFinite(E)?E:.15,G=t*J,U=C??.003,j=V??.08,S=$??.4,D=I??.2;k.gain.cancelScheduledValues(d),k.gain.setValueAtTime(0,d),k.gain.linearRampToValueAtTime(G,d+U),k.gain.linearRampToValueAtTime(S*G,d+U+j),u=!0}return u}releaseSourceEnv(a,n){let t=this.actx.currentTime;if((this.midiSynth?.pedal?.[a]??0)>=64)return!1;let u=!1,s=Array.from(this.liveNodes.entries()).filter(([d])=>d.endsWith(":osc"));if(!s.length)return!1;for(let[d]of s){let e=d.replace(":osc",""),m=this.liveNodes.get(e+":ch")??"all";if(!(m==="all"||Number(m)===a))continue;let x=this.liveNodes.get(e+":env"),w=this.liveNodes.get(e+":adsr")||{r:.2};if(!x?.gain)continue;let R=Math.max(.001,Number(w.r??.2));try{x.gain.cancelScheduledValues(t),x.gain.setValueAtTime(x.gain.value??0,t),x.gain.linearRampToValueAtTime(0,t+R),u=!0}catch{}}return u}releaseSustainKSForChannel(a){let n=this.actx.currentTime,t=this.liveNodes.get("__ksVoices__");if(!(!t||!t[a]))for(let[c,u]of Object.entries(t[a])){if(!u.sustained)continue;let{bfs:s,env:d,params:e}=u,m=Number(e?.ksRelease??.5),i=.02,w=i+(1.5-i)*Math.pow(m,2);d.gain.cancelScheduledValues(n),d.gain.setValueAtTime(d.gain.value??1,n),d.gain.linearRampToValueAtTime(0,n+w),s.stop(n+w+.05),u.sustained=!1,setTimeout(()=>{try{s.disconnect(),d.disconnect()}catch{}delete t[a][c]},(w+.05)*1e3)}}releaseOsc(a,n){let t=this.liveNodes&&this.liveNodes.get("__oscVoices__");if(!t||!t[a])return!1;let c=this.actx.currentTime,u=(this.midiSynth?.pedal?.[a]??0)>=64,s=Object.entries(t[a]).filter(([,d])=>d&&d.note===n);if(!s.length)return!1;for(let[d,e]of s){if(u){e.sustained=!0;continue}let m=e.env,i=e.osc,x=e.adsr&&Number.isFinite(e.adsr.r)?e.adsr.r:Number.isFinite(e.r)?e.r:.2,w=Math.max(.001,x);try{m&&m.gain&&(m.gain.cancelScheduledValues(c),m.gain.setValueAtTime(m.gain.value??0,c),m.gain.linearRampToValueAtTime(0,c+w))}catch{}try{i&&typeof i.stop=="function"&&i.stop(c+w+.02)}catch{}setTimeout(()=>{try{i&&i.disconnect&&i.disconnect()}catch{}try{m&&m.disconnect&&m.disconnect()}catch{}try{delete t[a][d]}catch{}},(w+.05)*1e3)}return!0}releaseAllSustainedOsc(a){let n=this.liveNodes&&this.liveNodes.get("__oscVoices__");if(!n||!n[a])return;let t=this.actx.currentTime;for(let[c,u]of Object.entries(n[a])){if(!u||!u.sustained)continue;let s=u.env,d=u.osc,e=u.adsr&&Number.isFinite(u.adsr.r)?u.adsr.r:Number.isFinite(u.r)?u.r:.2,m=Math.max(.001,e);try{s.gain.cancelScheduledValues(t),s.gain.setValueAtTime(s.gain.value??0,t),s.gain.linearRampToValueAtTime(0,t+m)}catch{}try{d.stop(t+m+.02)}catch{}u.sustained=!1,setTimeout(()=>{try{d.disconnect(),s.disconnect()}catch{}delete n[a][c]},(m+.05)*1e3)}}};function Oe(f){return f&&typeof f=="object"&&typeof f.kind=="string"}function we(f,a={}){let n=a.idPrefix||"";return Array.isArray(f)?f.filter(Oe).map(t=>{let c=t.id||`${t.kind}_${Math.random().toString(36).slice(2,9)}`;return{id:n?`${n}${c}`:c,kind:t.kind,enabled:t.enabled!==!1,params:typeof t.params=="object"&&t.params?{...t.params}:{}}}):null}function ke(f){if(!f)return null;if(Array.isArray(f)&&Array.isArray(f[0])){let u=f.map((s,d)=>we(s,{idPrefix:`c${d}_`})).filter(Boolean);return{version:1,chains:u,chainMeta:u.map(()=>({})),mutes:u.map(()=>!1)}}let a=f.chains;if(!Array.isArray(a))return null;let n=a.map((u,s)=>we(u,{idPrefix:`c${s}_`})).filter(Boolean),t=Array.isArray(f.chainMeta)?f.chainMeta.slice(0,n.length):[];for(;t.length<n.length;)t.push({});let c=Array.isArray(f.mutes)?f.mutes.slice(0,n.length):[];for(;c.length<n.length;)c.push(!1);return{version:Number(f.version)||1,chains:n,chainMeta:t,mutes:c}}function _e(f,a={}){let n=a.idPrefix||"",t=c=>(Array.isArray(c)?c:[]).map((u,s)=>{let d=u.id||`${u.kind}_${s}_${Math.random().toString(36).slice(2,8)}`;return{...u,id:n?`${n}${d}`:d,enabled:u.enabled!==!1,params:u.params||{}}});return Array.isArray(f)?{chain:t(f),meta:{},mute:!1}:f&&Array.isArray(f.chain)?{chain:t(f.chain),meta:f.meta||{},mute:!!f.mute}:null}import{Fragment as Me,jsx as O,jsxs as W}from"react/jsx-runtime";var K="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var Fe=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],ae={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:"all"},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function P(f="m"){return`${f}_${Math.random().toString(36).slice(2,9)}`}function Se(f,a,n){let t=f.slice(),c=Math.max(0,Math.min(t.length-1,a)),u=t.splice(c,1)[0],s=Math.max(0,Math.min(t.length,n));return t.splice(s,0,u),t}function ge({synth:f,initialState:a,onChange:n}){let t=Ce(null);t.current||(t.current=new oe);let c=t.current;L(()=>{if(f&&typeof c.setMidiSynth=="function")try{c.setMidiSynth(f),console.log("[RC] midi_synth attached to engine")}catch(r){console.warn("[RC] setMidiSynth failed",r)}},[f]);let u=()=>[[{id:P("ks"),kind:"ks_source",enabled:!0,params:{...ae.ks_source}},{id:P("gain"),kind:"gain",enabled:!0,params:{...ae.gain}},{id:P("an"),kind:"analyzer",enabled:!0,params:{}}]],[s,d]=ne(()=>{let r=a?.chains;return Array.isArray(r)&&r.length>0?r:u()}),[e,m]=ne(()=>{let r=a?.chainMeta;return Array.isArray(r)?r:[]}),[i,x]=ne(()=>{let r=a?.mutes;return Array.isArray(r)?r:[]}),w=Ce(i);L(()=>{w.current=i},[i]),L(()=>{x(r=>{let l=r.slice(0,s.length);for(;l.length<s.length;)l.push(!1);return l})},[s.length]),L(()=>{m(r=>{let l=(Array.isArray(r)?r:[]).slice(0,s.length);for(;l.length<s.length;)l.push({});return l})},[s.length]);let R=async r=>{try{let l=await fetch(r);if(!l.ok)throw new Error(`HTTP ${l.status}`);let N=await l.json(),p=ke(N);if(!p)throw new Error("Invalid routing JSON");d(p.chains),m(p.chainMeta),x(p.mutes),console.log("[RC] routing loaded from URL:",r)}catch(l){console.warn("[RC] loadFromURL failed:",l)}};async function T(r,l,N={}){let p=r|0;if(!(p<0)&&!(!N.force&&_(p)))try{let o=await fetch(l);if(!o.ok)throw new Error(`HTTP ${o.status}`);let h=await o.json(),v=_e(h,{idPrefix:`c${p}_`});if(!v||!v.chain)throw new Error("Invalid chain JSON");d(y=>{let b=Array.isArray(y)?y.slice():[];for(;b.length<p+1;)b.push([]);return b[p]=v.chain,b}),m(y=>{let b=Array.isArray(y)?y.slice():[];for(;b.length<p+1;)b.push({});return b[p]=v.meta||{},b}),x(y=>{let b=Array.isArray(y)?y.slice():[];for(;b.length<p+1;)b.push(!1);return b[p]=!!v.mute,b}),console.log("[RC] chain loaded from URL:",p,l)}catch(o){console.warn("[RC] loadChainFromURL failed:",o)}}let k=r=>{x(l=>{let N=[...l];return N[r]=!N[r],N})},_=r=>e?.[r]?.locked===!0;L(()=>(window.__RC_HANDLE__={midi:r=>{try{c.handleMIDIMsg&&c.handleMIDIMsg(r),console.log("[RC] MIDI -> engine",r)}catch(l){console.warn("[RC] MIDI ingress failed",l)}},engine:c,loadFromURL:R,loadChainFromURL:T,getState:()=>({chains:s,chainMeta:e,mutes:i}),setChainMeta:(r,l)=>{let N=r|0;!l||typeof l!="object"||m(p=>(Array.isArray(p)?p:[]).map((o,h)=>h===N?{...o||{},...l}:o))},setChainMute:(r,l)=>{let N=r|0;x(p=>(Array.isArray(p)?p:[]).map((o,h)=>h===N?!!l:o))}},()=>{try{delete window.__RC_HANDLE__}catch{}}),[c,s,e,i]),L(()=>{n&&n({chains:s,mutes:i,chainMeta:e})},[s,i,e,n]);let[C,V]=ne({open:!1,idx:null,step:1}),$=r=>{_(r)||V({open:!0,idx:r,step:1})},I=()=>V({open:!1,idx:null,step:1}),E=()=>V(r=>({...r,step:2})),J=()=>{d(r=>{let l=r.filter((N,p)=>p!==C.idx);return l.length?l:[[{id:P("src"),kind:"source",enabled:!0,params:{...ae.source}},{id:P("gain"),kind:"gain",enabled:!0,params:{...ae.gain}},{id:P("an"),kind:"analyzer",enabled:!0,params:{}}]]}),I()};L(()=>{try{c.buildMany(s),c.resume&&c.resume(),w.current.forEach((r,l)=>{typeof c.setChainMute=="function"&&c.setChainMute(l,r)})}catch(r){console.warn("[RC] buildMany failed",r)}},[c,JSON.stringify(s)]),L(()=>{i.forEach((r,l)=>{typeof c.setChainMute=="function"&&c.setChainMute(l,r)})},[c,i]),L(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(r=>{for(let l of r.inputs.values())l.onmidimessage=N=>c.handleMIDIMsg(N.data)})},[]);let G=(r,l)=>{_(r)||d(N=>{let p=N.map(o=>[...o]);return p[r]=[...p[r],{id:P(l),kind:l,enabled:!0,params:{...ae[l]}}],p})},U=(r,l)=>{_(r)||d(N=>N.map((p,o)=>o!==r?p:p.map(h=>h.id===l?{...h,enabled:!h.enabled}:h)))},j=(r,l)=>{_(r)||d(N=>N.map((p,o)=>o!==r?p:p.filter(h=>h.id!==l)))},S=(r,l,N,p)=>{_(r)||(N==="gain"&&(c.updateGainNodeById(l,p)||console.warn("[RC] gain node not found for id:",l)),d(o=>o.map((h,v)=>v!==r?h:h.map(y=>y.id===l?{...y,params:{...y.params,[N]:p}}:y))))},[D,q]=ne(null),Y=(r,l)=>N=>{_(r)||(q({chain:r,from:l}),N.dataTransfer.effectAllowed="move",N.dataTransfer.setData("text/plain",`${r}:${l}`))},ie=(r,l)=>N=>{_(r)||(N.preventDefault(),!(!D||D.chain!==r)&&(d(p=>p.map((o,h)=>h!==r?o:Se(o,D.from,l))),q(null)))},le=r=>l=>{_(r)||(l.preventDefault(),!(!D||D.chain!==r)&&(d(N=>N.map((p,o)=>o!==r?p:Se(p,D.from,p.length))),q(null)))},de=r=>d(l=>{let N=l.map(o=>[...o]),p=N[r].map(o=>({...o,id:P(o.kind)}));return N.splice(r+1,0,p),N}),ue=r=>{let l=s[r];if(!l)return;let N=l,p=new Blob([JSON.stringify(N,null,2)],{type:"application/json"}),o=URL.createObjectURL(p),h=document.createElement("a");h.href=o,h.download=`audio-chain-${r+1}.json`,h.click(),URL.revokeObjectURL(o)},me=async(r,l)=>{if(_(chainIdx))return;let N=await l.text();try{let p=JSON.parse(N);if(!Array.isArray(p))return;let o=p.map(h=>({id:P(h.kind||"mod"),kind:h.kind||"gain",enabled:h.enabled!==!1,params:h.params||{}}));d(h=>h.map((v,y)=>y===r?o:v))}catch(p){console.warn("[RC] importChain failed",p)}},he=()=>d(r=>[...r,[]]),re=()=>{let r=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),l=URL.createObjectURL(r),N=document.createElement("a");N.href=l,N.download="audio-chains.json",N.click(),URL.revokeObjectURL(l)},pe=async r=>{let l=await r.text();try{let N=JSON.parse(l);Array.isArray(N)&&Array.isArray(N[0])&&d(N)}catch(N){console.warn("Invalid chain JSON",N)}};return W("div",{className:"p-6 text-white",children:[O("div",{className:"flex items-center justify-between mb-4",children:W("div",{className:"flex items-center gap-2 flex-wrap",children:[O("button",{className:K,onClick:re,children:"Export"}),W("label",{className:`${K} cursor-pointer`,children:["Import",O("input",{type:"file",accept:"application/json",className:"hidden",onChange:r=>{let l=r.target.files?.[0];l&&pe(l)}})]}),O("button",{className:K,onClick:()=>{typeof c.buildMultiFrom=="function"?c.buildMultiFrom(s[0],Array.from({length:16},(r,l)=>l)):d(r=>{let l=r[0]||[];return Array.from({length:16},(p,o)=>l.map(h=>({...h,id:P(h.kind)+`_ch${o}`,params:h.kind==="ks_source"?{...h.params,ch:String(o)}:{...h.params}})))})},children:"Duplicate to 16 channels"})]})}),W("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:[s.map((r,l)=>{let N=_(l);return W("div",{className:`mb-6 rounded-lg p-2
              ${N?"bg-neutral-900/60 border border-yellow-500/40":""}`,children:[W("div",{className:"flex items-center justify-between mb-2",children:[O("div",{className:"text-sm opacity-80",children:e[l]?.name??`Chain #${l+1}`}),N&&O("span",{className:`text-xs px-2 py-0.5 rounded\r
                            border border-yellow-400\r
                            text-yellow-400\r
                            bg-transparent\r
                            opacity-100`,title:"This chain is locked (GUI editing disabled)",children:"\u{1F512} Locked"}),W("div",{className:"flex gap-2 items-center",children:[O("button",{className:K,onClick:()=>k(l),title:i[l]?"Unmute chain":"Mute chain",children:i[l]?"\u{1F507}":"\u{1F50A}"}),O("button",{className:K,onClick:()=>ue(l),children:"Export"}),W("label",{className:`${K} cursor-pointer`,children:["Import",O("input",{type:"file",accept:"application/json",className:"hidden",onChange:p=>{let o=p.target.files?.[0];o&&me(l,o),p.target.value=""}})]}),O("button",{className:K,onClick:()=>de(l),children:"Duplicate"}),O("button",{className:K,onClick:()=>$(l),children:"Delete"})]})]}),W("div",{className:"flex gap-3 items-stretch",children:[r.map((p,o)=>O("div",{onDrop:ie(l,o),onDragOver:h=>h.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:O(fe,{mod:p,onToggle:()=>U(l,p.id),onRemove:()=>j(l,p.id),onParam:(h,v)=>S(l,p.id,h,v),onDragStart:Y(l,o)})},p.id)),O("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:p=>p.preventDefault(),onDrop:le(l),children:"\u2192"})]}),O("div",{className:"mt-3 flex flex-wrap gap-2",children:Fe.map(p=>W("button",{className:K,onClick:()=>G(l,p),children:["+ ",p]},`${l}-${p}`))})]},l)}),O("div",{className:"mt-2 flex justify-center",children:O("button",{className:K,onClick:he,children:"+ Add chain"})})]}),C.open&&O("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:O("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:C.step===1?W(Me,{children:[O("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),O("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),W("div",{className:"flex justify-end gap-2",children:[O("button",{className:K,onClick:I,children:"Cancel"}),O("button",{className:K,onClick:E,children:"Next"})]})]}):W(Me,{children:[O("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),O("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),W("div",{className:"flex justify-end gap-2",children:[O("button",{className:K,onClick:I,children:"Cancel"}),O("button",{className:K,onClick:J,children:"Delete"})]})]})})})]})}import{jsx as z,jsxs as X}from"react/jsx-runtime";function se({synth:f,buttonTarget:a,autoTailwind:n=!1,showButton:t=!0,initialState:c,onChange:u}){let[s,d]=be(!1);ce(()=>{if(!s)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(C){console.warn("[RC] resumeAll failed",C)}})()},[s]);let[e,m]=be(.3),[i,x]=be(()=>f?.a4_freq??440);ce(()=>{typeof f?.a4_freq=="number"&&x(Number(f.a4_freq))},[f]),ce(()=>{let _=i,C=setInterval(()=>{let V=Number(f?.a4_freq??440);!Number.isNaN(V)&&V!==_&&(_=V,x(V))},250);return()=>clearInterval(C)},[f,i]);let w=420,T=Math.max(0,Math.min(1,(i-w)/(460-w)))*100;ce(()=>{if(!n||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let C=document.createElement("script");C.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",C.dataset.rcTailwind="1",document.head.appendChild(C)},[n]);let k=()=>z("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>d(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return X("div",{children:[z("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        /* \u9810\u8A2D\u6DFA\u8272\u6A21\u5F0F \u2192 \u6DF1\u5929\u7A7A\u85CD */
        :root {
          --rc-toggle-text: #38bdf8; /* sky-400 */
        }

        /* \u6DF1\u8272\u6A21\u5F0F \u2192 \u6DFA\u5929\u7A7A\u85CD */
        @media (prefers-color-scheme: dark) {
          :root {
            --rc-toggle-text: #7dd3fc; /* sky-300 */
          }
        }
        /* \u5957\u5230\u6253\u958B GUI \u7684\u6309\u9215 */
        .rc-toggle-btn {
          color: var(--rc-toggle-text) !important;
        }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),t&&(a?Ge.createPortal(z(k,{}),a):z("div",{className:"rc-fixed-default",children:z(k,{})})),z("div",{className:"rc-overlay",style:{display:s?"flex":"none"},onClick:_=>{_.target===_.currentTarget&&d(!1)},children:X("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[X("div",{className:"rc-header",children:[X("div",{className:"flex items-center gap-4",children:[z("div",{children:"Routing Composer"}),X("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[z("span",{children:"A4"}),z("input",{type:"range",min:"420",max:"460",step:"0.1",value:i,className:"rc-slider",style:{"--rc-pos":`${(i-420)/40*100}%`,width:160},onChange:_=>{let C=Number(_.target.value);Number.isNaN(C)||(x(C),f&&(f.a4_freq=C))}}),X("span",{children:[i.toFixed(1),"Hz"]})]}),X("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[z("span",{children:"Vol"}),z("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,className:"rc-slider",style:{"--rc-pos":`${e*100}%`,width:160},onChange:_=>{let C=Number(_.target.value);Number.isNaN(C)||(m(C),midi_synth&&midi_synth.setMasterVol(C))}}),X("span",{children:[(e*100).toFixed(0),"%"]})]})]}),X("div",{className:"flex items-center gap-2",children:[z("button",{className:"rc-close",onClick:()=>f?.actx?.resume?.(),children:"Resume Audio"}),z("button",{className:"rc-close",onClick:()=>d(!1),children:"Close"})]})]}),z("div",{className:"rc-body",children:z(ge,{synth:f,initialState:c,onChange:u})})]})})]})}import{jsx as Ae}from"react/jsx-runtime";var ot=se;(function(){if(typeof window>"u")return;let a={mount(n={}){let{synth:t,button:c,tailwind:u="auto"}=n,s=null;c&&(typeof c=="string"?s=document.querySelector(c):c instanceof HTMLElement&&(s=c));let d=document.createElement("div");return document.body.appendChild(d),ve.createRoot?ve.createRoot(d).render(Ae(se,{synth:t,buttonTarget:s,autoTailwind:u==="auto",showButton:n.showButton!==!1,initialState:n.initialState,onChange:n.onChange})):ve.render(Ae(se,{synth:t,buttonTarget:s,autoTailwind:u==="auto",showButton:n.showButton!==!1,initialState:n.initialState,onChange:n.onChange}),d),console.log("[RoutingComposer] mounted GUI"),{host:d}}};window.RoutingComposer=a})();export{ot as default};
