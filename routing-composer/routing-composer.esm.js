var Ae=Object.defineProperty;var Re=(N,a,n)=>a in N?Ae(N,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):N[a]=n;var pe=(N,a,n)=>Re(N,typeof a!="symbol"?a+"":a,n);import"react";import de from"react-dom";import{useEffect as ie,useState as le}from"react";import Ve from"react-dom";import{useEffect as se,useState as re,useRef as De}from"react";import"react";import{Fragment as Z,jsx as u,jsxs as V}from"react/jsx-runtime";var Te="rounded-2xl shadow-lg border border-white/10 bg-neutral-900/70 backdrop-blur p-3 select-none",fe="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";function B({label:N,min:a,max:n,step:t=.01,value:s,onChange:c,suffix:l}){let e=typeof s=="number"?(Math.round(s*100)/100).toFixed(2):String(s??""),d=Number(s??0),r=Number(a??0),A=Number(n??1),k=Math.max(0,Math.min(1,(d-r)/(A-r)))*100;return V("div",{className:"flex items-center gap-3",children:[u("div",{className:"w-24 text-sm opacity-80",children:N}),u("input",{type:"range",className:"w-48 rc-slider",min:a,max:n,step:t,value:Number(s??0),onChange:D=>c(Number(D.target.value)),style:{"--rc-pos":`${k}%`}}),V("div",{className:"w-20 tabular-nums text-right text-xs opacity-70",children:[e,l?u("span",{className:"opacity-60",children:l}):null]})]})}function oe({mod:N,onToggle:a,onRemove:n,onParam:t}){let{kind:s,enabled:c,params:l={}}=N;return V("div",{className:`${Te} w-[280px]`,children:[V("div",{className:"flex items-center justify-between",children:[u("div",{className:"font-semibold capitalize",children:s}),V("div",{className:"flex gap-2",children:[u("button",{className:fe,onClick:a,children:c?"Bypass":"Enable"}),u("button",{className:fe,onClick:n,title:"Remove module",children:"\xD7"})]})]}),u("div",{className:"mt-2 text-xs opacity-70",children:c?"active":"bypassed"}),V("div",{className:"mt-3 space-y-2",children:[s==="ks_source"&&V(Z,{children:[V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),V("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,d)=>u("option",{value:String(d),children:d},d))]})]}),V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"Program"}),V("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.program??"all"),onChange:e=>t("program",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:128},(e,d)=>u("option",{value:String(d),children:d},d))]})]}),V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"smoothing"}),u("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.smoothingMode??"auto"),onChange:e=>t("smoothingMode",e.target.value),children:["auto","manual"].map(e=>u("option",{value:e,children:e},e))})]}),String(l.smoothingMode??"auto")==="manual"&&u(B,{label:"smooth",min:0,max:1,value:Number(l.smoothingFactor??.2),onChange:e=>t("smoothingFactor",e)}),u(B,{label:"velScale",min:0,max:1,value:Number(l.velScale??1),onChange:e=>t("velScale",e)}),u(B,{label:"KS dur",min:.1,max:10,step:.1,value:Number(l.ksDurSec??1),onChange:e=>t("ksDurSec",e),suffix:"s"}),u(B,{label:"Release",min:0,max:1,step:.01,value:Number(l.ksRelease??.5),onChange:e=>t("ksRelease",e)}),V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"Noise"}),V("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.seedNoiseType??"pink"),onChange:e=>t("seedNoiseType",e.target.value),children:[u("option",{value:"brown",children:"Soft"}),u("option",{value:"softBrown",children:"Extra Soft"}),u("option",{value:"red",children:"Deep Soft"}),u("option",{value:"pink",children:"Warm"}),u("option",{value:"softPink",children:"Warm Soft"}),u("option",{value:"white",children:"Bright"}),u("option",{value:"blue",children:"Airy"}),u("option",{value:"violet",children:"Breathy"}),u("option",{value:"wind",children:"Windy"}),u("option",{value:"perlin",children:"Organic"}),u("option",{value:"formant",children:"Body"}),u("option",{value:"dust",children:"Dusty"}),u("option",{value:"wood",children:"Woody"}),u("option",{value:"grey",children:"Mix"})]})]}),String(l.smoothingMode??"auto")==="auto"&&u("div",{className:"text-[11px] opacity-70",children:"auto: smoothing \u4F9D\u64DA synth.options[ch].stringDamping / variation \u8207 note \u8A08\u7B97"})]}),s==="source"&&V(Z,{children:[V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"MIDI ch"}),V("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(N.params.ch??"all"),onChange:e=>t("ch",e.target.value),children:[u("option",{value:"all",children:"all"}),Array.from({length:16},(e,d)=>u("option",{value:String(d),children:d},d))]})]}),V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"wave"}),u("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(N.params.type),onChange:e=>t("type",e.target.value),children:["sine","square","sawtooth","triangle"].map(e=>u("option",{value:e,children:e},e))})]}),u(B,{label:"attack",min:0,max:.2,value:Number(N.params.adsr?.a??.003),onChange:e=>t("adsr",{...N.params.adsr||{},a:e})}),u(B,{label:"decay",min:0,max:1,value:Number(N.params.adsr?.d??.08),onChange:e=>t("adsr",{...N.params.adsr||{},d:e})}),u(B,{label:"sustain",min:0,max:1,value:Number(N.params.adsr?.s??.4),onChange:e=>t("adsr",{...N.params.adsr||{},s:e})}),u(B,{label:"release",min:0,max:2,value:Number(N.params.adsr?.r??.2),onChange:e=>t("adsr",{...N.params.adsr||{},r:e})})]}),s==="filter"&&V(Z,{children:[V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"mode"}),u("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.mode??"lowpass"),onChange:e=>t("mode",e.target.value),children:["lowpass","highpass","bandpass","notch"].map(e=>u("option",{value:e,children:e},e))})]}),u(B,{label:"freq",min:50,max:12e3,value:Number(l.freq??1200),onChange:e=>t("freq",e)}),u(B,{label:"Q",min:.1,max:20,value:Number(l.q??.7),onChange:e=>t("q",e)})]}),s==="delay"&&V(Z,{children:[u(B,{label:"time",min:.01,max:1.2,value:Number(l.time??.25),onChange:e=>t("time",e)}),u(B,{label:"feedback",min:0,max:.95,value:Number(l.feedback??.35),onChange:e=>t("feedback",e)}),u(B,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),s==="reverb"&&V(Z,{children:[u(B,{label:"decay",min:.2,max:6,value:Number(l.decay??2),onChange:e=>t("decay",e)}),u(B,{label:"mix",min:0,max:1,value:Number(l.mix??.25),onChange:e=>t("mix",e)})]}),s==="convolver_ir"&&V(Z,{children:[V("div",{className:"flex items-center gap-2",children:[u("div",{className:"w-24 text-sm opacity-80",children:"IR"}),u("select",{className:"bg-neutral-900 text-white border border-white/20 rounded-lg px-2 py-1 text-sm",value:String(l.irId??"IR_Gibson"),onChange:e=>t("irId",e.target.value),children:["IR_Gibson","IR_piezo"].map(e=>u("option",{value:e,children:e},e))})]}),u(B,{label:"mix",min:0,max:1,value:Number(l.mix??.3),onChange:e=>t("mix",e)})]}),s==="gain"&&u(B,{label:"gain",min:0,max:1.5,value:Number(l.gain??.8),onChange:e=>t("gain",e)}),s==="analyzer"&&u("div",{className:"text-xs opacity-70",children:"tap to scope (no sound change)"})]})]})}var ne=class{constructor(a){pe(this,"handleMIDIMsg",a=>{let n=a[0],t=a[1],s=a[2],c=n&240,l=n&15;c===144&&s>0?this.gate(!0,s/127,l,t):(c===128||c===144&&s===0)&&this.gate(!1,0,l,t)});this.midiSynth=void 0,this.actx=a||new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.liveNodes=new Map,this._bendCS=Object.create(null),this.liveNodes=new Map,this.mixers=Array.from({length:16},()=>{let n=this.actx.createGain();return n.gain.value=1,n}),setTimeout(()=>{if(this.midiSynth?.chvol)for(let n=0;n<16;n++)try{this.mixers[n].connect(this.midiSynth.chvol[n]),console.log(`[RC] mixer[ch${n}] -> chvol[ch${n}]`)}catch(t){console.warn(`[RC] mixer[ch${n}] connect failed`,t)}},1e3),setInterval(()=>{try{this.actx?.state==="suspended"&&this.actx.resume(),this.midiSynth?.actx?.state==="suspended"&&this.midiSynth.actx.resume()}catch{}},2e3)}updateGainNodeById(a,n){let t=this.liveNodes?.get(a+":node");if(!t||!t.gain)return!1;let s=this.actx.currentTime;try{t.gain.cancelScheduledValues(s),t.gain.setTargetAtTime(Number(n)||0,s,.01)}catch{t.gain.value=Number(n)||0}return!0}getBendNode(a){if(this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15,this._bendCS[a])return this._bendCS[a];let n=this.actx.createConstantSource();return n.offset.value=0,n.start(),this._bendCS[a]=n,n}updateBend(a,n){this._bendCS||(this._bendCS=Object.create(null)),a=(a|0)&15;let t=this.getBendNode(a),s=Number.isFinite(n)?n:0;try{let c=this.actx.currentTime;t.offset.cancelScheduledValues(c),t.offset.setTargetAtTime(s,c,.01)}catch{t.offset.value=s}}setMidiSynth(a){this.midiSynth=a;let n=a&&(a.actx||a.audioContext);if(n&&n!==this.actx){try{this.masterGain?.disconnect()}catch{}this.actx=n,this.masterGain=this.actx.createGain(),this.masterGain.gain.value=.9,this.masterGain.connect(this.actx.destination),this.analyser=this.actx.createAnalyser(),this.analyser.fftSize=2048,this.mixers=Array.from({length:16},()=>{let t=this.actx.createGain();return t.gain.value=1,t}),console.log("[RC] adopted synth AudioContext and rebuilt mixers")}if(a?.chvol&&this.mixers)for(let t=0;t<16;t++)try{try{this.mixers[t].disconnect()}catch{}this.mixers[t].connect(a.chvol[t])}catch(s){console.warn(`[RC] mixer[ch${t}] -> chvol connect failed`,s)}}async resume(){this.actx.state!=="running"&&await this.actx.resume();try{this.midiSynth?.actx?.state!=="running"&&await this.midiSynth.actx.resume()}catch{}}build(a){this.liveNodes.clear();let n=c=>{let l=c.kind,e=c.params||{},d=this.actx;if(!c.enabled){let r=d.createGain();return{in:r,out:r}}switch(l){case"ks_source":{let r=d.createGain();return this.liveNodes.set(c.id+":ksOut",r),this.liveNodes.set(c.id+":ksParams",e),this.liveNodes.set("__lastKsId__",c.id),this.liveNodes.set("keyboardTarget",r),{in:r,out:r}}case"source":{let r=d.createOscillator();r.type=e.type||"sawtooth";let A=d.createGain();return A.gain.value=0,r.connect(A),r.start(),this.liveNodes.set(c.id+":osc",r),this.liveNodes.set(c.id+":env",A),this.liveNodes.set(c.id+":oscType",r.type),this.liveNodes.set(c.id+":ch",e.ch??"all"),this.liveNodes.set(c.id+":adsr",e.adsr||{a:.003,d:.08,s:.4,r:.2}),this.liveNodes.set("__oscType__",r.type),this.liveNodes.set("keyboardTarget",A),{in:A,out:A}}case"gain":{let r=this.actx.createGain();return r.gain.value=Number(e.gain??1),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}case"filter":{let r=d.createBiquadFilter();return r.type=e.mode||"lowpass",r.frequency.value=Number(e.freq||1200),r.Q.value=Number(e.q||.7),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}case"delay":{let r=d.createDelay(2);r.delayTime.value=Number(e.time||.25);let A=d.createGain();A.gain.value=Number(e.feedback||.3);let k=d.createGain();k.gain.value=Number(e.mix||.3);let D=d.createGain(),S=d.createGain(),x=d.createGain();return x.gain.value=1-k.gain.value,D.connect(r),D.connect(x),r.connect(A).connect(r),r.connect(k),x.connect(S),k.connect(S),this.liveNodes.set(c.id+":node",{input:D,output:S,delay:r,fb:A,mix:k}),{in:D,out:S}}case"analyzer":{let r=d.createGain();return r.connect(this.analyser),this.liveNodes.set(c.id+":node",r),{in:r,out:r}}default:{let r=d.createGain();return{in:r,out:r}}}},t=null,s=null;for(let c of a){let{in:l,out:e}=n(c);t||(t=l),s&&s.connect(l),s=e}t&&this.liveNodes.set("__chainHead__",t),s&&this.liveNodes.set("__chainTail__",s);try{let l=a.find(d=>d.kind==="ks_source"||d.kind==="source")?.params?.ch??"all",e=l==="all"?Array.from({length:16},(d,r)=>r):[Number(l)];for(let d of e){let r=this.mixers[d];s&&r&&s.connect(r)}}catch(c){console.warn("[RC] mixer connect failed",c)}}buildMany(a){let t=this.liveNodes.get("__oscVoices__"),s=new Map;for(let c of a){let l=new Map;this.liveNodes=l,this.build(c);for(let[e,d]of l.entries())s.set(e,d)}t&&s.set("__oscVoices__",t),this.liveNodes=s}gate(a,n=.8,t=0,s=69){let c=this.actx.currentTime,l=(s??69)|0,e=!1;if(a){let d=this.pluckKS(t,s??69,n)===!0,r=this.gateOsc(t,s,n)===!0;e=d||r}if(a&&!e){let r=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(l-69)/12),A=[];for(let[T,R]of this.liveNodes.entries())if(T.endsWith(":oscType")){let F=T.split(":")[0],z=this.liveNodes.get(F+":ch")??"all",$=this.liveNodes.get(F+":adsr")||{a:.003,d:.08,s:.4,r:.2},I=R||"sawtooth";(z==="all"||Number(z)===t)&&A.push({modId:F,type:I,adsr:$})}if(!A.length){let T=this.liveNodes.get("__oscType__")||"sawtooth";A.push({modId:null,type:T,adsr:{a:.003,d:.08,s:.4,r:.2}})}let k=this.liveNodes.get("__chainTail__"),D=this.liveNodes.get("__chainHead__"),S=this.liveNodes.get("keyboardTarget"),x=this.midiSynth?.chvol?.[t];this.liveNodes.has("__oscVoices__")||this.liveNodes.set("__oscVoices__",{});let m=this.liveNodes.get("__oscVoices__");m[t]||(m[t]={});for(let T of A){let R=this.actx.createOscillator();try{R.type=T.type}catch{R.type="sawtooth"}R.frequency.setValueAtTime(r,c);try{let h=this.midiSynth?.chmod?.[t];h&&R.detune&&h.connect(R.detune);let _=this.getBendNode(t);R.detune&&_&&_.connect(R.detune),typeof this.midiSynth?.bend?.[t]=="number"&&this.updateBend(t,this.midiSynth.bend[t])}catch(h){console.warn("[RC] osc detune connect failed",h)}let F=this.actx.createGain();F.gain.setValueAtTime(0,c);let{a:z,d:$,s:I,r:Y}=T.adsr;F.gain.linearRampToValueAtTime(n,c+(z??.003)),F.gain.linearRampToValueAtTime((I??.4)*n,c+(z??.003)+($??.08)),R.connect(F);let i=null;if(D&&D!==S?i=D:k?i=k:x&&(i=x),!i&&x&&(i=x),i){F.connect(i);try{let h=this.mixers?.[t];if(k&&h)if(k.context===this.actx&&h.context===this.actx)k.connect(h);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let _=this.mixers?.[t];k.context===this.actx&&_?.context===this.actx&&k.connect(_)}catch{}}}catch(h){console.warn("[RC] mixer connect failed",h)}}R.start(c);let p=`${l}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;m[t][p]={note:l,osc:R,env:F,r:Y??.2}}}if(!a){let d=this.actx.currentTime,r=this.liveNodes.get("__ksVoices__"),A=(this.midiSynth?.pedal?.[t]??0)>=64;if(r&&r[t]){let S=Object.entries(r[t]).filter(([x,m])=>m.note===l);for(let[x,m]of S){let{bfs:T,env:R}=m;if(A){m.sustained=!0;continue}try{let F=Number(m.params?.ksRelease??.5),z=.02,I=z+(1.5-z)*Math.pow(F,2);R.gain.cancelScheduledValues(d),R.gain.setValueAtTime(R.gain.value??1,d),R.gain.linearRampToValueAtTime(0,d+I),T.stop(d+I+.05),setTimeout(()=>{try{T.disconnect(),R.disconnect()}catch{}delete r[t][x]},(I+.05)*1e3)}catch{delete r[t][x]}}}let k=this.liveNodes.get("__oscVoices__");if(!k||!k[t])return;let D=Object.entries(k[t]).filter(([S,x])=>x.note===l);for(let[S,x]of D){let{osc:m,env:T,r:R=.2}=x;try{T.gain.cancelScheduledValues(d),T.gain.setValueAtTime(T.gain.value??0,d),T.gain.linearRampToValueAtTime(0,d+R),m.stop(d+R+.05),setTimeout(()=>{try{m.disconnect(),T.disconnect()}catch{}delete k[t][S]},(R+.1)*1e3)}catch{delete k[t][S]}}}}pluckKS(a,n,t){let s=Array.from(this.liveNodes.entries()).filter(([o])=>o.endsWith(":ksOut"));if(!s.length)return!1;let c=null,l={},e=[],d=Number(this.midiSynth&&this.midiSynth.pg?this.midiSynth.pg[a]:0);for(let[o,f]of s){let q=this.liveNodes.get(o.replace(":ksOut",":ksParams"))||{},G=q.ch!=null?String(q.ch):"all",X=G==="all"||Number(G)===a,P=q.program;(P==null||P==="all")&&(P="all");let ae=P==="all"?null:Number(P);X&&(ae===null||ae===d)&&(c||(c=[o,f],l=q),e.push(f))}if(!c)return console.warn("[RC] no ks_source matches ch/pg",{ch:a,curPg:d}),!1;let r=c[0],A=c[1],k=l,S=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(n-69)/12),x=this.actx.sampleRate,m=null;try{let o=String(k.seedNoiseType??"pink"),f=Math.max(2048,Math.round(x/Math.max(1e-6,S))),q=g=>{let w=new Float32Array(g);for(let b=0;b<g;b++)w[b]=Math.random()*2-1;return w},G=g=>{let w=new Float32Array(g),b=0,y=0,v=0,M=0,C=0,K=0,Q=0;for(let L=0;L<g;L++){let H=Math.random()*2-1;b=.99886*b+H*.0555179,y=.99332*y+H*.0750759,v=.969*v+H*.153852,M=.8665*M+H*.3104856,C=.55*C+H*.5329522,K=-.7616*K-H*.016898,w[L]=(b+y+v+M+C+K+Q*.5362)*.11,Q=H*.115926}return w},X=g=>{let w=new Float32Array(g),b=0;for(let y=0;y<g;y++)b+=Math.random()*2-1,b=Math.max(-8,Math.min(8,b)),w[y]=b/8;return w},P=g=>{let w=q(g),b=G(g),y=new Float32Array(g);for(let v=0;v<g;v++)y[v]=.6*w[v]+.4*b[v];return y},ae=g=>{let w=new Float32Array(g),b=0,y=0;for(let v=0;v<g;v++)b+=(Math.random()*2-1)*.02,y+=b,w[v]=y*5e-4;return w},ue=g=>{let w=new Float32Array(g),b=0;for(let M=0;M<g;M++){let C=Math.random()*2-1;w[M]=C-b,b=C}let y=new Float32Array(g),v=0;for(let M=0;M<g;M++)v=v*.992+w[M]*.008,y[M]=v;return y},ye=g=>{let w=new Float32Array(g),b=0;for(let M=0;M<g;M++){let C=Math.random()*2-1;w[M]=C-b,b=C}let y=new Float32Array(g),v=0;for(let M=0;M<g;M++)v=v*.995+w[M]*.005,y[M]=v;return y},Ne=g=>{let w=X(g),b=new Float32Array(g),y=0;for(let v=0;v<g;v++)y=y*.995+w[v]*.005,b[v]=y*.9;return b},me=g=>{let w=G(g),b=new Float32Array(g),y=0;for(let v=0;v<g;v++)y=y*.993+w[v]*.007,b[v]=y*.9;return b},we=g=>{let w=new Float32Array(g),b=0,y=0;for(let v=0;v<g;v++){let M=Math.random()*2-1;b=b*.985+M*.015,y=y*.995+(Math.random()*2-1)*.005;let C=.6+.4*y;w[v]=b*C}return w},ke=g=>{let w=new Float32Array(g),b=Math.max(8,Math.floor(g/64)),y=[],v=Math.floor(g/b)+2;for(let C=0;C<v;C++)y[C]=Math.random()*2-1;let M=C=>C*C*C*(C*(C*6-15)+10);for(let C=0;C<g;C++){let K=C/b,Q=Math.floor(K),L=K-Q,H=y[Q],Me=y[Q+1],he=M(L);w[C]=(H*(1-he)+Me*he)*.9}return w},_e=g=>{let w=new Float32Array(g),b=q(g),y=300,v=800,M=2500;for(let C=0;C<g;C++){let K=C/x,Q=1+.6*Math.sin(2*Math.PI*y*K)+.4*Math.sin(2*Math.PI*v*K+1.3)+.25*Math.sin(2*Math.PI*M*K+.7);w[C]=b[C]*(Q*.25)}return w},Se=g=>{let w=new Float32Array(g),b=0,y=.004;for(let v=0;v<g;v++)Math.random()<y&&(b+=(Math.random()*2-1)*.9),b*=.96,w[v]=b;return w},Ce=g=>{let w=me(g),b=new Float32Array(g),y=220,v=550;for(let M=0;M<g;M++){let C=M/x,K=.5*Math.sin(2*Math.PI*y*C)+.35*Math.sin(2*Math.PI*v*C+1.1);b[M]=w[M]*(1+.4*K)}return b};switch(o){case"white":m=q(f);break;case"pink":m=G(f);break;case"brown":m=X(f);break;case"softBrown":m=Ne(f);break;case"softPink":m=me(f);break;case"red":m=ae(f);break;case"blue":m=ue(f);break;case"violet":m=ye(f);break;case"gray":m=P(f);break;case"wind":m=we(f);break;case"perlin":m=ke(f);break;case"formant":m=_e(f);break;case"dust":m=Se(f);break;case"wood":m=Ce(f);break;default:m=G(f);break}}catch(o){console.warn("[RC] seed generation failed, fallback pink",o);let f=2048;m=new Float32Array(f);for(let q=0;q<f;q++)m[q]=Math.random()*2-1}if(console.log("[RC] seed check",m?.length,m?.[0]),!m||!m.length){console.warn("[RC] seed invalid, injecting pink noise");let o=Math.max(2048,Math.round(x/Math.max(1e-6,S)));m=new Float32Array(o);for(let f=0;f<o;f++)m[f]=Math.random()*2-1}let T=Number(k.ksDurSec);Number.isFinite(T)||(T=1),T=Math.min(Math.max(T,.1),10);let R=Math.round(x*T),F=this.actx.createBuffer(2,R,x),z=String(k.smoothingMode??"auto"),$=this.midiSynth?.options?.[a]??{},I;if(z==="manual"){let o=Number(k.smoothingFactor);Number.isFinite(o)||(o=.2),o<.01&&(o=.01),o>.99&&(o=.99),I=o}else try{let o=this.midiSynth?.inv127??.007874015748031496,f=Math.pow(n/64,.5)||0,q=n*o*.85+.15;typeof $.stringDamping=="number"?q=$.stringDamping:this.midiSynth?.options?.[a]&&(this.midiSynth.options[a].stringDamping=q);let G=Number($.stringDampingVariation??0);I=q+f*(1-q)*.5+(1-q)*Math.random()*G}catch{I=.2}Number.isFinite(I)||(I=.2);let Y=Number(k.velScale==null?1:k.velScale);if(Object.keys($).length===0&&($.stringDamping=.5,$.stringDampingVariation=.2),Number.isFinite(I)||(I=.2),!m||!m.length){console.warn("[RC] seed invalid, injecting pink noise");let o=Math.max(2048,Math.round(x/Math.max(1e-6,S)));m=new Float32Array(o);for(let f=0;f<o;f++)m[f]=Math.random()*2-1}try{let o=this.midiSynth?.asmWrapper?.[a];o&&typeof o.pluck=="function"&&o.pluck(F,m,x,S,I,t*Y,$,.2)}catch(o){console.warn("[RC] pluck error",o)}let i=this.actx.createBufferSource();i.buffer=F;try{let o=this.midiSynth?.chmod?.[a];o&&i.detune&&o.connect(i.detune)}catch{}try{let o=this.midiSynth?.bend?.[a];typeof o=="number"&&i.detune&&(i.detune.value=o)}catch{}let p=this.actx.createGain();p.gain.setValueAtTime(1,this.actx.currentTime),this.liveNodes.has("__ksVoices__")||this.liveNodes.set("__ksVoices__",{});let h=this.liveNodes.get("__ksVoices__");h[a]||(h[a]={});let _=`${n}_${performance.now().toFixed(1)}_${Math.random().toString(36).slice(2,5)}`;h[a][_]={note:n,bfs:i,env:p,params:k,sustained:!1},i.addEventListener("ended",()=>{try{this.midiSynth?.bfSet?.[a]?.[n]===i&&(this.midiSynth.bfSet[a][n]=null)}catch{}try{let o=this.liveNodes.get("__ksVoices__");o&&o[a]&&o[a][_]&&delete o[a][_]}catch{}});try{this.midiSynth.bfSet||(this.midiSynth.bfSet={}),this.midiSynth.bfSet[a]||(this.midiSynth.bfSet[a]={}),this.midiSynth.bfSet[a][n]=i}catch{}try{let o=r.replace(":ksOut",":tail"),f=this.liveNodes.get(o)||this.liveNodes.get("__chainTail__"),q=this.midiSynth?.chvol?.[a];try{let G=this.mixers?.[a];if(f&&G)if(f.context===this.actx&&G.context===this.actx)f.connect(G);else{console.warn("[RC] context mismatch detected, re-adopting synth context"),this.setMidiSynth(this.midiSynth);try{let X=this.mixers?.[a];f.context===this.actx&&X?.context===this.actx&&f.connect(X)}catch{}}}catch(G){console.warn("[RC] mixer connect failed",G)}}catch{}i.connect(p);for(let o of e)try{p.connect(o)}catch(f){console.warn("[RC] env.connect ksOut failed",f)}return i.start(),!0}gateOsc(a,n,t){let s=Array.from(this.liveNodes.entries()).filter(([A])=>A.endsWith(":osc"));if(!s.length)return!1;let c=!1,l=(n??69)|0,e=this.actx.currentTime,r=(this.midiSynth&&typeof this.midiSynth.a4_freq=="number"?this.midiSynth.a4_freq:440)*Math.pow(2,(l-69)/12);for(let[A,k]of s){let D=A.replace(":osc",""),S=this.liveNodes.get(D+":ch")??"all";if(!(S==="all"||Number(S)===a))continue;let m=this.liveNodes.get(D+":env"),T=this.liveNodes.get(D+":adsr")||{a:.003,d:.08,s:.4,r:.2};if(!m)continue;try{k.frequency.setValueAtTime(r,e)}catch{}let{a:R,d:F,s:z,r:$}=T;m.gain.cancelScheduledValues(e),m.gain.setValueAtTime(0,e),m.gain.linearRampToValueAtTime(t,e+(R??.003)),m.gain.linearRampToValueAtTime((z??.4)*t,e+(R??.003)+(F??.08)),m.gain.linearRampToValueAtTime(0,e+(R??.003)+(F??.08)+($??.2)),c=!0}return c}releaseSustainKSForChannel(a){let n=this.actx.currentTime,t=this.liveNodes.get("__ksVoices__");if(!(!t||!t[a]))for(let[s,c]of Object.entries(t[a])){if(!c.sustained)continue;let{bfs:l,env:e,params:d}=c,r=Number(d?.ksRelease??.5),A=.02,D=A+(1.5-A)*Math.pow(r,2);e.gain.cancelScheduledValues(n),e.gain.setValueAtTime(e.gain.value??1,n),e.gain.linearRampToValueAtTime(0,n+D),l.stop(n+D+.05),c.sustained=!1,setTimeout(()=>{try{l.disconnect(),e.disconnect()}catch{}delete t[a][s]},(D+.05)*1e3)}}};import{Fragment as ve,jsx as O,jsxs as j}from"react/jsx-runtime";var W="px-3 py-1 rounded-xl border border-white/10 shadow hover:bg-white/5 active:scale-[.98] transition";var ge=["ks_source","source","filter","delay","reverb","convolver_ir","gain","analyzer"],ee={ks_source:{smoothingMode:"auto",smoothingFactor:.2,velScale:1,seedNoiseType:"pink",useSynthA4:!0,ch:"all",program:"all"},source:{type:"sawtooth",ch:"all",adsr:{a:.003,d:.08,s:.4,r:.2}},filter:{mode:"lowpass",freq:1200,q:.7},delay:{time:.25,feedback:.35,mix:.3},reverb:{decay:2,mix:.25},convolver_ir:{irId:"IR_Gibson",mix:.3},gain:{gain:.8},analyzer:{}};function U(N="m"){return`${N}_${Math.random().toString(36).slice(2,9)}`}function be(N,a,n){let t=N.slice(),s=Math.max(0,Math.min(t.length-1,a)),c=t.splice(s,1)[0],l=Math.max(0,Math.min(t.length,n));return t.splice(l,0,c),t}function ce({synth:N}){let a=De(null);a.current||(a.current=new ne);let n=a.current;se(()=>{if(N&&typeof n.setMidiSynth=="function")try{n.setMidiSynth(N),console.log("[RC] midi_synth attached to engine")}catch(i){console.warn("[RC] setMidiSynth failed",i)}},[N]),se(()=>(window.__RC_HANDLE__={midi:i=>{try{n.handleMIDIMsg&&n.handleMIDIMsg(i),console.log("[RC] MIDI -> engine",i)}catch(p){console.warn("[RC] MIDI ingress failed",p)}},engine:n},()=>{try{delete window.__RC_HANDLE__}catch{}}),[n]);let[t,s]=re([[{id:U("ks"),kind:"ks_source",enabled:!0,params:{...ee.ks_source}},{id:U("gain"),kind:"gain",enabled:!0,params:{...ee.gain}},{id:U("an"),kind:"analyzer",enabled:!0,params:{}}]]),[c,l]=re({open:!1,idx:null,step:1}),e=i=>l({open:!0,idx:i,step:1}),d=()=>l({open:!1,idx:null,step:1}),r=()=>l(i=>({...i,step:2})),A=()=>{s(i=>{let p=i.filter((h,_)=>_!==c.idx);return p.length?p:[[{id:U("src"),kind:"source",enabled:!0,params:{...ee.source}},{id:U("gain"),kind:"gain",enabled:!0,params:{...ee.gain}},{id:U("an"),kind:"analyzer",enabled:!0,params:{}}]]}),d()};se(()=>{try{n.buildMany(t),n.resume&&n.resume()}catch(i){console.warn("[RC] buildMany failed",i)}},[JSON.stringify(t)]),se(()=>{navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(i=>{for(let p of i.inputs.values())p.onmidimessage=h=>n.handleMIDIMsg(h.data)})},[]);let k=(i,p)=>s(h=>{let _=h.map(o=>[...o]);return _[i]=[..._[i],{id:U(p),kind:p,enabled:!0,params:{...ee[p]}}],_}),D=(i,p)=>s(h=>h.map((_,o)=>o!==i?_:_.map(f=>f.id===p?{...f,enabled:!f.enabled}:f))),S=(i,p)=>s(h=>h.map((_,o)=>o!==i?_:_.filter(f=>f.id!==p))),x=(i,p,h,_)=>{h==="gain"&&(n.updateGainNodeById(p,_)||console.warn("[RC] gain node not found for id:",p)),s(o=>o.map((f,q)=>q!==i?f:f.map(G=>G.id===p?{...G,params:{...G.params,[h]:_}}:G)))},[m,T]=re(null),R=(i,p)=>h=>{T({chain:i,from:p}),h.dataTransfer.effectAllowed="move",h.dataTransfer.setData("text/plain",`${i}:${p}`)},F=(i,p)=>h=>{h.preventDefault(),!(!m||m.chain!==i)&&(s(_=>_.map((o,f)=>f!==i?o:be(o,m.from,p))),T(null))},z=i=>p=>{p.preventDefault(),!(!m||m.chain!==i)&&(s(h=>h.map((_,o)=>o!==i?_:be(_,m.from,_.length))),T(null))},$=i=>s(p=>{let h=p.map(o=>[...o]),_=h[i].map(o=>({...o,id:U(o.kind)}));return h.splice(i+1,0,_),h}),I=()=>{let i=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),p=URL.createObjectURL(i),h=document.createElement("a");h.href=p,h.download="audio-chains.json",h.click(),URL.revokeObjectURL(p)},Y=async i=>{let p=await i.text();try{let h=JSON.parse(p);Array.isArray(h)&&Array.isArray(h[0])&&s(h)}catch(h){console.warn("Invalid chain JSON",h)}};return j("div",{className:"p-6 text-white",children:[O("div",{className:"flex items-center justify-between mb-4",children:j("div",{className:"flex items-center gap-2 flex-wrap",children:[ge.map(i=>j("button",{className:W,onClick:()=>k(0,i),children:["+ ",i]},`add-${i}`)),O("button",{className:W,onClick:()=>n.resume(),children:"Resume Audio"}),O("button",{className:W,onClick:I,children:"Export"}),j("label",{className:`${W} cursor-pointer`,children:["Import",O("input",{type:"file",accept:"application/json",className:"hidden",onChange:i=>{let p=i.target.files?.[0];p&&Y(p)}})]}),O("button",{className:W,onClick:()=>{typeof n.buildMultiFrom=="function"?n.buildMultiFrom(t[0],Array.from({length:16},(i,p)=>p)):s(i=>{let p=i[0]||[];return Array.from({length:16},(_,o)=>p.map(f=>({...f,id:U(f.kind)+`_ch${o}`,params:f.kind==="ks_source"?{...f.params,ch:String(o)}:{...f.params}})))})},children:"Duplicate to 16 channels"})]})}),O("div",{className:"relative border border-dashed border-white/20 rounded-2xl p-4 overflow-x-auto",children:t.map((i,p)=>j("div",{className:"mb-6",children:[j("div",{className:"flex items-center justify-between mb-2",children:[j("div",{className:"text-sm opacity-80",children:["Chain #",p+1]}),j("div",{className:"flex gap-2",children:[O("button",{className:W,onClick:()=>$(p),children:"Duplicate chain"}),O("button",{className:W,onClick:()=>e(p),children:"Delete chain"})]})]}),j("div",{className:"flex gap-3 items-stretch",children:[i.map((h,_)=>O("div",{draggable:!0,onDragStart:R(p,_),onDrop:F(p,_),onDragOver:o=>o.preventDefault(),className:"hover:border-white/20 transition border border-transparent rounded-2xl",title:"Drag to reorder",children:O(oe,{mod:h,onToggle:()=>D(p,h.id),onRemove:()=>S(p,h.id),onParam:(o,f)=>x(p,h.id,o,f)})},h.id)),O("div",{className:"w-12 rounded-xl border-2 border-dashed border-white/10 hover:border-white/20 flex items-center justify-center opacity-60",onDragOver:h=>h.preventDefault(),onDrop:z(p),children:"\u2192"})]}),O("div",{className:"mt-3 flex flex-wrap gap-2",children:ge.map(h=>j("button",{className:W,onClick:()=>k(p,h),children:["+ ",h]},`${p}-${h}`))})]},p))}),c.open&&O("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:O("div",{className:"bg-neutral-900 border border-white/10 rounded-2xl p-5 w-[420px] shadow-xl",children:c.step===1?j(ve,{children:[O("div",{className:"text-lg font-semibold mb-2",children:"Delete this chain?"}),O("p",{className:"text-sm opacity-80 mb-4",children:"Confirm to continue."}),j("div",{className:"flex justify-end gap-2",children:[O("button",{className:W,onClick:d,children:"Cancel"}),O("button",{className:W,onClick:r,children:"Next"})]})]}):j(ve,{children:[O("div",{className:"text-lg font-semibold mb-2",children:"Are you sure?"}),O("p",{className:"text-sm opacity-80 mb-4",children:"This cannot be undone."}),j("div",{className:"flex justify-end gap-2",children:[O("button",{className:W,onClick:d,children:"Cancel"}),O("button",{className:W,onClick:A,children:"Delete"})]})]})})})]})}import{jsx as E,jsxs as J}from"react/jsx-runtime";function te({synth:N,buttonTarget:a,autoTailwind:n=!1}){let[t,s]=le(!1);ie(()=>{if(!t)return;(async()=>{try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch(x){console.warn("[RC] resumeAll failed",x)}})()},[t]);let[c,l]=le(.3),[e,d]=le(()=>N?.a4_freq??440);ie(()=>{typeof N?.a4_freq=="number"&&d(Number(N.a4_freq))},[N]),ie(()=>{let S=e,x=setInterval(()=>{let m=Number(N?.a4_freq??440);!Number.isNaN(m)&&m!==S&&(S=m,d(m))},250);return()=>clearInterval(x)},[N,e]);let r=420,k=Math.max(0,Math.min(1,(e-r)/(460-r)))*100;ie(()=>{if(!n||!!document.querySelector("script[data-rc-tailwind]")||!!document.querySelector('script[src*="tailwindcss"]'))return;let x=document.createElement("script");x.src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4",x.dataset.rcTailwind="1",document.head.appendChild(x)},[n]);let D=()=>E("button",{className:"rc-toggle-btn",onClick:async()=>{requestAnimationFrame(()=>s(!0));try{await __RC_HANDLE__?.engine?.resume?.(),window.synth?.actx?.state==="suspended"&&await window.synth.actx.resume()}catch{}},title:"Open Routing Composer",children:"Routing Composer"});return J("div",{children:[E("style",{children:`
        :root { --rc-bg1:#0f1022; --rc-bg2:#2a2b55; --rc-card:rgba(22,22,34,.92); --rc-border:rgba(255,255,255,.1); --rc-text:#f5f7ff; }
        .rc-toggle-btn { padding:10px 14px; border-radius:999px; border:1px solid var(--rc-border); background:rgba(255,255,255,.08); color:var(--rc-text); /*backdrop-filter:blur(8px);*/ box-shadow:0 6px 24px rgba(0,0,0,.35); cursor:pointer; z-index:9999; }
        .rc-toggle-btn:hover { background:rgba(255,255,255,.12); }
        .rc-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); /*backdrop-filter:blur(2px);*/ display:flex; align-items:center; justify-content:center; z-index:9998; }
        .rc-panel { width:min(1120px,96vw); height:min(88vh,900px); background:var(--rc-card); border:1px solid var(--rc-border); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--rc-text); display:flex; flex-direction:column; overflow:hidden; }
        .rc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--rc-border); font-weight:700; letter-spacing:.2px; }
        .rc-close { padding:8px 12px; border-radius:10px; border:1px solid var(--rc-border); background:rgba(255,255,255,.06); color:var(--rc-text); cursor:pointer; }
        .rc-close:hover { background:rgba(255,255,255,.1); }
        .rc-body { flex:1; overflow:auto; padding:8px 10px; }
        .rc-fixed-default { position:fixed; top:12px; left:12px; }
        /* === Gradient progress slider (cross-browser) === */
        .rc-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            /* \u5169\u5C64\u80CC\u666F\uFF1A\u524D\u666F=\u6F38\u5C64(\u53EA\u756B\u5230 --rc-pos)\uFF0C\u5E95\u5C64=\u672A\u586B\u7070 */
            background:
                linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%) 0% 0% / var(--rc-pos, 0%) 100% no-repeat,
                rgba(255,255,255,0.12);
            outline: none;
            transition: filter .2s ease;
        }
        .rc-slider:active { filter: brightness(1.1); }

        /* Chrome / Edge \u8ECC\u9053 */
        .rc-slider::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent; /* \u8B93\u4E0A\u9762 .rc-slider \u7684\u591A\u91CD\u80CC\u666F\u751F\u6548 */
            border-radius: 5px;
        }

        /* Chrome / Edge \u62C7\u6307 */
        .rc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px; /* \u8B93\u62C7\u6307\u5782\u76F4\u7F6E\u4E2D\u8ECC\u9053\uFF08\u4F9D\u700F\u89BD\u5668\u53EF\u5FAE\u8ABF\uFF09 */
        }

        /* Firefox \u8ECC\u9053\uFF08\u672A\u586B\uFF09 */
        .rc-slider::-moz-range-track {
            height: 6px;
            background: rgba(255,255,255,0.12);
            border: none;
            border-radius: 5px;
        }

        /* Firefox \u5DF2\u586B\u90E8\u5206\uFF08\u756B\u6F38\u5C64\uFF09 */
        .rc-slider::-moz-range-progress {
            height: 6px;
            background: linear-gradient(15deg,
                hsla(275, 70%, 35%, 1) 20%,
                hsla(280, 70%, 60%, 1) 50%,
                hsla(285, 70%, 80%, 1) 80%);
            border-radius: 5px 0 0 5px;
        }

        /* Firefox \u62C7\u6307 */
        .rc-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 10%, hsla(285, 80%, 75%, 1) 60%);
            box-shadow: 0 0 4px rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .rc-overlay::before {
          content: "";
          position: absolute;
          inset: 0;
          background: linear-gradient(135deg,#0b0d1f99,#272b5277);
          opacity: .9;
          pointer-events: none;
        }
        input[type=range] { accent-color: #3b82f6; }
      `}),a?Ve.createPortal(E(D,{}),a):E("div",{className:"rc-fixed-default",children:E(D,{})}),E("div",{className:"rc-overlay",style:{display:t?"flex":"none"},onClick:S=>{S.target===S.currentTarget&&s(!1)},children:J("div",{className:"rc-panel",role:"dialog","aria-modal":"true",children:[J("div",{className:"rc-header",children:[J("div",{className:"flex items-center gap-4",children:[E("div",{children:"Routing Composer"}),J("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[E("span",{children:"A4"}),E("input",{type:"range",min:"420",max:"460",step:"0.1",value:e,className:"rc-slider",style:{"--rc-pos":`${(e-420)/40*100}%`,width:160},onChange:S=>{let x=Number(S.target.value);Number.isNaN(x)||(d(x),N&&(N.a4_freq=x))}}),J("span",{children:[e.toFixed(1),"Hz"]})]}),J("div",{className:"flex items-center gap-2 text-sm opacity-90",children:[E("span",{children:"Vol"}),E("input",{type:"range",min:"0",max:"1",step:"0.01",value:c,className:"rc-slider",style:{"--rc-pos":`${c*100}%`,width:160},onChange:S=>{let x=Number(S.target.value);Number.isNaN(x)||(l(x),midi_synth&&midi_synth.setMasterVol(x))}}),J("span",{children:[(c*100).toFixed(0),"%"]})]})]}),J("div",{className:"flex items-center gap-2",children:[E("button",{className:"rc-close",onClick:()=>N?.actx?.resume?.(),children:"Resume Audio"}),E("button",{className:"rc-close",onClick:()=>s(!1),children:"Close"})]})]}),E("div",{className:"rc-body",children:E(ce,{synth:N})})]})})]})}import{jsx as xe}from"react/jsx-runtime";var at=te;(function(){if(typeof window>"u")return;let a={mount(n={}){let{synth:t,button:s,tailwind:c="auto"}=n,l=null;s&&(typeof s=="string"?l=document.querySelector(s):s instanceof HTMLElement&&(l=s));let e=document.createElement("div");return document.body.appendChild(e),de.createRoot?de.createRoot(e).render(xe(te,{synth:t,buttonTarget:l,autoTailwind:c==="auto"})):de.render(xe(te,{synth:t,buttonTarget:l,autoTailwind:c==="auto"}),e),console.log("[RoutingComposer] mounted GUI"),{host:e}}};window.RoutingComposer=a})();export{at as default};
