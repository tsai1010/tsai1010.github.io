<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MIDI Synthesizer Test</title>
    <link rel="icon" href="images/musicsynth_icon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles/style.css" />


    <!-- React + ReactDOM + Babel Standaloneï¼ˆç”¨æ–¼ä¸€æ¬¡æ€§çš„ç€è¦½å™¨ç«¯è½‰è­¯ï¼‰ -->
    <!-- <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> -->

    <!-- Tailwindï¼ˆå¯é¸ï¼Œä½†å…ƒä»¶æ¨£å¼ç”¨äº† Tailwind é¡åï¼‰ -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> -->
    
  </head>
  <body>
    <h1>
      <strong><em>MIDI Synthesizer</em></strong>
    </h1>
    <img src="images/image1.png" width="3%" height="5%" id="img" onmousedown="menuShow();"/>
    <div class="menu" id="menu">
      Menu
      <hr style="margin: 0; border-color: #820041;"/>
      <div class="menuBar" id="m1" onmouseover="menuBarOver(this);" onmouseout="menuBarOut(this);">
        <span style="position: absolute; left: 10%; width: 10%; color: black;">MIDI&nbsp;port:</span>
        <select id="midiInputPort" onchange="midiPortSet(this);">
          <option value="all">All&nbsp;inputs</option>
        </select>
      </div>
      <div class="menuBar" id="m1" onmouseover="menuBarOver(this);" onmouseout="menuBarOut(this);">
        <span style="position: absolute; left: 10%; width: 10%; color: black;">Audio:</span>
        <input class="menuSet" id="audioValue" type="range" min="0" max="1" step="0.01" value="0.3"/>
        <img src="images/AudioOff.png" width="7%" height="100%" id="AudioImg" onmousedown="AudioBtn();"/>
      </div>
      <div class="menuBar" id="m1" onmouseover="menuBarOver(this);" onmouseout="menuBarOut(this);">
        <span style="position: absolute; left: 10%; width: 10%; color: black;">Tune:</span>
        <input class="menuSet" id="tuneValue" type="range" min="420" max="460" step="1" value="440"/>
        <span style="position: absolute; right: 17.5%; width: 7%; height: 100%; color: black;" id="tuneFreq">440Hz</span>
      </div>
      <div class="menuBar" id="m1" onmouseover="menuBarOver(this);" onmouseout="menuBarOut(this);">
        
      </div>
      

      

    </div>


    <div id="panel-ui"></div>
    <div id="player-slot"></div>


    <!-- Puzzle Chain GUI mount point -->
    <div id="composer-slot" style="position: fixed; top: 12px; left: 12px; z-index: 9999;"></div>

    <div id="piano">
      <div id="KeyboardB"></div>
      <div id="KeyboardW"></div>
    </div>
    <div id="floor"></div>
    <!-- <script type="module">
      import MidiSynth from 'https://tsai1010.github.io/scripts/midisynth.js';
    </script> -->

    <!-- <script src="scripts/midisynth.js" type="module"></script> -->

    <script type="module">
      import MidiSynth from "./scripts/midisynth-gui.js";
    </script>

    <script src="scripts/data.js"></script>
    <script src="scripts/main.js"></script>
    <script src="scripts/midi.js"></script>

    <script src="scripts/midiplayerUI.js"></script>
    <script src="scripts/player-ui.js"></script>
    <script src="scripts/midi-cc-panel.js"></script>

    <script>
      const panelUI = createMidiCcPanel('#panel-ui');
      panelUI.setOffset(150, 16);
    </script>

   <script>
      // --- éš±è—æ›è¼‰ midiplayerUIï¼Œæ‹¿åˆ°å®ƒçš„ player ---
      const hidden = document.createElement('div');
      hidden.style.display = 'none';
      document.body.appendChild(hidden);
      const mfp = MidiFilePlayerUI.mount(hidden); // å›å‚³ { player, elements }

      // è¿½è¹¤ç›®å‰ä½ç½®ï¼ˆmidiplayerUI æ²’æœ‰ getPositionï¼Œæˆ‘å€‘ç”¨ onTime å›å¡«ï¼‰
      let lastPosMs = 0;
      let endedCb = null;
      mfp.player.onTime((curMs, durMs) => {
        lastPosMs = curMs;
        // è‡ªè¡Œåˆ¤æ–·ã€Œè‡ªç„¶æ’­ç•¢ã€ä»¥é€šçŸ¥ PlayerUIï¼ˆéå¾ªç’°ï¼‰
        if (!mfp.player.isLoop() && durMs > 0 && curMs >= durMs - 1) {
          if (endedCb) { endedCb(); endedCb = null; }
        }
      });

      // --- æŠŠ midiplayerUI çš„ player åŒ…æˆ PlayerUI éœ€è¦çš„ adapter ---
      const adapter = {
        play:  () => mfp.player.play(),
        pause: () => mfp.player.pause(),
        stop:  () => mfp.player.stop(),
        seek:  (seconds) => mfp.player.seek(seconds * 1000),         // PlayerUI ç”¨ç§’ï¼ŒmidiplayerUI ç”¨æ¯«ç§’
        getDuration: () => mfp.player.getDuration() / 1000,          // è½‰æˆç§’
        getPosition: () => lastPosMs / 1000,                         // ç”¨ onTime è¿½è¹¤çš„ä½ç½®
        setLoop: (on) => mfp.player.setLoop(on),
        onEnded: (cb) => { endedCb = cb; }                           // è®“ PlayerUI èƒ½æ”¶åˆ° ended
      };

      // --- æ›è¼‰æ¨£å¼6 UIï¼Œä¸¦å°‡è¼‰æª”æµç¨‹æŒ‡åˆ° midiplayerUI çš„ SMF è§£æ ---
      PlayerUI.mount('#player-slot', {
        adapter,
        keyboardSelector: '.keyboard', // Reset é–ƒçˆçš„å®¹å™¨ï¼ˆå¯æ›æˆä½ çš„ï¼‰
        async loadFile(file) {
          const buf = await file.arrayBuffer();
          const parsed = MidiFilePlayerUI.parseSMF(buf);
          mfp.player.load(parsed);
        },
        // è®“æª”åå‰å¾Œå„è£œ 8 å€‹ä¸æ–·è¡Œç©ºç™½ï¼ˆæ’­æ”¾æ™‚æ‰è£œï¼Œæš«åœ/åœæ­¢è‡ªå‹•é‚„åŸï¼‰
        titlePadSpaces: 8,
        // å³å¤–/å·¦å¤–å¤šè·‘çš„è·é›¢ï¼ˆå–®ä½ pxï¼‰
        marqueeMarginPx: 20,
        // ä¸­å¤®æ…¢å€åŸŸçš„å¯¬åº¦ï¼ˆå–®ä½ pxï¼‰
        marqueeSlowZonePx: 120
      });


      

    </script>

    <style>
      #player-slot .pui-wrap{
        --pui-max: clamp(320px, 90vw, 640px);
        width: var(--pui-max);
        margin: 40px auto;
        display: grid;
        justify-items: center;
      }
      #player-slot .pui-player{ width: 100%; }
      #player-slot .pui-titleRow,
      #player-slot .pui-time,
      #player-slot .pui-seek{ width: 100%; margin-inline: auto; }
    </style>
    

    
    

    <!-- <script type="module">
      const jsxUrl = './scripts/puzzle_style_audio_routing_gui_react_web_audio.jsx';
      const src = await fetch(jsxUrl).then(r => r.text());

      // âœ… Babel è¨­å®šï¼šæ›¿æ› "react" / "react-dom" ç‚º ESM CDN
      const { code } = Babel.transform(src, {
        presets: ['react', 'typescript'],
        sourceType: 'module',
        filename: 'audio-patchbay.tsx',
        plugins: [
          function esmRedirect() {
            return {
              visitor: {
                ImportDeclaration(path) {
                  const v = path.node.source.value;
                  if (v === 'react') path.node.source.value = 'https://esm.sh/react@18';
                  if (v === 'react-dom') path.node.source.value = 'https://esm.sh/react-dom@18';
                }
              }
            };
          }
        ]
      });

      const blobUrl = URL.createObjectURL(new Blob([code], { type: 'text/javascript' }));
      const { default: AudioPatchbay } = await import(blobUrl);

      const rootEl = document.getElementById('audio-patchbay-root');
      import('https://esm.sh/react-dom@18').then(ReactDOMModule => {
        const ReactDOM = ReactDOMModule.default;
        import('https://esm.sh/react@18').then(ReactModule => {
          const React = ReactModule.default;
          ReactDOM.createRoot(rootEl).render(
            React.createElement(AudioPatchbay, { midiSynth: window.midi_synth })
          );
        });
      });
    </script> -->


    <!-- <script>
      window.AudioContext = window.AudioContext || window.webkitAudioContext;

      // åªå®šç¾©ï¼šçœŸæ­£å»ºç«‹æœƒåœ¨ä½ ã€Œå‘¼å«ã€å®ƒçš„é»æ“Š/è§¸æ§äº‹ä»¶è£¡
      window.initAudio = window.initAudio || (async function initAudioOnce() {
        if (!window.ctx) {
          window.ctx = new AudioContext();                   // â† çœŸæ­£å»ºç«‹åœ¨æ‰‹å‹¢å›å‘¼è£¡
          console.log('[init] new AudioContext created');
        }
        if (window.ctx.state === 'suspended') {
          await window.ctx.resume();
          console.log('[init] ctx resumed');
        }

        // ä¿æ´»ï¼ˆéé›¶ï¼Œé¿å… iOS ç«‹åˆ»åˆ‡æ‰ï¼‰
        if (!window._keepAlive) {
          try {
            const g = window.ctx.createGain(); g.gain.value = 1e-6;   // -120 dB
            const s = window.ctx.createConstantSource(); s.offset.value = 1;
            s.connect(g).connect(window.ctx.destination);
            s.start();
            window._keepAlive = s;
            console.log('[init] keep-alive started');
          } catch {
            const o = window.ctx.createOscillator(); o.frequency.value = 1;
            const g = window.ctx.createGain(); g.gain.value = 1e-6;
            o.connect(g).connect(window.ctx.destination); o.start();
            window._keepAlive = o;
            console.log('[init] keep-alive (osc fallback) started');
          }
        }

        // åªåˆå§‹åŒ–ä¸€æ¬¡ MidiSynthï¼Œä¸¦ç”¨åŒä¸€å€‹ ctx
        if (window.MidiSynth && !window.midi_synth) {
          window.midi_synth = new window.MidiSynth();
          window.midi_synth.setAudioContext(window.ctx, window.ctx.destination);
          console.log('[init] MidiSynth initialized');
        }
      });
    </script> -->

    <!-- åŠ åˆ° <body> åº•éƒ¨æˆ–ä½ çš„ JS æª”æœ«ç«¯ -->
    <!-- <script>
      /* ======= æ¼‚æµ®é™¤éŒ¯é¢æ¿ï¼ˆå¹³æ¿å¯è¦‹ï¼‰ ======= */
      (function () {
        const panel = document.createElement('div');
        panel.style.cssText = `
          position:fixed; z-index:99999; right:8px; bottom:8px;
          width: min(90vw, 420px); max-height: 45vh; background: rgba(0,0,0,.8);
          color:#0f0; font:12px/1.4 Consolas,Monaco,monospace; border-radius:10px;
          box-shadow:0 6px 20px rgba(0,0,0,.4); overflow:hidden;
        `;
        panel.innerHTML = `
          <div style="display:flex;align-items:center;gap:6px;padding:6px;background:#111;border-bottom:1px solid #222">
            <strong style="color:#9cf">DEBUG</strong>
            <span id="ctxState" style="margin-left:auto;color:#ff0">ctx: n/a</span>
            <button id="dbgClear" style="background:#333;color:#9cf;border:1px solid #555;border-radius:6px;padding:4px 8px">æ¸…ç©º</button>
          </div>
          <div style="padding:6px;display:flex;gap:6px;background:#111;border-bottom:1px solid #222">
            <button id="dbgInit"  style="background:#245;border:1px solid #57a;color:#fff;border-radius:6px;padding:4px 8px">ğŸ”Š å•Ÿå‹•éŸ³è¨Š</button>
            <button id="dbgBeep"  style="background:#254;border:1px solid #5a7;color:#fff;border-radius:6px;padding:4px 8px">ğŸ“£ æ¸¬è©¦å—¶è²</button>
          </div>
          <pre id="dbgLog" style="margin:0;padding:8px;overflow:auto;white-space:pre-wrap;"></pre>
        `;
        document.body.appendChild(panel);

        const pre = panel.querySelector('#dbgLog');
        const stateEl = panel.querySelector('#ctxState');
        const logLine = (...args) => {
          const s = args.map(a => {
            try { return typeof a === 'object' ? JSON.stringify(a) : String(a); }
            catch { return String(a); }
          }).join(' ');
          pre.textContent += s + '\n';
          pre.scrollTop = pre.scrollHeight;
        };

        // æ””æˆª console.* åˆ°é¢æ¿
        const _log = console.log.bind(console);
        const _warn = console.warn.bind(console);
        const _err = console.error.bind(console);
        console.log = (...a) => { _log(...a); logLine('[log]', ...a); };
        console.warn = (...a) => { _warn(...a); logLine('[warn]', ...a); };
        console.error = (...a) => { _err(...a); logLine('[err]', ...a); };

        // æ¯ç§’é¡¯ç¤º AudioContext ç‹€æ…‹ï¼ˆä¸€å¾‹è®€ window.ctxï¼‰
        setInterval(() => {
          try {
            const c = window.ctx;
            if (c) {
              stateEl.textContent = `ctx: ${c.state} @ ${c.currentTime.toFixed(2)}s`;
            } else {
              stateEl.textContent = 'ctx: <none>';
            }
          } catch { stateEl.textContent = 'ctx: <none>'; }
        }, 1000);

        // å•Ÿå‹•éŸ³è¨Šï¼ˆæ‰‹å‹¢å…§åŸ·è¡Œï¼‰
        panel.querySelector('#dbgInit').addEventListener('click', async () => {
          try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!window.ctx) {
              window.ctx = new AudioContext();
              console.log('[dbg] new AudioContext created');
            }
            if (window.ctx.state === 'suspended') {
              await window.ctx.resume();
              console.log('[dbg] ctx resumed');
            }
            // ğŸ”’ ä¿æ´»
            if (!window._keepAlive) {
              const g = window.ctx.createGain();
              g.gain.value = 1e-6;
              const s = window.ctx.createConstantSource();
              s.offset.value = 1;
              s.connect(g).connect(window.ctx.destination);
              s.start();
              window._keepAlive = s;
              console.log('[dbg] keep-alive source started');
            }
            // ğŸ”” å³æ™‚æ›´æ–° UI
            stateEl.textContent = `ctx: ${window.ctx.state} @ ${window.ctx.currentTime.toFixed(2)}s`;
            // è‹¥æœ‰ MidiSynth
            if (window.MidiSynth && !window.midi_synth) {
              window.midi_synth = new window.MidiSynth();
              window.midi_synth.setAudioContext(window.ctx, window.ctx.destination);
              console.log('[dbg] MidiSynth initialized');
            }
          } catch (e) {
            console.error('[dbg] init error', e);
          }
        });

        // æ¸¬è©¦å—¶è²
        panel.querySelector('#dbgBeep').addEventListener('click', () => {
          try {
            if (!window.ctx) { console.warn('[dbg] no ctx'); return; }
            const c = window.ctx;
            const o = c.createOscillator();
            const g = c.createGain();
            o.type = 'sine';
            o.frequency.value = 440;
            g.gain.value = 0.08;
            o.connect(g).connect(c.destination);
            const t = c.currentTime;
            o.start(t);
            g.gain.exponentialRampToValueAtTime(0.000001, t + 0.5);
            o.stop(t + 0.6);
            console.log('[dbg] beep 440Hz 0.6s');
          } catch (e) { console.error(e); }
        });

        panel.querySelector('#dbgClear').addEventListener('click', () => pre.textContent = '');
      })();
    </script> -->



  </body>
</html>